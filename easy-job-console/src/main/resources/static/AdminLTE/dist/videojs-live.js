(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.videojsContribHls=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var textRange=function textRange(range,i){return range.start(i)+"-"+range.end(i)};var formatHexString=function formatHexString(e,i){var value=e.toString(16);return"00".substring(0,2-value.length)+value+(i%2?" ":"")};var formatAsciiString=function formatAsciiString(e){if(e>=32&&e<126){return String.fromCharCode(e)}return"."};var utils={hexDump:function hexDump(data){var bytes=Array.prototype.slice.call(data);var step=16;var result="";var hex=undefined;var ascii=undefined;for(var j=0;j<bytes.length/step;j++){hex=bytes.slice(j*step,j*step+step).map(formatHexString).join("");ascii=bytes.slice(j*step,j*step+step).map(formatAsciiString).join("");result+=hex+" "+ascii+"\n"}return result},tagDump:function tagDump(tag){return utils.hexDump(tag.bytes)},textRanges:function textRanges(ranges){var result="";var i=undefined;for(i=0;i<ranges.length;i++){result+=textRange(ranges,i)+" "}return result}};exports["default"]=utils;module.exports=exports["default"]},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var precompute=function precompute(){var tables=[[[],[],[],[],[]],[[],[],[],[],[]]];var encTable=tables[0];var decTable=tables[1];var sbox=encTable[4];var sboxInv=decTable[4];var i=undefined;var x=undefined;var xInv=undefined;var d=[];var th=[];var x2=undefined;var x4=undefined;var x8=undefined;var s=undefined;var tEnc=undefined;var tDec=undefined;for(i=0;i<256;i++){th[(d[i]=i<<1^(i>>7)*283)^i]=i}for(x=xInv=0;!sbox[x];x^=x2||1,xInv=th[xInv]||1){s=xInv^xInv<<1^xInv<<2^xInv<<3^xInv<<4;s=s>>8^s&255^99;sbox[x]=s;sboxInv[s]=x;x8=d[x4=d[x2=d[x]]];tDec=x8*16843009^x4*65537^x2*257^x*16843008;tEnc=d[s]*257^s*16843008;for(i=0;i<4;i++){encTable[i][x]=tEnc=tEnc<<24^tEnc>>>8;decTable[i][s]=tDec=tDec<<24^tDec>>>8}}for(i=0;i<5;i++){encTable[i]=encTable[i].slice(0);decTable[i]=decTable[i].slice(0)}return tables};var aesTables=null;var AES=function(){function AES(key){_classCallCheck(this,AES);if(!aesTables){aesTables=precompute()}this._tables=[[aesTables[0][0].slice(),aesTables[0][1].slice(),aesTables[0][2].slice(),aesTables[0][3].slice(),aesTables[0][4].slice()],[aesTables[1][0].slice(),aesTables[1][1].slice(),aesTables[1][2].slice(),aesTables[1][3].slice(),aesTables[1][4].slice()]];var i=undefined;var j=undefined;var tmp=undefined;var encKey=undefined;var decKey=undefined;var sbox=this._tables[0][4];var decTable=this._tables[1];var keyLen=key.length;var rcon=1;if(keyLen!==4&&keyLen!==6&&keyLen!==8){throw new Error("Invalid aes key size")}encKey=key.slice(0);decKey=[];this._key=[encKey,decKey];for(i=keyLen;i<4*keyLen+28;i++){tmp=encKey[i-1];if(i%keyLen===0||keyLen===8&&i%keyLen===4){tmp=sbox[tmp>>>24]<<24^sbox[tmp>>16&255]<<16^sbox[tmp>>8&255]<<8^sbox[tmp&255];if(i%keyLen===0){tmp=tmp<<8^tmp>>>24^rcon<<24;rcon=rcon<<1^(rcon>>7)*283}}encKey[i]=encKey[i-keyLen]^tmp}for(j=0;i;j++,i--){tmp=encKey[j&3?i:i-4];if(i<=4||j<4){decKey[j]=tmp}else{decKey[j]=decTable[0][sbox[tmp>>>24]]^decTable[1][sbox[tmp>>16&255]]^decTable[2][sbox[tmp>>8&255]]^decTable[3][sbox[tmp&255]]}}}_createClass(AES,[{key:"decrypt",value:function decrypt(encrypted0,encrypted1,encrypted2,encrypted3,out,offset){var key=this._key[1];var a=encrypted0^key[0];var b=encrypted3^key[1];var c=encrypted2^key[2];var d=encrypted1^key[3];var a2=undefined;var b2=undefined;var c2=undefined;var nInnerRounds=key.length/4-2;var i=undefined;var kIndex=4;var table=this._tables[1];var table0=table[0];var table1=table[1];var table2=table[2];var table3=table[3];var sbox=table[4];for(i=0;i<nInnerRounds;i++){a2=table0[a>>>24]^table1[b>>16&255]^table2[c>>8&255]^table3[d&255]^key[kIndex];b2=table0[b>>>24]^table1[c>>16&255]^table2[d>>8&255]^table3[a&255]^key[kIndex+1];c2=table0[c>>>24]^table1[d>>16&255]^table2[a>>8&255]^table3[b&255]^key[kIndex+2];d=table0[d>>>24]^table1[a>>16&255]^table2[b>>8&255]^table3[c&255]^key[kIndex+3];kIndex+=4;a=a2;b=b2;c=c2}for(i=0;i<4;i++){out[(3&-i)+offset]=sbox[a>>>24]<<24^sbox[b>>16&255]<<16^sbox[c>>8&255]<<8^sbox[d&255]^key[kIndex++];a2=a;a=b;b=c;c=d;d=a2}}}]);return AES}();exports["default"]=AES;module.exports=exports["default"]},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _stream=require("../stream");var _stream2=_interopRequireDefault(_stream);var AsyncStream=function(_Stream){_inherits(AsyncStream,_Stream);function AsyncStream(){_classCallCheck(this,AsyncStream);_get(Object.getPrototypeOf(AsyncStream.prototype),"constructor",this).call(this,_stream2["default"]);this.jobs=[];this.delay=1;this.timeout_=null}_createClass(AsyncStream,[{key:"processJob_",value:function processJob_(){this.jobs.shift()();if(this.jobs.length){this.timeout_=setTimeout(this.processJob_.bind(this),this.delay)}else{this.timeout_=null}}},{key:"push",value:function push(job){this.jobs.push(job);if(!this.timeout_){this.timeout_=setTimeout(this.processJob_.bind(this),this.delay)}}}]);return AsyncStream}(_stream2["default"]);exports["default"]=AsyncStream;module.exports=exports["default"]},{"../stream":18}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _aes=require("./aes");var _aes2=_interopRequireDefault(_aes);var _asyncStream=require("./async-stream");var _asyncStream2=_interopRequireDefault(_asyncStream);var _pkcs7=require("pkcs7");var ntoh=function ntoh(word){return word<<24|(word&65280)<<8|(word&16711680)>>8|word>>>24};var decrypt=function decrypt(encrypted,key,initVector){var encrypted32=new Int32Array(encrypted.buffer,encrypted.byteOffset,encrypted.byteLength>>2);var decipher=new _aes2["default"](Array.prototype.slice.call(key));var decrypted=new Uint8Array(encrypted.byteLength);var decrypted32=new Int32Array(decrypted.buffer);var init0=undefined;var init1=undefined;var init2=undefined;var init3=undefined;var encrypted0=undefined;var encrypted1=undefined;var encrypted2=undefined;var encrypted3=undefined;var wordIx=undefined;init0=initVector[0];init1=initVector[1];init2=initVector[2];init3=initVector[3];for(wordIx=0;wordIx<encrypted32.length;wordIx+=4){encrypted0=ntoh(encrypted32[wordIx]);encrypted1=ntoh(encrypted32[wordIx+1]);encrypted2=ntoh(encrypted32[wordIx+2]);encrypted3=ntoh(encrypted32[wordIx+3]);decipher.decrypt(encrypted0,encrypted1,encrypted2,encrypted3,decrypted32,wordIx);decrypted32[wordIx]=ntoh(decrypted32[wordIx]^init0);decrypted32[wordIx+1]=ntoh(decrypted32[wordIx+1]^init1);decrypted32[wordIx+2]=ntoh(decrypted32[wordIx+2]^init2);decrypted32[wordIx+3]=ntoh(decrypted32[wordIx+3]^init3);init0=encrypted0;init1=encrypted1;init2=encrypted2;init3=encrypted3}return decrypted};exports.decrypt=decrypt;var Decrypter=function(){function Decrypter(encrypted,key,initVector,done){_classCallCheck(this,Decrypter);var step=Decrypter.STEP;var encrypted32=new Int32Array(encrypted.buffer);var decrypted=new Uint8Array(encrypted.byteLength);var i=0;this.asyncStream_=new _asyncStream2["default"];this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted));for(i=step;i<encrypted32.length;i+=step){initVector=new Uint32Array([ntoh(encrypted32[i-4]),ntoh(encrypted32[i-3]),ntoh(encrypted32[i-2]),ntoh(encrypted32[i-1])]);this.asyncStream_.push(this.decryptChunk_(encrypted32.subarray(i,i+step),key,initVector,decrypted))}this.asyncStream_.push(function(){done(null,(0,_pkcs7.unpad)(decrypted))})}_createClass(Decrypter,[{key:"decryptChunk_",value:function decryptChunk_(encrypted,key,initVector,decrypted){return function(){var bytes=decrypt(encrypted,key,initVector);decrypted.set(bytes,encrypted.byteOffset)}}}],[{key:"STEP",get:function get(){return 32e3}}]);return Decrypter}();exports.Decrypter=Decrypter;exports["default"]={Decrypter:Decrypter,decrypt:decrypt}},{"./aes":2,"./async-stream":3,pkcs7:23}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _decrypter=require("./decrypter");var _asyncStream=require("./async-stream");var _asyncStream2=_interopRequireDefault(_asyncStream);exports["default"]={decrypt:_decrypter.decrypt,Decrypter:_decrypter.Decrypter,AsyncStream:_asyncStream2["default"]};module.exports=exports["default"]},{"./async-stream":3,"./decrypter":4}],6:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x2,_x3,_x4){var _again=true;_function:while(_again){var object=_x2,property=_x3,receiver=_x4;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x2=parent;_x3=property;_x4=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _playlistLoader=require("./playlist-loader");var _playlistLoader2=_interopRequireDefault(_playlistLoader);var HlsAudioTrack=function(_AudioTrack){_inherits(HlsAudioTrack,_AudioTrack);function HlsAudioTrack(options){_classCallCheck(this,HlsAudioTrack);_get(Object.getPrototypeOf(HlsAudioTrack.prototype),"constructor",this).call(this,{kind:options["default"]?"main":"alternative",enabled:options["default"]||false,language:options.language,label:options.label});this.hls=options.hls;this.autoselect=options.autoselect||false;this["default"]=options["default"]||false;this.withCredentials=options.withCredentials||false;this.mediaGroups_=[];this.addLoader(options.mediaGroup,options.resolvedUri)}_createClass(HlsAudioTrack,[{key:"getLoader",value:function getLoader(mediaGroup){for(var i=0;i<this.mediaGroups_.length;i++){var mgl=this.mediaGroups_[i];if(mgl.mediaGroup===mediaGroup){return mgl.loader}}}},{key:"addLoader",value:function addLoader(mediaGroup){var uri=arguments.length<=1||arguments[1]===undefined?null:arguments[1];var loader=null;if(uri){loader=new _playlistLoader2["default"](uri,this.hls,this.withCredentials)}this.mediaGroups_.push({mediaGroup:mediaGroup,loader:loader})}},{key:"removeLoader",value:function removeLoader(mediaGroup){for(var i=0;i<this.mediaGroups_.length;i++){var mgl=this.mediaGroups_[i];if(mgl.mediaGroup===mediaGroup){if(mgl.loader){mgl.loader.dispose()}this.mediaGroups_.splice(i,1);return}}}},{key:"dispose",value:function dispose(){var i=this.mediaGroups_.length;while(i--){this.removeLoader(this.mediaGroups_[i].mediaGroup)}}}]);return HlsAudioTrack}(_videoJs.AudioTrack);exports["default"]=HlsAudioTrack;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./playlist-loader":12}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _lineStream=require("./line-stream");var _lineStream2=_interopRequireDefault(_lineStream);var _parseStream=require("./parse-stream");var _parseStream2=_interopRequireDefault(_parseStream);var _parser=require("./parser");var _parser2=_interopRequireDefault(_parser);exports["default"]={LineStream:_lineStream2["default"],ParseStream:_parseStream2["default"],Parser:_parser2["default"]};module.exports=exports["default"]},{"./line-stream":8,"./parse-stream":9,"./parser":10}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _stream=require("../stream");var _stream2=_interopRequireDefault(_stream);var LineStream=function(_Stream){_inherits(LineStream,_Stream);function LineStream(){_classCallCheck(this,LineStream);_get(Object.getPrototypeOf(LineStream.prototype),"constructor",this).call(this);this.buffer=""}_createClass(LineStream,[{key:"push",value:function push(data){var nextNewline=undefined;this.buffer+=data;nextNewline=this.buffer.indexOf("\n");for(;nextNewline>-1;nextNewline=this.buffer.indexOf("\n")){this.trigger("data",this.buffer.substring(0,nextNewline));this.buffer=this.buffer.substring(nextNewline+1)}}}]);return LineStream}(_stream2["default"]);exports["default"]=LineStream;module.exports=exports["default"]},{"../stream":18}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _stream=require("../stream");var _stream2=_interopRequireDefault(_stream);var attributeSeparator=function attributeSeparator(){var key="[^=]*";var value='"[^"]*"|[^,]*';var keyvalue="(?:"+key+")=(?:"+value+")";return new RegExp("(?:^|,)("+keyvalue+")")};var parseAttributes=function parseAttributes(attributes){var attrs=attributes.split(attributeSeparator());var i=attrs.length;var result={};var attr=undefined;while(i--){if(attrs[i]===""){continue}attr=/([^=]*)=(.*)/.exec(attrs[i]).slice(1);attr[0]=attr[0].replace(/^\s+|\s+$/g,"");attr[1]=attr[1].replace(/^\s+|\s+$/g,"");attr[1]=attr[1].replace(/^['"](.*)['"]$/g,"$1");result[attr[0]]=attr[1]}return result};var ParseStream=function(_Stream){_inherits(ParseStream,_Stream);function ParseStream(){_classCallCheck(this,ParseStream);_get(Object.getPrototypeOf(ParseStream.prototype),"constructor",this).call(this)}_createClass(ParseStream,[{key:"push",value:function push(line){var match=undefined;var event=undefined;line=line.replace(/^[\u0000\s]+|[\u0000\s]+$/g,"");if(line.length===0){return}if(line[0]!=="#"){this.trigger("data",{type:"uri",uri:line});return}if(line.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:line.slice(1)});return}line=line.replace("\r","");match=/^#EXTM3U/.exec(line);if(match){this.trigger("data",{type:"tag",tagType:"m3u"});return}match=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(line);if(match){event={type:"tag",tagType:"inf"};if(match[1]){event.duration=parseFloat(match[1])}if(match[2]){event.title=match[2]}this.trigger("data",event);return}match=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"targetduration"};if(match[1]){event.duration=parseInt(match[1],10)}this.trigger("data",event);return}match=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"totalduration"};if(match[1]){event.duration=parseInt(match[1],10)}this.trigger("data",event);return}match=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"version"};if(match[1]){event.version=parseInt(match[1],10)}this.trigger("data",event);return}match=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"media-sequence"};if(match[1]){event.number=parseInt(match[1],10)}this.trigger("data",event);return}match=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"discontinuity-sequence"};if(match[1]){event.number=parseInt(match[1],10)}this.trigger("data",event);return}match=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(line);if(match){event={type:"tag",tagType:"playlist-type"};if(match[1]){event.playlistType=match[1]}this.trigger("data",event);return}match=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(line);if(match){event={type:"tag",tagType:"byterange"};if(match[1]){event.length=parseInt(match[1],10)}if(match[2]){event.offset=parseInt(match[2],10)}this.trigger("data",event);return}match=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(line);if(match){event={type:"tag",tagType:"allow-cache"};if(match[1]){event.allowed=!/NO/.test(match[1])}this.trigger("data",event);return}match=/^#EXT-X-STREAM-INF:?(.*)$/.exec(line);if(match){event={type:"tag",tagType:"stream-inf"};if(match[1]){event.attributes=parseAttributes(match[1]);if(event.attributes.RESOLUTION){var split=event.attributes.RESOLUTION.split("x");var resolution={};if(split[0]){resolution.width=parseInt(split[0],10)}if(split[1]){resolution.height=parseInt(split[1],10)}event.attributes.RESOLUTION=resolution}if(event.attributes.BANDWIDTH){event.attributes.BANDWIDTH=parseInt(event.attributes.BANDWIDTH,10)}if(event.attributes["PROGRAM-ID"]){event.attributes["PROGRAM-ID"]=parseInt(event.attributes["PROGRAM-ID"],10)}}this.trigger("data",event);return}match=/^#EXT-X-MEDIA:?(.*)$/.exec(line);if(match){event={type:"tag",tagType:"media"};if(match[1]){event.attributes=parseAttributes(match[1])}this.trigger("data",event);return}match=/^#EXT-X-ENDLIST/.exec(line);if(match){this.trigger("data",{type:"tag",tagType:"endlist"});return}match=/^#EXT-X-DISCONTINUITY/.exec(line);if(match){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}match=/^#EXT-X-KEY:?(.*)$/.exec(line);if(match){event={type:"tag",tagType:"key"};if(match[1]){event.attributes=parseAttributes(match[1]);if(event.attributes.IV){if(event.attributes.IV.substring(0,2).toLowerCase()==="0x"){event.attributes.IV=event.attributes.IV.substring(2)}event.attributes.IV=event.attributes.IV.match(/.{8}/g);event.attributes.IV[0]=parseInt(event.attributes.IV[0],16);event.attributes.IV[1]=parseInt(event.attributes.IV[1],16);event.attributes.IV[2]=parseInt(event.attributes.IV[2],16);event.attributes.IV[3]=parseInt(event.attributes.IV[3],16);event.attributes.IV=new Uint32Array(event.attributes.IV)}}this.trigger("data",event);return}this.trigger("data",{type:"tag",data:line.slice(4,line.length)})}}]);return ParseStream}(_stream2["default"]);exports["default"]=ParseStream;module.exports=exports["default"]},{"../stream":18}],10:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _stream=require("../stream");var _stream2=_interopRequireDefault(_stream);var _lineStream=require("./line-stream");var _lineStream2=_interopRequireDefault(_lineStream);var _parseStream=require("./parse-stream");var _parseStream2=_interopRequireDefault(_parseStream);var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var Parser=function(_Stream){_inherits(Parser,_Stream);function Parser(){_classCallCheck(this,Parser);_get(Object.getPrototypeOf(Parser.prototype),"constructor",this).call(this);this.lineStream=new _lineStream2["default"];this.parseStream=new _parseStream2["default"];this.lineStream.pipe(this.parseStream);var self=this;var uris=[];var currentUri={};var _key=undefined;var noop=function noop(){};var defaultMediaGroups={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}};var currentTimeline=0;this.manifest={allowCache:true,discontinuityStarts:[]};this.parseStream.on("data",function(entry){var mediaGroup=undefined;var rendition=undefined;({tag:function tag(){(({"allow-cache":function allowCache(){this.manifest.allowCache=entry.allowed;if(!("allowed"in entry)){this.trigger("info",{message:"defaulting allowCache to YES"});this.manifest.allowCache=true}},byterange:function byterange(){var byterange={};if("length"in entry){currentUri.byterange=byterange;byterange.length=entry.length;if(!("offset"in entry)){this.trigger("info",{message:"defaulting offset to zero"});entry.offset=0}}if("offset"in entry){currentUri.byterange=byterange;byterange.offset=entry.offset}},endlist:function endlist(){this.manifest.endList=true},inf:function inf(){if(!("mediaSequence"in this.manifest)){this.manifest.mediaSequence=0;this.trigger("info",{message:"defaulting media sequence to zero"})}if(!("discontinuitySequence"in this.manifest)){this.manifest.discontinuitySequence=0;this.trigger("info",{message:"defaulting discontinuity sequence to zero"})}if(entry.duration>=0){currentUri.duration=entry.duration}this.manifest.segments=uris},key:function key(){if(!entry.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(entry.attributes.METHOD==="NONE"){_key=null;return}if(!entry.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(!entry.attributes.METHOD){this.trigger("warn",{message:"defaulting key method to AES-128"})}_key={method:entry.attributes.METHOD||"AES-128",uri:entry.attributes.URI};if(typeof entry.attributes.IV!=="undefined"){_key.iv=entry.attributes.IV}},"media-sequence":function mediaSequence(){if(!isFinite(entry.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+entry.number});return}this.manifest.mediaSequence=entry.number},"discontinuity-sequence":function discontinuitySequence(){if(!isFinite(entry.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+entry.number});return}this.manifest.discontinuitySequence=entry.number;currentTimeline=entry.number},"playlist-type":function playlistType(){if(!/VOD|EVENT/.test(entry.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+entry.playlist});return}this.manifest.playlistType=entry.playlistType},"stream-inf":function streamInf(){this.manifest.playlists=uris;this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups;if(!entry.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}if(!currentUri.attributes){currentUri.attributes={}}currentUri.attributes=(0,_videoJs.mergeOptions)(currentUri.attributes,entry.attributes)},media:function media(){this.manifest.mediaGroups=this.manifest.mediaGroups||defaultMediaGroups;if(!(entry.attributes&&entry.attributes.TYPE&&entry.attributes["GROUP-ID"]&&entry.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}
var mediaGroupType=this.manifest.mediaGroups[entry.attributes.TYPE];mediaGroupType[entry.attributes["GROUP-ID"]]=mediaGroupType[entry.attributes["GROUP-ID"]]||{};mediaGroup=mediaGroupType[entry.attributes["GROUP-ID"]];rendition={default:/yes/i.test(entry.attributes.DEFAULT)};if(rendition["default"]){rendition.autoselect=true}else{rendition.autoselect=/yes/i.test(entry.attributes.AUTOSELECT)}if(entry.attributes.LANGUAGE){rendition.language=entry.attributes.LANGUAGE}if(entry.attributes.URI){rendition.uri=entry.attributes.URI}mediaGroup[entry.attributes.NAME]=rendition},discontinuity:function discontinuity(){currentTimeline+=1;currentUri.discontinuity=true;this.manifest.discontinuityStarts.push(uris.length)},targetduration:function targetduration(){if(!isFinite(entry.duration)||entry.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+entry.duration});return}this.manifest.targetDuration=entry.duration},totalduration:function totalduration(){if(!isFinite(entry.duration)||entry.duration<0){this.trigger("warn",{message:"ignoring invalid total duration: "+entry.duration});return}this.manifest.totalDuration=entry.duration}})[entry.tagType]||noop).call(self)},uri:function uri(){currentUri.uri=entry.uri;uris.push(currentUri);if(this.manifest.targetDuration&&!("duration"in currentUri)){this.trigger("warn",{message:"defaulting segment duration to the target duration"});currentUri.duration=this.manifest.targetDuration}if(_key){currentUri.key=_key}currentUri.timeline=currentTimeline;currentUri={}},comment:function comment(){}})[entry.type].call(self)})}_createClass(Parser,[{key:"push",value:function push(chunk){this.lineStream.push(chunk)}},{key:"end",value:function end(){this.lineStream.push("\n")}}]);return Parser}(_stream2["default"]);exports["default"]=Parser;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../stream":18,"./line-stream":8,"./parse-stream":9}],11:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x2,_x3,_x4){var _again=true;_function:while(_again){var object=_x2,property=_x3,receiver=_x4;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x2=parent;_x3=property;_x4=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _playlistLoader=require("./playlist-loader");var _playlistLoader2=_interopRequireDefault(_playlistLoader);var _segmentLoader=require("./segment-loader");var _segmentLoader2=_interopRequireDefault(_segmentLoader);var _ranges=require("./ranges");var _ranges2=_interopRequireDefault(_ranges);var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _hlsAudioTrack=require("./hls-audio-track");var _hlsAudioTrack2=_interopRequireDefault(_hlsAudioTrack);var BLACKLIST_DURATION=5*60*1e3;var Hls=undefined;var parseCodecs=function parseCodecs(codecs){var result={codecCount:0,videoCodec:null,audioProfile:null};result.codecCount=codecs.split(",").length;result.codecCount=result.codecCount||2;result.videoCodec=/(^|\s|,)+(avc1)[^ ,]*/i.exec(codecs);result.videoCodec=result.videoCodec&&result.videoCodec[2];result.audioProfile=/(^|\s|,)+mp4a.\d+\.(\d+)/i.exec(codecs);result.audioProfile=result.audioProfile&&result.audioProfile[2];return result};var MasterPlaylistController=function(_videojs$EventTarget){_inherits(MasterPlaylistController,_videojs$EventTarget);function MasterPlaylistController(_ref){var _this=this;var url=_ref.url;var withCredentials=_ref.withCredentials;var mode=_ref.mode;var tech=_ref.tech;var bandwidth=_ref.bandwidth;var externHls=_ref.externHls;_classCallCheck(this,MasterPlaylistController);_get(Object.getPrototypeOf(MasterPlaylistController.prototype),"constructor",this).call(this);Hls=externHls;this.withCredentials=withCredentials;this.tech_=tech;this.hls_=tech.hls;this.mode_=mode;this.audioTracks_=[];this.mediaSource=new _videoJs2["default"].MediaSource({mode:mode});this.mediaSource.on("audioinfo",function(e){return _this.trigger(e)});this.mediaSource.addEventListener("sourceopen",this.handleSourceOpen_.bind(this));var segmentLoaderOptions={hls:this.hls_,mediaSource:this.mediaSource,currentTime:this.tech_.currentTime.bind(this.tech_),withCredentials:this.withCredentials,seekable:function seekable(){return _this.seekable()},seeking:function seeking(){return _this.tech_.seeking()},setCurrentTime:function setCurrentTime(a){return _this.setCurrentTime(a)},hasPlayed:function hasPlayed(){return _this.tech_.played().length!==0},bandwidth:bandwidth};this.mainSegmentLoader_=new _segmentLoader2["default"](segmentLoaderOptions);this.audioSegmentLoader_=new _segmentLoader2["default"](segmentLoaderOptions);if(!url){throw new Error("A non-empty playlist URL is required")}this.masterPlaylistLoader_=new _playlistLoader2["default"](url,this.hls_,this.withCredentials);this.masterPlaylistLoader_.on("loadedmetadata",function(){var media=_this.masterPlaylistLoader_.media();if(media.endList&&_this.tech_.preload()!=="none"){_this.mainSegmentLoader_.playlist(media);_this.mainSegmentLoader_.expired(_this.masterPlaylistLoader_.expired_);_this.mainSegmentLoader_.load()}_this.setupSourceBuffer_();_this.setupFirstPlay();_this.useAudio()});this.masterPlaylistLoader_.on("loadedplaylist",function(){var updatedPlaylist=_this.masterPlaylistLoader_.media();var seekable=undefined;if(!updatedPlaylist){_this.initialMedia_=_this.selectPlaylist();_this.masterPlaylistLoader_.media(_this.initialMedia_);_this.fillAudioTracks_();_this.trigger("selectedinitialmedia");return}_this.mainSegmentLoader_.playlist(updatedPlaylist);_this.mainSegmentLoader_.expired(_this.masterPlaylistLoader_.expired_);_this.updateDuration();seekable=_this.seekable();if(!updatedPlaylist.endList&&seekable.length!==0){_this.mediaSource.addSeekableRange_(seekable.start(0),seekable.end(0))}});this.masterPlaylistLoader_.on("error",function(){_this.blacklistCurrentPlaylist(_this.masterPlaylistLoader_.error)});this.masterPlaylistLoader_.on("mediachanging",function(){_this.mainSegmentLoader_.pause()});this.masterPlaylistLoader_.on("mediachange",function(){_this.mainSegmentLoader_.abort();_this.mainSegmentLoader_.load();_this.tech_.trigger({type:"mediachange",bubbles:true})});this.mainSegmentLoader_.on("progress",function(){_this.masterPlaylistLoader_.media(_this.selectPlaylist());_this.trigger("progress")});this.mainSegmentLoader_.on("error",function(){_this.blacklistCurrentPlaylist(_this.mainSegmentLoader_.error())});this.audioSegmentLoader_.on("error",function(){_videoJs2["default"].log.warn("Problem encountered with the current alternate audio track"+". Switching back to default.");_this.audioSegmentLoader_.abort();_this.audioPlaylistLoader_=null;_this.useAudio()});this.masterPlaylistLoader_.load()}_createClass(MasterPlaylistController,[{key:"fillAudioTracks_",value:function fillAudioTracks_(){var master=this.master();var mediaGroups=master.mediaGroups||{};if(!mediaGroups||!mediaGroups.AUDIO||Object.keys(mediaGroups.AUDIO).length===0||this.mode_!=="html5"){mediaGroups.AUDIO={main:{default:{default:true}}}}var tracks={};for(var mediaGroup in mediaGroups.AUDIO){for(var label in mediaGroups.AUDIO[mediaGroup]){var properties=mediaGroups.AUDIO[mediaGroup][label];if(tracks[label]){tracks[label].addLoader(mediaGroup,properties.resolvedUri);continue}var track=new _hlsAudioTrack2["default"](_videoJs2["default"].mergeOptions(properties,{hls:this.hls_,withCredentials:this.withCredential,mediaGroup:mediaGroup,label:label}));tracks[label]=track;this.audioTracks_.push(track)}}}},{key:"load",value:function load(){this.mainSegmentLoader_.load();if(this.audioPlaylistLoader_){this.audioSegmentLoader_.load()}}},{key:"activeAudioGroup",value:function activeAudioGroup(){var media=this.masterPlaylistLoader_.media();var mediaGroup="main";if(media&&media.attributes&&media.attributes.AUDIO){mediaGroup=media.attributes.AUDIO}return mediaGroup}},{key:"useAudio",value:function useAudio(){var _this2=this;var track=undefined;this.audioTracks_.forEach(function(t){if(!track&&t.enabled){track=t}});if(!track){return}if(this.audioPlaylistLoader_){this.audioPlaylistLoader_.pause();this.audioPlaylistLoader_=null;this.audioSegmentLoader_.pause()}var loader=track.getLoader(this.activeAudioGroup());if(!loader){this.mainSegmentLoader_.clearBuffer();return}this.audioPlaylistLoader_=loader;if(this.audioPlaylistLoader_.started){this.audioPlaylistLoader_.load();this.audioSegmentLoader_.load();this.audioSegmentLoader_.clearBuffer();return}this.audioPlaylistLoader_.on("loadedmetadata",function(){var media=_this2.audioPlaylistLoader_.media();_this2.audioSegmentLoader_.playlist(media);_this2.addMimeType_(_this2.audioSegmentLoader_,"mp4a.40.2",media);if(!_this2.tech_.paused()||media.endList&&_this2.tech_.preload()!=="none"){_this2.audioSegmentLoader_.load()}if(!media.endList){_this2.audioPlaylistLoader_.trigger("firstplay")}});this.audioPlaylistLoader_.on("loadedplaylist",function(){var updatedPlaylist=undefined;if(_this2.audioPlaylistLoader_){updatedPlaylist=_this2.audioPlaylistLoader_.media()}if(!updatedPlaylist){_this2.audioPlaylistLoader_.media(_this2.audioPlaylistLoader_.playlists.master.playlists[0]);return}_this2.audioSegmentLoader_.playlist(updatedPlaylist)});this.audioPlaylistLoader_.on("error",function(){_videoJs2["default"].log.warn("Problem encountered loading the alternate audio track"+". Switching back to default.");_this2.audioSegmentLoader_.abort();_this2.audioPlaylistLoader_=null;_this2.useAudio()});this.audioSegmentLoader_.clearBuffer();this.audioPlaylistLoader_.start()}},{key:"fastQualityChange_",value:function fastQualityChange_(){var media=this.selectPlaylist();if(media!==this.masterPlaylistLoader_.media()){this.masterPlaylistLoader_.media(media);this.mainSegmentLoader_.sourceUpdater_.remove(this.tech_.currentTime()+5,Infinity)}}},{key:"play",value:function play(){if(this.setupFirstPlay()){return}if(this.tech_.ended()){this.tech_.setCurrentTime(0)}this.load();if(this.tech_.duration()===Infinity){if(this.tech_.currentTime()<this.tech_.seekable().start(0)){return this.tech_.setCurrentTime(this.tech_.seekable().start(0))}}}},{key:"setupFirstPlay",value:function setupFirstPlay(){var seekable=undefined;var media=this.masterPlaylistLoader_.media();if(media&&!media.endList&&!this.tech_.paused()&&!this.hasPlayed_){this.load();this.masterPlaylistLoader_.trigger("firstplay");this.hasPlayed_=true;seekable=this.seekable();if(seekable.length){this.tech_.setCurrentTime(seekable.end(0))}return true}return false}},{key:"handleSourceOpen_",value:function handleSourceOpen_(){this.setupSourceBuffer_();if(this.tech_.autoplay()){this.tech_.play()}this.trigger("sourceopen")}},{key:"blacklistCurrentPlaylist",value:function blacklistCurrentPlaylist(){var error=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var currentPlaylist=undefined;var nextPlaylist=undefined;currentPlaylist=error.playlist||this.masterPlaylistLoader_.media();if(!currentPlaylist){this.error=error;return this.mediaSource.endOfStream("network")}currentPlaylist.excludeUntil=Date.now()+BLACKLIST_DURATION;nextPlaylist=this.selectPlaylist();if(nextPlaylist){_videoJs2["default"].log.warn("Problem encountered with the current "+"HLS playlist. Switching to another playlist.");return this.masterPlaylistLoader_.media(nextPlaylist)}_videoJs2["default"].log.warn("Problem encountered with the current "+"HLS playlist. No suitable alternatives found.");this.error=error;return this.mediaSource.endOfStream("network")}},{key:"pauseLoading",value:function pauseLoading(){this.mainSegmentLoader_.pause();if(this.audioPlaylistLoader_){this.audioSegmentLoader_.pause()}}},{key:"setCurrentTime",value:function setCurrentTime(currentTime){var buffered=_ranges2["default"].findRange(this.tech_.buffered(),currentTime);if(!(this.masterPlaylistLoader_&&this.masterPlaylistLoader_.media())){return 0}if(!this.masterPlaylistLoader_.media().segments){return 0}if(buffered&&buffered.length){return currentTime}this.mainSegmentLoader_.abort();if(this.audioPlaylistLoader_){this.audioSegmentLoader_.abort()}if(!this.tech_.paused()){this.mainSegmentLoader_.load();if(this.audioPlaylistLoader_){this.audioSegmentLoader_.load()}}}},{key:"duration",value:function duration(){if(!this.masterPlaylistLoader_){return 0}if(this.mediaSource){return this.mediaSource.duration}return Hls.Playlist.duration(this.masterPlaylistLoader_.media())}},{key:"seekable",value:function seekable(){var media=undefined;var mainSeekable=undefined;var audioSeekable=undefined;if(!this.masterPlaylistLoader_){return _videoJs2["default"].createTimeRanges()}media=this.masterPlaylistLoader_.media();if(!media){return _videoJs2["default"].createTimeRanges()}mainSeekable=Hls.Playlist.seekable(media,this.masterPlaylistLoader_.expired_);if(mainSeekable.length===0){return mainSeekable}if(this.audioPlaylistLoader_){audioSeekable=Hls.Playlist.seekable(this.audioPlaylistLoader_.media(),this.audioPlaylistLoader_.expired_);if(audioSeekable.length===0){return audioSeekable}}if(!audioSeekable){return mainSeekable}return _videoJs2["default"].createTimeRanges([[audioSeekable.start(0)>mainSeekable.start(0)?audioSeekable.start(0):mainSeekable.start(0),audioSeekable.end(0)<mainSeekable.end(0)?audioSeekable.end(0):mainSeekable.end(0)]])}},{key:"updateDuration",value:function updateDuration(){var _this3=this;var oldDuration=this.mediaSource.duration;var newDuration=Hls.Playlist.duration(this.masterPlaylistLoader_.media());var buffered=this.tech_.buffered();var setDuration=function setDuration(){_this3.mediaSource.duration=newDuration;_this3.tech_.trigger("durationchange");_this3.mediaSource.removeEventListener("sourceopen",setDuration)};if(buffered.length>0){newDuration=Math.max(newDuration,buffered.end(buffered.length-1))}if(oldDuration!==newDuration){if(this.mediaSource.readyState!=="open"){this.mediaSource.addEventListener("sourceopen",setDuration)}else{setDuration()}}}},{key:"dispose",value:function dispose(){this.masterPlaylistLoader_.dispose();this.audioTracks_.forEach(function(track){track.dispose()});this.audioTracks_.length=0;this.mainSegmentLoader_.dispose();this.audioSegmentLoader_.dispose()}},{key:"master",value:function master(){return this.masterPlaylistLoader_.master}},{key:"media",value:function media(){return this.masterPlaylistLoader_.media()||this.initialMedia_}},{key:"setupSourceBuffer_",value:function setupSourceBuffer_(){var media=this.masterPlaylistLoader_.media();if(!media||this.mediaSource.readyState!=="open"){return}this.addMimeType_(this.mainSegmentLoader_,"avc1.4d400d, mp4a.40.2",media);this.excludeIncompatibleVariants_(media)}},{key:"addMimeType_",value:function addMimeType_(segmentLoader,defaultCodecs,media){var mimeType="video/mp2t";if(media.attributes&&media.attributes.CODECS){mimeType+='; codecs="'+media.attributes.CODECS+'"'}else{mimeType+='; codecs="'+defaultCodecs+'"'}segmentLoader.mimeType(mimeType)}},{key:"excludeIncompatibleVariants_",value:function excludeIncompatibleVariants_(media){var master=this.masterPlaylistLoader_.master;var codecCount=2;var videoCodec=null;var audioProfile=null;var codecs=undefined;if(media.attributes&&media.attributes.CODECS){codecs=parseCodecs(media.attributes.CODECS);videoCodec=codecs.videoCodec;audioProfile=codecs.audioProfile;codecCount=codecs.codecCount}master.playlists.forEach(function(variant){var variantCodecs={codecCount:2,videoCodec:null,audioProfile:null};if(variant.attributes&&variant.attributes.CODECS){variantCodecs=parseCodecs(variant.attributes.CODECS)}if(variantCodecs.codecCount!==codecCount){variant.excludeUntil=Infinity}if(variantCodecs.videoCodec!==videoCodec){variant.excludeUntil=Infinity}if(variantCodecs.audioProfile==="5"&&audioProfile!=="5"||audioProfile==="5"&&variantCodecs.audioProfile!=="5"){variant.excludeUntil=Infinity}})}}]);return MasterPlaylistController}(_videoJs2["default"].EventTarget);exports["default"]=MasterPlaylistController;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./hls-audio-track":6,"./playlist-loader":12,"./ranges":14,"./segment-loader":16}],12:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _resolveUrl=require("./resolve-url");var _resolveUrl2=_interopRequireDefault(_resolveUrl);var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _stream=require("./stream");var _stream2=_interopRequireDefault(_stream);var _m3u8=require("./m3u8");var _m3u82=_interopRequireDefault(_m3u8);var updateSegments=function updateSegments(original,update,offset){var result=update.slice();var length=undefined;var i=undefined;offset=offset||0;length=Math.min(original.length,update.length+offset);for(i=offset;i<length;i++){result[i-offset]=(0,_videoJs.mergeOptions)(original[i],result[i-offset])}return result};var updateMaster=function updateMaster(master,media){var changed=false;var result=(0,_videoJs.mergeOptions)(master,{});var i=master.playlists.length;var playlist=undefined;var segment=undefined;var j=undefined;while(i--){playlist=result.playlists[i];if(playlist.uri===media.uri){if(playlist.segments&&media.segments&&playlist.segments.length===media.segments.length&&playlist.mediaSequence===media.mediaSequence){continue}result.playlists[i]=(0,_videoJs.mergeOptions)(playlist,media);result.playlists[media.uri]=result.playlists[i];if(playlist.segments){result.playlists[i].segments=updateSegments(playlist.segments,media.segments,media.mediaSequence-playlist.mediaSequence)}j=0;if(result.playlists[i].segments){j=result.playlists[i].segments.length}while(j--){segment=result.playlists[i].segments[j];if(!segment.resolvedUri){segment.resolvedUri=(0,_resolveUrl2["default"])(playlist.resolvedUri,segment.uri)}if(segment.key&&!segment.key.resolvedUri){segment.key.resolvedUri=(0,_resolveUrl2["default"])(playlist.resolvedUri,segment.key.uri)}}changed=true}}return changed?result:null};var PlaylistLoader=function PlaylistLoader(srcUrl,hls,withCredentials){var _this=this;var loader=this;var dispose=undefined;var mediaUpdateTimeout=undefined;var request=undefined;var playlistRequestError=undefined;var haveMetadata=undefined;PlaylistLoader.prototype.constructor.call(this);this.hls_=hls;this.trackExpiredTime_=false;if(!srcUrl){throw new Error("A non-empty playlist URL is required")}playlistRequestError=function(xhr,url,startingState){loader.setBandwidth(request||xhr);request=null;if(startingState){loader.state=startingState}loader.error={playlist:loader.master.playlists[url],status:xhr.status,message:"HLS playlist request error at URL: "+url,responseText:xhr.responseText,code:xhr.status>=500?4:2};loader.trigger("error")};haveMetadata=function(xhr,url){var parser=undefined;var refreshDelay=undefined;var update=undefined;loader.setBandwidth(request||xhr);request=null;loader.state="HAVE_METADATA";parser=new _m3u82["default"].Parser;parser.push(xhr.responseText);parser.end();parser.manifest.uri=url;update=updateMaster(loader.master,parser.manifest);refreshDelay=(parser.manifest.targetDuration||10)*1e3;if(update){loader.master=update;loader.updateMediaPlaylist_(parser.manifest)}else{refreshDelay/=2}if(!loader.media().endList){window.clearTimeout(mediaUpdateTimeout);mediaUpdateTimeout=window.setTimeout(function(){loader.trigger("mediaupdatetimeout")},refreshDelay)}loader.trigger("loadedplaylist")};loader.state="HAVE_NOTHING";this.expired_=0;dispose=this.dispose;loader.dispose=function(){loader.stopRequest();window.clearTimeout(mediaUpdateTimeout);dispose.call(this)};loader.stopRequest=function(){if(request){var oldRequest=request;request=null;oldRequest.onreadystatechange=null;oldRequest.abort()}};loader.media=function(playlist){var startingState=loader.state;var mediaChange=undefined;if(!playlist){return loader.media_}if(loader.state==="HAVE_NOTHING"){throw new Error("Cannot switch media playlist from "+loader.state)}if(typeof playlist==="string"){if(!loader.master.playlists[playlist]){throw new Error("Unknown playlist URI: "+playlist)}playlist=loader.master.playlists[playlist]}mediaChange=!loader.media_||playlist.uri!==loader.media_.uri;if(loader.master.playlists[playlist.uri].endList){if(request){request.onreadystatechange=null;request.abort();request=null}loader.state="HAVE_METADATA";loader.media_=playlist;if(mediaChange){loader.trigger("mediachanging");loader.trigger("mediachange")}return}if(!mediaChange){return}loader.state="SWITCHING_MEDIA";if(request){if((0,_resolveUrl2["default"])(loader.master.uri,playlist.uri)===request.url){return}request.onreadystatechange=null;request.abort();request=null}if(this.media_){this.trigger("mediachanging")}request=this.hls_.xhr({uri:(0,_resolveUrl2["default"])(loader.master.uri,playlist.uri),withCredentials:withCredentials},function(error,req){if(!request){return}if(error){return playlistRequestError(request,playlist.uri,startingState)}haveMetadata(req,playlist.uri);if(startingState==="HAVE_MASTER"){loader.trigger("loadedmetadata")}else{loader.trigger("mediachange")}})};loader.setBandwidth=function(xhr){loader.bandwidth=xhr.bandwidth};loader.on("firstplay",function(){this.trackExpiredTime_=true});loader.on("mediaupdatetimeout",function(){if(loader.state!=="HAVE_METADATA"){return}loader.state="HAVE_CURRENT_METADATA";request=this.hls_.xhr({uri:(0,_resolveUrl2["default"])(loader.master.uri,loader.media().uri),withCredentials:withCredentials},function(error,req){if(!request){return}if(error){return playlistRequestError(request,loader.media().uri)}haveMetadata(request,loader.media().uri)})});loader.pause=function(){loader.stopRequest();window.clearTimeout(mediaUpdateTimeout)};loader.load=function(){if(loader.started){if(!loader.media().endList){loader.trigger("mediaupdatetimeout")}else{loader.trigger("loadedplaylist")}}else{loader.start()}};loader.start=function(){loader.started=true;request=_this.hls_.xhr({uri:srcUrl,withCredentials:withCredentials},function(error,req){var parser=undefined;var playlist=undefined;var i=undefined;if(!request){return}request=null;if(error){loader.error={status:req.status,message:"HLS playlist request error at URL: "+srcUrl,responseText:req.responseText,code:2};return loader.trigger("error")}parser=new _m3u82["default"].Parser;parser.push(req.responseText);parser.end();loader.state="HAVE_MASTER";parser.manifest.uri=srcUrl;if(parser.manifest.playlists){loader.master=parser.manifest;i=loader.master.playlists.length;while(i--){playlist=loader.master.playlists[i];loader.master.playlists[playlist.uri]=playlist;playlist.resolvedUri=(0,_resolveUrl2["default"])(loader.master.uri,playlist.uri)}for(var groupKey in loader.master.mediaGroups.AUDIO){for(var labelKey in loader.master.mediaGroups.AUDIO[groupKey]){var alternateAudio=loader.master.mediaGroups.AUDIO[groupKey][labelKey];if(alternateAudio.uri){alternateAudio.resolvedUri=(0,_resolveUrl2["default"])(loader.master.uri,alternateAudio.uri)}}}loader.trigger("loadedplaylist");if(!request){loader.media(parser.manifest.playlists[0])}return}loader.master={uri:window.location.href,playlists:[{uri:srcUrl}]};loader.master.playlists[srcUrl]=loader.master.playlists[0];loader.master.playlists[0].resolvedUri=srcUrl;haveMetadata(req,srcUrl);return loader.trigger("loadedmetadata")})}};PlaylistLoader.prototype=new _stream2["default"];PlaylistLoader.prototype.updateMediaPlaylist_=function(update){var outdated=undefined;var i=undefined;var segment=undefined;outdated=this.media_;this.media_=this.master.playlists[update.uri];if(!outdated){return}if(!this.trackExpiredTime_){return}if(update.uri!==outdated.uri){return}if(update.segments.length){if(typeof update.segments[0].start!=="undefined"){this.expired_=update.segments[0].start;return}else if(typeof update.segments[0].end!=="undefined"){this.expired_=update.segments[0].end-update.segments[0].duration;return}}i=update.mediaSequence-outdated.mediaSequence-1;for(;i>=0;i--){segment=outdated.segments[i];if(!segment){this.expired_+=outdated.targetDuration||10;continue}if(typeof segment.end!=="undefined"){this.expired_=segment.end;return}if(typeof segment.start!=="undefined"){this.expired_=segment.start+segment.duration;return}this.expired_+=segment.duration}};exports["default"]=PlaylistLoader;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./m3u8":7,"./resolve-url":15,"./stream":18}],13:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var Playlist={UNSAFE_LIVE_SEGMENTS:3};var backwardDuration=function backwardDuration(playlist,endSequence){var result=0;var i=endSequence-playlist.mediaSequence;var segment=playlist.segments[i];if(segment){if(typeof segment.start!=="undefined"){return{result:segment.start,precise:true}}if(typeof segment.end!=="undefined"){return{result:segment.end-segment.duration,precise:true}}}while(i--){segment=playlist.segments[i];if(typeof segment.end!=="undefined"){return{result:result+segment.end,precise:true}}result+=segment.duration;if(typeof segment.start!=="undefined"){return{result:result+segment.start,precise:true}}}return{result:result,precise:false}};var forwardDuration=function forwardDuration(playlist,endSequence){var result=0;var segment=undefined;var i=endSequence-playlist.mediaSequence;for(;i<playlist.segments.length;i++){segment=playlist.segments[i];if(typeof segment.start!=="undefined"){return{result:segment.start-result,precise:true}}result+=segment.duration;if(typeof segment.end!=="undefined"){return{result:segment.end-result,precise:true}}}return{result:-1,precise:false}};var intervalDuration=function intervalDuration(playlist,endSequence,expired){var backward=undefined;var forward=undefined;if(typeof endSequence==="undefined"){endSequence=playlist.mediaSequence+playlist.segments.length}if(endSequence<playlist.mediaSequence){return 0}backward=backwardDuration(playlist,endSequence);if(backward.precise){return backward.result}forward=forwardDuration(playlist,endSequence);if(forward.precise){return forward.result}return backward.result+expired};var duration=function duration(playlist,endSequence,expired){if(!playlist){return 0}if(typeof expired!=="number"){expired=0}if(typeof endSequence==="undefined"){if(playlist.totalDuration){return playlist.totalDuration}if(!playlist.endList){return window.Infinity}}return intervalDuration(playlist,endSequence,expired)};exports.duration=duration;var seekable=function seekable(playlist,expired){var start=undefined;var end=undefined;var endSequence=undefined;if(typeof expired!=="number"){expired=0}if(!playlist||!playlist.segments){return(0,_videoJs.createTimeRange)()}if(playlist.endList){return(0,_videoJs.createTimeRange)(0,duration(playlist))}start=intervalDuration(playlist,playlist.mediaSequence,expired);endSequence=Math.max(0,playlist.segments.length-Playlist.UNSAFE_LIVE_SEGMENTS);end=intervalDuration(playlist,playlist.mediaSequence+endSequence,expired);return(0,_videoJs.createTimeRange)(start,end)};exports.seekable=seekable;var getMediaIndexForTime_=function getMediaIndexForTime_(playlist,time,expired){var i=undefined;var segment=undefined;var originalTime=time;var numSegments=playlist.segments.length;var lastSegment=numSegments-1;var startIndex=undefined;var endIndex=undefined;var knownStart=undefined;var knownEnd=undefined;if(!playlist){return 0}if(time<0){return 0}expired=expired||0;for(i=0;i<numSegments;i++){segment=playlist.segments[i];if(segment.end){if(segment.end>time){knownEnd=segment.end;endIndex=i;break}else{knownStart=segment.end;startIndex=i+1}}}if(startIndex===numSegments){return numSegments}if(typeof startIndex!=="undefined"){time=time-knownStart;for(i=startIndex;i<(endIndex||numSegments);i++){segment=playlist.segments[i];time-=segment.duration;if(time<0){return i}}if(i>=endIndex){return startIndex+Math.floor((originalTime-knownStart)/(knownEnd-knownStart)*(endIndex-startIndex))}return lastSegment}else if(typeof endIndex!=="undefined"){time=knownEnd-time;for(i=endIndex;i>=0;i--){segment=playlist.segments[i];time-=segment.duration;if(time<0){return i}}if(time===0){return 0}return-1}time=time-expired;if(time<0){return-1}for(i=0;i<numSegments;i++){segment=playlist.segments[i];time-=segment.duration;if(time<0){return i}}return lastSegment};exports.getMediaIndexForTime_=getMediaIndexForTime_;Playlist.duration=duration;Playlist.seekable=seekable;Playlist.getMediaIndexForTime_=getMediaIndexForTime_;exports["default"]=Playlist}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],14:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var TIME_FUDGE_FACTOR=1/30;var filterRanges=function filterRanges(timeRanges,predicate){var results=[];var i=undefined;if(timeRanges&&timeRanges.length){for(i=0;i<timeRanges.length;i++){if(predicate(timeRanges.start(i),timeRanges.end(i))){results.push([timeRanges.start(i),timeRanges.end(i)])}}}return _videoJs2["default"].createTimeRanges(results)};var findRange=function findRange(buffered,time){return filterRanges(buffered,function(start,end){return start-TIME_FUDGE_FACTOR<=time&&end+TIME_FUDGE_FACTOR>=time})};var findNextRange=function findNextRange(timeRanges,time){return filterRanges(timeRanges,function(start){return start-TIME_FUDGE_FACTOR>=time})};var findSoleUncommonTimeRangesEnd=function findSoleUncommonTimeRangesEnd(original,update){var i=undefined;var start=undefined;var end=undefined;var result=[];var edges=[];var overlapsCurrentEnd=function overlapsCurrentEnd(span){return span[0]<=end&&span[1]>=end};if(original){for(i=0;i<original.length;i++){start=original.start(i);end=original.end(i);edges.push([start,end])}}if(update){for(i=0;i<update.length;i++){start=update.start(i);end=update.end(i)
;if(edges.some(overlapsCurrentEnd)){continue}result.push(end)}}if(result.length!==1){return null}return result[0]};var bufferIntersection=function bufferIntersection(bufferA,bufferB){var start=null;var end=null;var arity=0;var extents=[];var ranges=[];if(!bufferA||!bufferA.length||!bufferB||!bufferB.length){return _videoJs2["default"].createTimeRange()}var count=bufferA.length;while(count--){extents.push({time:bufferA.start(count),type:"start"});extents.push({time:bufferA.end(count),type:"end"})}count=bufferB.length;while(count--){extents.push({time:bufferB.start(count),type:"start"});extents.push({time:bufferB.end(count),type:"end"})}extents.sort(function(a,b){return a.time-b.time});for(count=0;count<extents.length;count++){if(extents[count].type==="start"){arity++;if(arity===2){start=extents[count].time}}else if(extents[count].type==="end"){arity--;if(arity===1){end=extents[count].time}}if(start!==null&&end!==null){ranges.push([start,end]);start=null;end=null}}return _videoJs2["default"].createTimeRanges(ranges)};var calculateBufferedPercent=function calculateBufferedPercent(segmentRange,buffered){var segmentDuration=segmentRange.end(0)-segmentRange.start(0);var intersection=bufferIntersection(segmentRange,buffered);var overlapDuration=0;var count=intersection.length;while(count--){overlapDuration+=intersection.end(count)-intersection.start(count)}return overlapDuration/segmentDuration*100};exports["default"]={findRange:findRange,findNextRange:findNextRange,findSoleUncommonTimeRangesEnd:findSoleUncommonTimeRangesEnd,calculateBufferedPercent:calculateBufferedPercent,TIME_FUDGE_FACTOR:TIME_FUDGE_FACTOR};module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],15:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _globalDocument=require("global/document");var _globalDocument2=_interopRequireDefault(_globalDocument);var resolveUrl=function resolveUrl(basePath,path){var oldBase=_globalDocument2["default"].querySelector("base");var docHead=_globalDocument2["default"].querySelector("head");var a=_globalDocument2["default"].createElement("a");var base=oldBase;var oldHref=undefined;var result=undefined;if(oldBase){oldHref=oldBase.href}else{base=docHead.appendChild(_globalDocument2["default"].createElement("base"))}base.href=basePath;a.href=path;result=a.href;if(oldBase){oldBase.href=oldHref}else{docHead.removeChild(base)}return result};exports["default"]=resolveUrl;module.exports=exports["default"]},{"global/document":21}],16:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _ranges=require("./ranges");var _ranges2=_interopRequireDefault(_ranges);var _playlist=require("./playlist");var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _sourceUpdater=require("./source-updater");var _sourceUpdater2=_interopRequireDefault(_sourceUpdater);var _decrypter=require("./decrypter");var CHECK_BUFFER_DELAY=500;var GOAL_BUFFER_LENGTH=30;exports.GOAL_BUFFER_LENGTH=GOAL_BUFFER_LENGTH;var updateSegmentMetadata=function updateSegmentMetadata(playlist,segmentIndex,segmentEnd){if(!playlist){return false}var segment=playlist.segments[segmentIndex];var previousSegment=playlist.segments[segmentIndex-1];if(segmentEnd&&segment){segment.end=segmentEnd;if(!previousSegment){segment.duration=segment.end}else if(previousSegment.end){segment.duration=segment.end-previousSegment.end}return true}return false};var detectEndOfStream=function detectEndOfStream(playlist,mediaSource,segmentIndex,currentBuffered){if(!playlist){return false}var segments=playlist.segments;var appendedLastSegment=segmentIndex===segments.length-1;var bufferedToEnd=currentBuffered.length&&segments[segments.length-1].end<=currentBuffered.end(0);return playlist.endList&&mediaSource.readyState==="open"&&(appendedLastSegment||bufferedToEnd)};var byterangeStr=function byterangeStr(byterange){var byterangeStart=undefined;var byterangeEnd=undefined;byterangeEnd=byterange.offset+byterange.length-1;byterangeStart=byterange.offset;return"bytes="+byterangeStart+"-"+byterangeEnd};var segmentXhrHeaders=function segmentXhrHeaders(segment){var headers={};if("byterange"in segment){headers.Range=byterangeStr(segment.byterange)}return headers};var SegmentLoader=function(_videojs$EventTarget){_inherits(SegmentLoader,_videojs$EventTarget);function SegmentLoader(options){_classCallCheck(this,SegmentLoader);_get(Object.getPrototypeOf(SegmentLoader.prototype),"constructor",this).call(this);var settings=undefined;if(!options){throw new TypeError("Initialization options are required")}if(typeof options.currentTime!=="function"){throw new TypeError("No currentTime getter specified")}if(!options.mediaSource){throw new TypeError("No MediaSource specified")}settings=_videoJs2["default"].mergeOptions(_videoJs2["default"].options.hls,options);this.state="INIT";this.bandwidth=settings.bandwidth;this.roundTrip=NaN;this.bytesReceived=0;this.hasPlayed_=settings.hasPlayed;this.currentTime_=settings.currentTime;this.seekable_=settings.seekable;this.seeking_=settings.seeking;this.setCurrentTime_=settings.setCurrentTime;this.mediaSource_=settings.mediaSource;this.withCredentials_=settings.withCredentials;this.checkBufferTimeout_=null;this.error_=void 0;this.expired_=0;this.timeCorrection_=0;this.currentTimeline_=-1;this.xhr_=null;this.pendingSegment_=null;this.sourceUpdater_=null;this.hls_=settings.hls}_createClass(SegmentLoader,[{key:"dispose",value:function dispose(){this.state="DISPOSED";this.abort_();if(this.sourceUpdater_){this.sourceUpdater_.dispose()}}},{key:"abort",value:function abort(){if(this.state!=="WAITING"){return}this.abort_();if(!this.paused()){this.state="READY";this.fillBuffer_()}}},{key:"error",value:function error(_error){if(typeof _error!=="undefined"){this.error_=_error}this.pendingSegment_=null;return this.error_}},{key:"load",value:function load(){this.monitorBuffer_();if(!this.playlist_){return}if(!this.sourceUpdater_||this.state!=="READY"&&this.state!=="INIT"){return}this.state="READY";this.fillBuffer_()}},{key:"playlist",value:function playlist(media){this.playlist_=media;if(this.sourceUpdater_&&media&&this.state==="INIT"&&!this.paused()){this.state="READY";return this.fillBuffer_()}}},{key:"pause",value:function pause(){if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_);this.checkBufferTimeout_=null}}},{key:"paused",value:function paused(){return this.checkBufferTimeout_===null}},{key:"expired",value:function expired(_expired){this.expired_=_expired}},{key:"mimeType",value:function mimeType(_mimeType){if(!this.sourceUpdater_){this.sourceUpdater_=new _sourceUpdater2["default"](this.mediaSource_,_mimeType);this.clearBuffer();if(this.playlist_&&this.state==="INIT"&&!this.paused()){this.state="READY";return this.fillBuffer_()}}}},{key:"monitorBuffer_",value:function monitorBuffer_(){if(this.state==="READY"){this.fillBuffer_()}if(this.checkBufferTimeout_){window.clearTimeout(this.checkBufferTimeout_)}this.checkBufferTimeout_=window.setTimeout(this.monitorBuffer_.bind(this),CHECK_BUFFER_DELAY)}},{key:"getSegmentBufferedPercent_",value:function getSegmentBufferedPercent_(playlist,mediaIndex,currentTime,buffered){var segment=playlist.segments[mediaIndex];var startOfSegment=(0,_playlist.duration)(playlist,playlist.mediaSequence+mediaIndex,this.expired_);var segmentRange=_videoJs2["default"].createTimeRanges([[Math.max(currentTime,startOfSegment),startOfSegment+segment.duration]]);return _ranges2["default"].calculateBufferedPercent(segmentRange,buffered)}},{key:"checkBuffer_",value:function checkBuffer_(buffered,playlist,currentTime){var currentBuffered=_ranges2["default"].findRange(buffered,currentTime);if(currentBuffered.length===0&&currentTime===0){currentBuffered=_ranges2["default"].findRange(buffered,currentTime+_ranges2["default"].TIME_FUDGE_FACTOR)}var bufferedTime=undefined;var currentBufferedEnd=undefined;var timestampOffset=this.sourceUpdater_.timestampOffset();var segment=undefined;var mediaIndex=undefined;if(!playlist.segments.length){return}if(currentBuffered.length===0){mediaIndex=(0,_playlist.getMediaIndexForTime_)(playlist,currentTime+this.timeCorrection_,this.expired_)}else{currentBufferedEnd=currentBuffered.end(0);bufferedTime=Math.max(0,currentBufferedEnd-currentTime);if(!this.hasPlayed_()&&bufferedTime>=1){return null}if(this.hasPlayed_()&&bufferedTime>=GOAL_BUFFER_LENGTH){return null}mediaIndex=(0,_playlist.getMediaIndexForTime_)(playlist,currentBufferedEnd+this.timeCorrection_,this.expired_)}if(mediaIndex<0||mediaIndex===playlist.segments.length){return null}segment=playlist.segments[mediaIndex];var startOfSegment=(0,_playlist.duration)(playlist,playlist.mediaSequence+mediaIndex,this.expired_);if(segment.timeline!==this.currentTimeline_||startOfSegment<this.sourceUpdater_.timestampOffset()){timestampOffset=startOfSegment}return{uri:segment.resolvedUri,mediaIndex:mediaIndex,playlist:playlist,bytes:null,encryptedBytes:null,buffered:null,timestampOffset:timestampOffset,timeline:segment.timeline}}},{key:"abort_",value:function abort_(){if(this.xhr_){this.xhr_.abort()}this.pendingSegment_=null}},{key:"fillBuffer_",value:function fillBuffer_(){if(this.sourceUpdater_.updating()){return}var request=this.checkBuffer_(this.sourceUpdater_.buffered(),this.playlist_,this.currentTime_(),this.timestampOffset_);if(!request){return}var percentBuffered=this.getSegmentBufferedPercent_(this.playlist_,request.mediaIndex,this.currentTime_(),this.sourceUpdater_.buffered());if(percentBuffered>=90){this.incrementTimeCorrection_(this.playlist_.targetDuration);if(!this.paused()){this.fillBuffer_()}return}this.loadSegment_(request)}},{key:"loadSegment_",value:function loadSegment_(segmentInfo){var segment=undefined;var requestTimeout=undefined;var keyXhr=undefined;var segmentXhr=undefined;var seekable=this.seekable_();var currentTime=this.currentTime_();var removeToTime=0;if(seekable.length&&seekable.start(0)>0&&seekable.start(0)<currentTime){removeToTime=seekable.start(0)}else{removeToTime=currentTime-60}if(removeToTime>0){this.sourceUpdater_.remove(0,removeToTime)}segment=segmentInfo.playlist.segments[segmentInfo.mediaIndex];requestTimeout=segment.duration*1.5*1e3;if(segment.key){keyXhr=this.hls_.xhr({uri:segment.key.resolvedUri,responseType:"arraybuffer",withCredentials:this.withCredentials_,timeout:requestTimeout},this.handleResponse_.bind(this))}this.pendingSegment_=segmentInfo;segmentXhr=this.hls_.xhr({uri:segmentInfo.uri,responseType:"arraybuffer",withCredentials:this.withCredentials_,timeout:requestTimeout,headers:segmentXhrHeaders(segment)},this.handleResponse_.bind(this));this.xhr_={keyXhr:keyXhr,segmentXhr:segmentXhr,abort:function abort(){if(this.segmentXhr){this.segmentXhr.onreadystatechange=null;this.segmentXhr.abort();this.segmentXhr=null}if(this.keyXhr){this.keyXhr.onreadystatechange=null;this.keyXhr.abort();this.keyXhr=null}}};this.state="WAITING"}},{key:"handleResponse_",value:function handleResponse_(error,request){var segmentInfo=undefined;var segment=undefined;var keyXhrRequest=undefined;var view=undefined;if(!this.xhr_||request!==this.xhr_.segmentXhr&&request!==this.xhr_.keyXhr){return}segmentInfo=this.pendingSegment_;segment=segmentInfo.playlist.segments[segmentInfo.mediaIndex];if(request.timedout){this.abort_();this.bandwidth=1;this.roundTrip=NaN;this.state="READY";return this.trigger("progress")}if(!request.aborted&&error){keyXhrRequest=this.xhr_.keyXhr;this.abort_();this.error({status:request.status,message:request===keyXhrRequest?"HLS key request error at URL: "+segment.key.uri:"HLS segment request error at URL: "+segmentInfo.uri,code:2,xhr:request});this.state="READY";this.pause();return this.trigger("error")}if(!request.response){this.abort_();return}if(request===this.xhr_.segmentXhr){this.xhr_.segmentXhr=null;this.roundTrip=request.roundTripTime;this.bandwidth=request.bandwidth;this.bytesReceived+=request.bytesReceived||0;if(segment.key){segmentInfo.encryptedBytes=new Uint8Array(request.response)}else{segmentInfo.bytes=new Uint8Array(request.response)}}if(request===this.xhr_.keyXhr){keyXhrRequest=this.xhr_.segmentXhr;this.xhr_.keyXhr=null;if(request.response.byteLength!==16){this.abort_();this.error({status:request.status,message:"Invalid HLS key at URL: "+segment.key.uri,code:2,xhr:request});this.state="READY";this.pause();return this.trigger("error")}view=new DataView(request.response);segment.key.bytes=new Uint32Array([view.getUint32(0),view.getUint32(4),view.getUint32(8),view.getUint32(12)]);segment.key.iv=segment.key.iv||new Uint32Array([0,0,0,segmentInfo.mediaIndex+segmentInfo.playlist.mediaSequence])}if(!this.xhr_.segmentXhr&&!this.xhr_.keyXhr){this.xhr_=null;this.processResponse_()}}},{key:"clearBuffer",value:function clearBuffer(){if(this.sourceUpdater_&&this.sourceUpdater_.buffered().length){this.sourceUpdater_.remove(0,Infinity)}}},{key:"processResponse_",value:function processResponse_(){var segmentInfo=undefined;var segment=undefined;this.state="DECRYPTING";segmentInfo=this.pendingSegment_;segment=segmentInfo.playlist.segments[segmentInfo.mediaIndex];if(segment.key){new _decrypter.Decrypter(segmentInfo.encryptedBytes,segment.key.bytes,segment.key.iv,function(err,bytes){segmentInfo.bytes=bytes;this.handleSegment_()}.bind(this))}else{this.handleSegment_()}}},{key:"handleSegment_",value:function handleSegment_(){var segmentInfo=undefined;this.state="APPENDING";segmentInfo=this.pendingSegment_;segmentInfo.buffered=this.sourceUpdater_.buffered();this.currentTimeline_=segmentInfo.timeline;if(segmentInfo.timestampOffset!==this.sourceUpdater_.timestampOffset()){this.sourceUpdater_.timestampOffset(segmentInfo.timestampOffset)}this.sourceUpdater_.appendBuffer(segmentInfo.bytes,this.handleUpdateEnd_.bind(this))}},{key:"handleUpdateEnd_",value:function handleUpdateEnd_(){var segmentInfo=this.pendingSegment_;var currentTime=this.currentTime_();this.pendingSegment_=null;this.updateTimeline_(segmentInfo);this.trigger("progress");var currentMediaIndex=segmentInfo.mediaIndex;currentMediaIndex+=segmentInfo.playlist.mediaSequence-this.playlist_.mediaSequence;var currentBuffered=_ranges2["default"].findRange(this.sourceUpdater_.buffered(),currentTime);var isEndOfStream=detectEndOfStream(segmentInfo.playlist,this.mediaSource_,currentMediaIndex,currentBuffered);if(isEndOfStream){this.mediaSource_.endOfStream()}var seekable=this.seekable_();var next=_ranges2["default"].findNextRange(this.sourceUpdater_.buffered(),currentTime);if(this.seeking_()&&currentBuffered.length===0){if(seekable.length&&currentTime<seekable.start(0)){if(next.length){_videoJs2["default"].log("tried seeking to",currentTime,"but that was too early, retrying at",next.start(0));this.setCurrentTime_(next.start(0)+_ranges2["default"].TIME_FUDGE_FACTOR)}}}this.state="READY";if(!this.paused()){this.fillBuffer_()}}},{key:"updateTimeline_",value:function updateTimeline_(segmentInfo){var segment=undefined;var segmentEnd=undefined;var timelineUpdated=undefined;var segmentLength=this.playlist_.targetDuration;var playlist=segmentInfo.playlist;var currentMediaIndex=segmentInfo.mediaIndex;currentMediaIndex+=playlist.mediaSequence-this.playlist_.mediaSequence;segment=playlist.segments[currentMediaIndex];if(segment&&segmentInfo&&segmentInfo.playlist.uri===this.playlist_.uri){segmentEnd=_ranges2["default"].findSoleUncommonTimeRangesEnd(segmentInfo.buffered,this.sourceUpdater_.buffered());timelineUpdated=updateSegmentMetadata(playlist,currentMediaIndex,segmentEnd);segmentLength=segment.duration}if(!timelineUpdated){this.incrementTimeCorrection_(segmentLength)}else{this.timeCorrection_=0}}},{key:"incrementTimeCorrection_",value:function incrementTimeCorrection_(secondsToIncrement){if(this.timeCorrection_>=this.playlist_.targetDuration*5){this.timeCorrection_=0;this.pause();return this.trigger("error")}this.timeCorrection_+=secondsToIncrement}}]);return SegmentLoader}(_videoJs2["default"].EventTarget);exports["default"]=SegmentLoader}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./decrypter":5,"./playlist":13,"./ranges":14,"./source-updater":17}],17:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var SourceUpdater=function(){function SourceUpdater(mediaSource,mimeType){var _this=this;_classCallCheck(this,SourceUpdater);var createSourceBuffer=function createSourceBuffer(){_this.sourceBuffer_=mediaSource.addSourceBuffer(mimeType);_this.sourceBuffer_.addEventListener("updateend",function(){var pendingCallback=_this.pendingCallback_;_this.pendingCallback_=null;if(pendingCallback){pendingCallback()}});_this.sourceBuffer_.addEventListener("updateend",_this.runCallback_.bind(_this));_this.runCallback_()};this.callbacks_=[];this.pendingCallback_=null;this.timestampOffset_=0;this.mediaSource=mediaSource;if(mediaSource.readyState==="closed"){mediaSource.addEventListener("sourceopen",createSourceBuffer)}else{createSourceBuffer()}}_createClass(SourceUpdater,[{key:"abort",value:function abort(done){var _this2=this;this.queueCallback_(function(){_this2.sourceBuffer_.abort()},done)}},{key:"appendBuffer",value:function appendBuffer(bytes,done){var _this3=this;this.queueCallback_(function(){_this3.sourceBuffer_.appendBuffer(bytes)},done)}},{key:"buffered",value:function buffered(){if(!this.sourceBuffer_){return _videoJs2["default"].createTimeRanges()}return this.sourceBuffer_.buffered}},{key:"duration",value:function duration(_duration){var _this4=this;this.queueCallback_(function(){_this4.sourceBuffer_.duration=_duration})}},{key:"remove",value:function remove(start,end){var _this5=this;this.queueCallback_(function(){_this5.sourceBuffer_.remove(start,end)})}},{key:"updating",value:function updating(){return!this.sourceBuffer_||this.sourceBuffer_.updating}},{key:"timestampOffset",value:function timestampOffset(offset){var _this6=this;if(typeof offset!=="undefined"){this.queueCallback_(function(){_this6.sourceBuffer_.timestampOffset=offset});this.timestampOffset_=offset}return this.timestampOffset_}},{key:"queueCallback_",value:function queueCallback_(callback,done){this.callbacks_.push([callback.bind(this),done]);this.runCallback_()}},{key:"runCallback_",value:function runCallback_(){var callbacks=undefined;if(this.sourceBuffer_&&!this.sourceBuffer_.updating&&this.callbacks_.length){callbacks=this.callbacks_.shift();this.pendingCallback_=callbacks[1];callbacks[0]()}}},{key:"dispose",value:function dispose(){if(this.sourceBuffer_&&this.mediaSource.readyState==="open"){this.sourceBuffer_.abort()}}}]);return SourceUpdater}();exports["default"]=SourceUpdater;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Stream=function(){function Stream(){_classCallCheck(this,Stream);this.listeners={}}_createClass(Stream,[{key:"on",value:function on(type,listener){if(!this.listeners[type]){this.listeners[type]=[]}this.listeners[type].push(listener)}},{key:"off",value:function off(type,listener){var index=undefined;if(!this.listeners[type]){return false}index=this.listeners[type].indexOf(listener);this.listeners[type].splice(index,1);return index>-1}},{key:"trigger",value:function trigger(type){var callbacks=undefined;var i=undefined;var length=undefined;var args=undefined;callbacks=this.listeners[type];if(!callbacks){return}if(arguments.length===2){length=callbacks.length;for(i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{args=Array.prototype.slice.call(arguments,1);length=callbacks.length;for(i=0;i<length;++i){callbacks[i].apply(this,args)}}}},{key:"dispose",value:function dispose(){this.listeners={}}},{key:"pipe",value:function pipe(destination){this.on("data",function(data){destination.push(data)})}}]);return Stream}();exports["default"]=Stream;module.exports=exports["default"]},{}],19:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var xhrFactory=function xhrFactory(){var xhr=function XhrFunction(options,callback){options=(0,_videoJs.mergeOptions)({timeout:45e3},options);if(XhrFunction.beforeRequest&&typeof XhrFunction.beforeRequest==="function"){var newOptions=XhrFunction.beforeRequest(options);if(newOptions){options=newOptions}}var request=(0,_videoJs.xhr)(options,function(error,response){if(!error&&request.response){request.responseTime=(new Date).getTime();request.roundTripTime=request.responseTime-request.requestTime;request.bytesReceived=request.response.byteLength||request.response.length;if(!request.bandwidth){request.bandwidth=Math.floor(request.bytesReceived/request.roundTripTime*8*1e3)}}if(error||request.timedout){request.timedout=request.timedout||error.code==="ETIMEDOUT"}else{request.timedout=false}if(!error&&response.statusCode!==200&&response.statusCode!==206&&response.statusCode!==0){error=new Error("XHR Failed with a response of: "+(request&&(request.response||request.responseText)))}callback(error,request)});request.requestTime=(new Date).getTime();return request};return xhr};exports["default"]=xhrFactory;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],20:[function(require,module,exports){},{}],21:[function(require,module,exports){(function(global){var topLevel=typeof global!=="undefined"?global:typeof window!=="undefined"?window:{};var minDoc=require("min-document");if(typeof document!=="undefined"){module.exports=document}else{var doccy=topLevel["__GLOBAL_DOCUMENT_CACHE@4"];if(!doccy){doccy=topLevel["__GLOBAL_DOCUMENT_CACHE@4"]=minDoc}module.exports=doccy}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"min-document":20}],22:[function(require,module,exports){"use strict";var PADDING;module.exports=function pad(plaintext){var padding=PADDING[plaintext.byteLength%16||0],result=new Uint8Array(plaintext.byteLength+padding.length);result.set(plaintext);result.set(padding,plaintext.byteLength);return result};PADDING=[[16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16],[15,15,15,15,15,15,15,15,15,15,15,15,15,15,15],[14,14,14,14,14,14,14,14,14,14,14,14,14,14],[13,13,13,13,13,13,13,13,13,13,13,13,13],[12,12,12,12,12,12,12,12,12,12,12,12],[11,11,11,11,11,11,11,11,11,11,11],[10,10,10,10,10,10,10,10,10,10],[9,9,9,9,9,9,9,9,9],[8,8,8,8,8,8,8,8],[7,7,7,7,7,7,7],[6,6,6,6,6,6],[5,5,5,5,5],[4,4,4,4],[3,3,3],[2,2],[1]]},{}],23:[function(require,module,exports){"use strict";exports.pad=require("./pad.js");exports.unpad=require("./unpad.js")},{"./pad.js":22,"./unpad.js":24}],24:[function(require,module,exports){"use strict";module.exports=function unpad(padded){return padded.subarray(0,padded.byteLength-padded[padded.byteLength-1])}},{}],25:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var deprecateOldCue=function deprecateOldCue(cue){Object.defineProperties(cue.frame,{id:{get:function get(){_videoJs2["default"].log.warn("cue.frame.id is deprecated. Use cue.value.key instead.");return cue.value.key}},value:{get:function get(){_videoJs2["default"].log.warn("cue.frame.value is deprecated. Use cue.value.data instead.");return cue.value.data}},privateData:{get:function get(){_videoJs2["default"].log.warn("cue.frame.privateData is deprecated. Use cue.value.data instead.");return cue.value.data}}})};var addTextTrackData=function addTextTrackData(sourceHandler,captionArray,metadataArray){var Cue=window.WebKitDataCue||window.VTTCue;if(captionArray){captionArray.forEach(function(caption){this.inbandTextTrack_.addCue(new Cue(caption.startTime+this.timestampOffset,caption.endTime+this.timestampOffset,caption.text))},sourceHandler)}if(metadataArray){metadataArray.forEach(function(metadata){var time=metadata.cueTime+this.timestampOffset;metadata.frames.forEach(function(frame){var cue=new Cue(time,time,frame.value||frame.url||frame.data||"");cue.frame=frame;cue.value=frame;deprecateOldCue(cue);this.metadataTrack_.addCue(cue)},this)},sourceHandler)}};exports["default"]=addTextTrackData;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],26:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var isAudioCodec=function isAudioCodec(codec){return/mp4a\.\d+.\d+/i.test(codec)};var isVideoCodec=function isVideoCodec(codec){return/avc1\.[\da-f]+/i.test(codec)};var parseContentType=function parseContentType(type){var object={type:"",parameters:{}};var parameters=type.trim().split(";");object.type=parameters.shift().trim();parameters.forEach(function(parameter){var pair=parameter.trim().split("=");if(pair.length>1){var _name=pair[0].replace(/"/g,"").trim();var value=pair[1].replace(/"/g,"").trim();object.parameters[_name]=value}});return object};exports["default"]={isAudioCodec:isAudioCodec,parseContentType:parseContentType,isVideoCodec:isVideoCodec};module.exports=exports["default"]},{}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var createTextTracksIfNecessary=function createTextTracksIfNecessary(sourceBuffer,mediaSource,segment){if(segment.captions&&segment.captions.length&&!sourceBuffer.inbandTextTrack_){sourceBuffer.inbandTextTrack_=mediaSource.player_.addTextTrack("captions","cc1")}if(segment.metadata&&segment.metadata.length&&!sourceBuffer.metadataTrack_){sourceBuffer.metadataTrack_=mediaSource.player_.addTextTrack("metadata","Timed Metadata");sourceBuffer.metadataTrack_.inBandMetadataTrackDispatchType=segment.metadata.dispatchType}};exports["default"]=createTextTracksIfNecessary;module.exports=exports["default"]},{}],28:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var flashConstants={TIME_BETWEEN_TICKS:Math.floor(1e3/480),TIME_PER_TICK:Math.floor(1e3/240),BYTES_PER_CHUNK:1*1024,MIN_CHUNK:1024,MAX_CHUNK:1024*1024};exports["default"]=flashConstants;module.exports=exports["default"]},{}],29:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,
writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _flashSourceBuffer=require("./flash-source-buffer");var _flashSourceBuffer2=_interopRequireDefault(_flashSourceBuffer);var _flashConstants=require("./flash-constants");var _flashConstants2=_interopRequireDefault(_flashConstants);var _codecUtils=require("./codec-utils");var FlashMediaSource=function(_videojs$EventTarget){_inherits(FlashMediaSource,_videojs$EventTarget);function FlashMediaSource(){var _this=this;_classCallCheck(this,FlashMediaSource);_get(Object.getPrototypeOf(FlashMediaSource.prototype),"constructor",this).call(this);this.sourceBuffers=[];this.readyState="closed";this.on(["sourceopen","webkitsourceopen"],function(event){_this.swfObj=document.getElementById(event.swfId);_this.player_=(0,_videoJs2["default"])(_this.swfObj.parentNode);_this.tech_=_this.swfObj.tech;_this.readyState="open";_this.tech_.on("seeking",function(){var i=_this.sourceBuffers.length;while(i--){_this.sourceBuffers[i].abort()}});if(_this.swfObj){_this.swfObj.vjs_load()}})}_createClass(FlashMediaSource,[{key:"addSeekableRange_",value:function addSeekableRange_(){}},{key:"addSourceBuffer",value:function addSourceBuffer(type){var parsedType=(0,_codecUtils.parseContentType)(type);var sourceBuffer=undefined;if(parsedType.type==="video/mp2t"){sourceBuffer=new _flashSourceBuffer2["default"](this)}else{throw new Error("NotSupportedError (Video.js)")}this.sourceBuffers.push(sourceBuffer);return sourceBuffer}},{key:"endOfStream",value:function endOfStream(error){if(error==="network"){this.tech_.error(2)}else if(error==="decode"){this.tech_.error(3)}if(this.readyState!=="ended"){this.readyState="ended";this.swfObj.vjs_endOfStream()}}}]);return FlashMediaSource}(_videoJs2["default"].EventTarget);exports["default"]=FlashMediaSource;try{Object.defineProperty(FlashMediaSource.prototype,"duration",{get:function get(){if(!this.swfObj){return NaN}return this.swfObj.vjs_getProperty("duration")},set:function set(value){var i=undefined;var oldDuration=this.swfObj.vjs_getProperty("duration");this.swfObj.vjs_setProperty("duration",value);if(value<oldDuration){for(i=0;i<this.sourceBuffers.length;i++){this.sourceBuffers[i].remove(value,oldDuration)}}return value}})}catch(e){FlashMediaSource.prototype.duration=NaN}for(var property in _flashConstants2["default"]){FlashMediaSource[property]=_flashConstants2["default"][property]}module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./codec-utils":26,"./flash-constants":28,"./flash-source-buffer":30}],30:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _muxJs=require("mux.js");var _muxJs2=_interopRequireDefault(_muxJs);var _removeCuesFromTrack=require("./remove-cues-from-track");var _removeCuesFromTrack2=_interopRequireDefault(_removeCuesFromTrack);var _createTextTracksIfNecessary=require("./create-text-tracks-if-necessary");var _createTextTracksIfNecessary2=_interopRequireDefault(_createTextTracksIfNecessary);var _addTextTrackData=require("./add-text-track-data");var _addTextTrackData2=_interopRequireDefault(_addTextTrackData);var _flashConstants=require("./flash-constants");var _flashConstants2=_interopRequireDefault(_flashConstants);var scheduleTick=function scheduleTick(func){window.setTimeout(func,_flashConstants2["default"].TIME_BETWEEN_TICKS)};var toDecimalPlaces=function toDecimalPlaces(num,places){if(typeof places!=="number"||places<0){places=0}var scale=Math.pow(10,places);return Math.round(num*scale)/scale};var FlashSourceBuffer=function(_videojs$EventTarget){_inherits(FlashSourceBuffer,_videojs$EventTarget);function FlashSourceBuffer(mediaSource){var _this=this;_classCallCheck(this,FlashSourceBuffer);_get(Object.getPrototypeOf(FlashSourceBuffer.prototype),"constructor",this).call(this);var encodedHeader=undefined;this.chunkSize_=_flashConstants2["default"].BYTES_PER_CHUNK;this.buffer_=[];this.bufferSize_=0;this.basePtsOffset_=NaN;this.mediaSource=mediaSource;this.updating=false;this.timestampOffset_=0;this.segmentParser_=new _muxJs2["default"].flv.Transmuxer;this.segmentParser_.on("data",this.receiveBuffer_.bind(this));encodedHeader=window.btoa(String.fromCharCode.apply(null,Array.prototype.slice.call(this.segmentParser_.getFlvHeader())));this.mediaSource.swfObj.vjs_appendBuffer(encodedHeader);Object.defineProperty(this,"timestampOffset",{get:function get(){return this.timestampOffset_},set:function set(val){if(typeof val==="number"&&val>=0){this.timestampOffset_=val;this.segmentParser_=new _muxJs2["default"].flv.Transmuxer;this.segmentParser_.on("data",this.receiveBuffer_.bind(this));this.mediaSource.swfObj.vjs_discontinuity();this.basePtsOffset_=NaN}}});Object.defineProperty(this,"buffered",{get:function get(){if(!this.mediaSource||!this.mediaSource.swfObj||!("vjs_getProperty"in this.mediaSource.swfObj)){return _videoJs2["default"].createTimeRange()}var buffered=this.mediaSource.swfObj.vjs_getProperty("buffered");if(buffered&&buffered.length){buffered[0][0]=toDecimalPlaces(buffered[0][0],3);buffered[0][1]=toDecimalPlaces(buffered[0][1],3)}return _videoJs2["default"].createTimeRanges(buffered)}});this.mediaSource.player_.on("seeked",function(){(0,_removeCuesFromTrack2["default"])(0,Infinity,_this.metadataTrack_);(0,_removeCuesFromTrack2["default"])(0,Infinity,_this.inbandTextTrack_)})}_createClass(FlashSourceBuffer,[{key:"appendBuffer",value:function appendBuffer(bytes){var _this2=this;var error=undefined;var chunk=512*1024;var i=0;if(this.updating){error=new Error("SourceBuffer.append() cannot be called "+"while an update is in progress");error.name="InvalidStateError";error.code=11;throw error}this.updating=true;this.mediaSource.readyState="open";this.trigger({type:"update"});var chunkInData=function chunkInData(){_this2.segmentParser_.push(bytes.subarray(i,i+chunk));i+=chunk;if(i<bytes.byteLength){scheduleTick(chunkInData)}else{scheduleTick(_this2.segmentParser_.flush.bind(_this2.segmentParser_))}};chunkInData()}},{key:"abort",value:function abort(){this.buffer_=[];this.bufferSize_=0;this.mediaSource.swfObj.vjs_abort();if(this.updating){this.updating=false;this.trigger({type:"updateend"})}}},{key:"remove",value:function remove(start,end){(0,_removeCuesFromTrack2["default"])(start,end,this.metadataTrack_);(0,_removeCuesFromTrack2["default"])(start,end,this.inbandTextTrack_);this.trigger({type:"update"});this.trigger({type:"updateend"})}},{key:"receiveBuffer_",value:function receiveBuffer_(segment){var _this3=this;(0,_createTextTracksIfNecessary2["default"])(this,this.mediaSource,segment);(0,_addTextTrackData2["default"])(this,segment.captions,segment.metadata);scheduleTick(function(){var flvBytes=_this3.convertTagsToData_(segment);if(_this3.buffer_.length===0){scheduleTick(_this3.processBuffer_.bind(_this3))}if(flvBytes){_this3.buffer_.push(flvBytes);_this3.bufferSize_+=flvBytes.byteLength}})}},{key:"processBuffer_",value:function processBuffer_(){var chunk=undefined;var i=undefined;var length=undefined;var binary=undefined;var b64str=undefined;var startByte=0;var appendIterations=0;var startTime=+new Date;var appendTime=undefined;if(!this.buffer_.length){if(this.updating!==false){this.updating=false;this.trigger({type:"updateend"})}return}do{appendIterations++;chunk=this.buffer_[0].subarray(startByte,startByte+this.chunkSize_);if(chunk.byteLength<this.chunkSize_||this.buffer_[0].byteLength===startByte+this.chunkSize_){startByte=0;this.buffer_.shift()}else{startByte+=this.chunkSize_}this.bufferSize_-=chunk.byteLength;binary="";length=chunk.byteLength;for(i=0;i<length;i++){binary+=String.fromCharCode(chunk[i])}b64str=window.btoa(binary);this.mediaSource.swfObj.CallFunction('<invoke name="vjs_appendBuffer"'+'returntype="javascript"><arguments><string>'+b64str+"</string></arguments></invoke>");appendTime=new Date-startTime}while(this.buffer_.length&&appendTime<_flashConstants2["default"].TIME_PER_TICK);if(this.buffer_.length&&startByte){this.buffer_[0]=this.buffer_[0].subarray(startByte)}if(appendTime>=_flashConstants2["default"].TIME_PER_TICK){this.chunkSize_=Math.floor(this.chunkSize_*(appendIterations/4))}this.chunkSize_=Math.max(_flashConstants2["default"].MIN_CHUNK,Math.min(this.chunkSize_,_flashConstants2["default"].MAX_CHUNK));if(this.bufferSize_!==0){scheduleTick(this.processBuffer_.bind(this))}else{this.updating=false;this.trigger({type:"updateend"})}}},{key:"convertTagsToData_",value:function convertTagsToData_(segmentData){var segmentByteLength=0;var tech=this.mediaSource.tech_;var targetPts=0;var i=undefined;var j=undefined;var segment=undefined;var filteredTags=[];var tags=this.getOrderedTags_(segmentData);if(isNaN(this.basePtsOffset_)&&tags.length){this.basePtsOffset_=tags[0].pts}if(tech.buffered().length){targetPts=tech.buffered().end(0)-this.timestampOffset}targetPts=Math.max(targetPts,tech.currentTime()-this.timestampOffset);targetPts*=1e3;targetPts+=this.basePtsOffset_;for(i=0;i<tags.length;i++){if(tags[i].pts>=targetPts){filteredTags.push(tags[i])}}if(filteredTags.length===0){return}for(i=0;i<filteredTags.length;i++){segmentByteLength+=filteredTags[i].bytes.byteLength}segment=new Uint8Array(segmentByteLength);for(i=0,j=0;i<filteredTags.length;i++){segment.set(filteredTags[i].bytes,j);j+=filteredTags[i].bytes.byteLength}return segment}},{key:"getOrderedTags_",value:function getOrderedTags_(segmentData){var videoTags=segmentData.tags.videoTags;var audioTags=segmentData.tags.audioTags;var tag=undefined;var tags=[];while(videoTags.length||audioTags.length){if(!videoTags.length){tag=audioTags.shift()}else if(!audioTags.length){tag=videoTags.shift()}else if(audioTags[0].dts<videoTags[0].dts){tag=audioTags.shift()}else{tag=videoTags.shift()}tags.push(tag.finalize())}return tags}}]);return FlashSourceBuffer}(_videoJs2["default"].EventTarget);exports["default"]=FlashSourceBuffer;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./add-text-track-data":25,"./create-text-tracks-if-necessary":27,"./flash-constants":28,"./remove-cues-from-track":32,"mux.js":43}],31:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _virtualSourceBuffer=require("./virtual-source-buffer");var _virtualSourceBuffer2=_interopRequireDefault(_virtualSourceBuffer);var _codecUtils=require("./codec-utils");var translateLegacyCodecs=function translateLegacyCodecs(codecs){return codecs.map(function(codec){return codec.replace(/avc1\.(\d+)\.(\d+)/i,function(orig,profile,avcLevel){var profileHex=("00"+Number(profile).toString(16)).slice(-2);var avcLevelHex=("00"+Number(avcLevel).toString(16)).slice(-2);return"avc1."+profileHex+"00"+avcLevelHex})})};var HtmlMediaSource=function(_videojs$EventTarget){_inherits(HtmlMediaSource,_videojs$EventTarget);function HtmlMediaSource(){var _this=this;_classCallCheck(this,HtmlMediaSource);_get(Object.getPrototypeOf(HtmlMediaSource.prototype),"constructor",this).call(this);var property=undefined;this.nativeMediaSource_=new window.MediaSource;for(property in this.nativeMediaSource_){if(!(property in HtmlMediaSource.prototype)&&typeof this.nativeMediaSource_[property]==="function"){this[property]=this.nativeMediaSource_[property].bind(this.nativeMediaSource_)}}this.duration_=NaN;Object.defineProperty(this,"duration",{get:function get(){if(this.duration_===Infinity){return this.duration_}return this.nativeMediaSource_.duration},set:function set(duration){this.duration_=duration;if(duration!==Infinity){this.nativeMediaSource_.duration=duration;return}}});Object.defineProperty(this,"seekable",{get:function get(){if(this.duration_===Infinity){return _videoJs2["default"].createTimeRanges([[0,this.nativeMediaSource_.duration]])}return this.nativeMediaSource_.seekable}});Object.defineProperty(this,"readyState",{get:function get(){return this.nativeMediaSource_.readyState}});Object.defineProperty(this,"activeSourceBuffers",{get:function get(){return this.activeSourceBuffers_}});this.sourceBuffers=[];this.activeSourceBuffers_=[];this.updateActiveSourceBuffers_=function(){_this.activeSourceBuffers_.length=0;var combined=false;var audioOnly=true;for(var i=0;i<_this.player_.audioTracks().length;i++){var track=_this.player_.audioTracks()[i];if(track.enabled&&track.kind!=="main"){combined=true;audioOnly=false;break}}_this.sourceBuffers.forEach(function(sourceBuffer){if(sourceBuffer.videoCodec_&&sourceBuffer.audioCodec_){sourceBuffer.audioDisabled_=combined}else if(sourceBuffer.videoCodec_&&!sourceBuffer.audioCodec_){sourceBuffer.audioDisabled_=true;audioOnly=false}else if(!sourceBuffer.videoCodec_&&sourceBuffer.audioCodec_){sourceBuffer.audioDisabled_=audioOnly;if(audioOnly){return}}_this.activeSourceBuffers_.push(sourceBuffer)})};["sourceopen","sourceclose","sourceended"].forEach(function(eventName){this.nativeMediaSource_.addEventListener(eventName,this.trigger.bind(this))},this);this.on("sourceopen",function(event){var video=document.querySelector('[src="'+_this.url_+'"]');if(!video){return}_this.player_=(0,_videoJs2["default"])(video.parentNode);if(_this.player_.audioTracks&&_this.player_.audioTracks()){_this.player_.audioTracks().on("change",_this.updateActiveSourceBuffers_);_this.player_.audioTracks().on("addtrack",_this.updateActiveSourceBuffers_);_this.player_.audioTracks().on("removetrack",_this.updateActiveSourceBuffers_)}});this.on("sourceclose",function(event){this.sourceBuffers.forEach(function(sourceBuffer){if(sourceBuffer.transmuxer_){sourceBuffer.transmuxer_.terminate()}});this.sourceBuffers.length=0;if(!this.player_){return}if(this.player_.audioTracks&&this.player_.audioTracks()){this.player_.audioTracks().off("change",this.updateActiveSourceBuffers_);this.player_.audioTracks().off("addtrack",this.updateActiveSourceBuffers_);this.player_.audioTracks().off("removetrack",this.updateActiveSourceBuffers_)}})}_createClass(HtmlMediaSource,[{key:"addSeekableRange_",value:function addSeekableRange_(start,end){var error=undefined;if(this.duration!==Infinity){error=new Error("MediaSource.addSeekableRange() can only be invoked "+"when the duration is Infinity");error.name="InvalidStateError";error.code=11;throw error}if(end>this.nativeMediaSource_.duration||isNaN(this.nativeMediaSource_.duration)){this.nativeMediaSource_.duration=end}}},{key:"addSourceBuffer",value:function addSourceBuffer(type){var buffer=undefined;var parsedType=(0,_codecUtils.parseContentType)(type);if(parsedType.type==="video/mp2t"){var codecs=[];if(parsedType.parameters&&parsedType.parameters.codecs){codecs=parsedType.parameters.codecs.split(",");codecs=translateLegacyCodecs(codecs);codecs=codecs.filter(function(codec){return(0,_codecUtils.isAudioCodec)(codec)||(0,_codecUtils.isVideoCodec)(codec)})}if(codecs.length===0){codecs=["avc1.4d400d","mp4a.40.2"]}buffer=new _virtualSourceBuffer2["default"](this,codecs);if(this.sourceBuffers.length!==0){this.sourceBuffers[0].createRealSourceBuffers_();buffer.createRealSourceBuffers_();this.sourceBuffers[0].audioDisabled_=true}}else{buffer=this.nativeMediaSource_.addSourceBuffer(type)}this.sourceBuffers.push(buffer);return buffer}}]);return HtmlMediaSource}(_videoJs2["default"].EventTarget);exports["default"]=HtmlMediaSource;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./codec-utils":26,"./virtual-source-buffer":35}],32:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var removeCuesFromTrack=function removeCuesFromTrack(start,end,track){var i=undefined;var cue=undefined;if(!track){return}i=track.cues.length;while(i--){cue=track.cues[i];if(cue.startTime<=end&&cue.endTime>=start){track.removeCue(cue)}}};exports["default"]=removeCuesFromTrack;module.exports=exports["default"]},{}],33:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _muxJs=require("mux.js");var _muxJs2=_interopRequireDefault(_muxJs);var wireTransmuxerEvents=function wireTransmuxerEvents(transmuxer){transmuxer.on("data",function(segment){var typedArray=segment.data;segment.data=typedArray.buffer;postMessage({action:"data",segment:segment,byteOffset:typedArray.byteOffset,byteLength:typedArray.byteLength},[segment.data])});if(transmuxer.captionStream){transmuxer.captionStream.on("data",function(caption){postMessage({action:"caption",data:caption})})}transmuxer.on("done",function(data){postMessage({action:"done"})})};var MessageHandlers=function(){function MessageHandlers(options){_classCallCheck(this,MessageHandlers);this.options=options||{};this.init()}_createClass(MessageHandlers,[{key:"init",value:function init(){if(this.transmuxer){this.transmuxer.dispose()}this.transmuxer=new _muxJs2["default"].mp4.Transmuxer(this.options);wireTransmuxerEvents(this.transmuxer)}},{key:"push",value:function push(data){var segment=new Uint8Array(data.data,data.byteOffset,data.byteLength);this.transmuxer.push(segment)}},{key:"reset",value:function reset(){this.init()}},{key:"setTimestampOffset",value:function setTimestampOffset(data){var timestampOffset=data.timestampOffset||0;this.transmuxer.setBaseMediaDecodeTime(Math.round(timestampOffset*9e4))}},{key:"flush",value:function flush(data){this.transmuxer.flush()}}]);return MessageHandlers}();var Worker=function Worker(self){self.onmessage=function(event){if(event.data.action==="init"&&event.data.options){this.messageHandlers=new MessageHandlers(event.data.options);return}if(!this.messageHandlers){this.messageHandlers=new MessageHandlers}if(event.data&&event.data.action&&event.data.action!=="init"){if(this.messageHandlers[event.data.action]){this.messageHandlers[event.data.action](event.data)}}}};exports["default"]=function(self){return new Worker(self)};module.exports=exports["default"]},{"mux.js":43}],34:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _flashMediaSource=require("./flash-media-source");var _flashMediaSource2=_interopRequireDefault(_flashMediaSource);var _htmlMediaSource=require("./html-media-source");var _htmlMediaSource2=_interopRequireDefault(_htmlMediaSource);var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var urlCount=0;var defaults={mode:"auto"};_videoJs2["default"].mediaSources={};var open=function open(msObjectURL,swfId){var mediaSource=_videoJs2["default"].mediaSources[msObjectURL];if(mediaSource){mediaSource.trigger({type:"sourceopen",swfId:swfId})}else{throw new Error("Media Source not found (Video.js)")}};var supportsNativeMediaSources=function supportsNativeMediaSources(){return!!window.MediaSource&&!!window.MediaSource.isTypeSupported&&window.MediaSource.isTypeSupported('video/mp4;codecs="avc1.4d400d,mp4a.40.2"')};var MediaSource=function MediaSource(options){var settings=_videoJs2["default"].mergeOptions(defaults,options);this.MediaSource={open:open,supportsNativeMediaSources:supportsNativeMediaSources};if(settings.mode==="html5"||settings.mode==="auto"&&supportsNativeMediaSources()){return new _htmlMediaSource2["default"]}return new _flashMediaSource2["default"]};exports.MediaSource=MediaSource;MediaSource.open=open;MediaSource.supportsNativeMediaSources=supportsNativeMediaSources;var URL={createObjectURL:function createObjectURL(object){var objectUrlPrefix="blob:vjs-media-source/";var url=undefined;if(object instanceof _htmlMediaSource2["default"]){url=window.URL.createObjectURL(object.nativeMediaSource_);object.url_=url;return url}if(!(object instanceof _flashMediaSource2["default"])){url=window.URL.createObjectURL(object);object.url_=url;return url}url=objectUrlPrefix+urlCount;urlCount++;_videoJs2["default"].mediaSources[url]=object;return url}};exports.URL=URL;_videoJs2["default"].MediaSource=MediaSource;_videoJs2["default"].URL=URL}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./flash-media-source":29,"./html-media-source":31}],35:[function(require,module,exports){(function(global){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _createTextTracksIfNecessary=require("./create-text-tracks-if-necessary");var _createTextTracksIfNecessary2=_interopRequireDefault(_createTextTracksIfNecessary);var _removeCuesFromTrack=require("./remove-cues-from-track");var _removeCuesFromTrack2=_interopRequireDefault(_removeCuesFromTrack);var _addTextTrackData=require("./add-text-track-data");var _addTextTrackData2=_interopRequireDefault(_addTextTrackData);var _webworkify=require("webworkify");var _webworkify2=_interopRequireDefault(_webworkify);var _transmuxerWorker=require("./transmuxer-worker");var _transmuxerWorker2=_interopRequireDefault(_transmuxerWorker);var _codecUtils=require("./codec-utils");var VirtualSourceBuffer=function(_videojs$EventTarget){_inherits(VirtualSourceBuffer,_videojs$EventTarget);function VirtualSourceBuffer(mediaSource,codecs){var _this=this;_classCallCheck(this,VirtualSourceBuffer);_get(Object.getPrototypeOf(VirtualSourceBuffer.prototype),"constructor",this).call(this,_videoJs2["default"].EventTarget);this.timestampOffset_=0;this.pendingBuffers_=[];this.bufferUpdating_=false;this.mediaSource_=mediaSource;this.codecs_=codecs;this.audioCodec_=null;this.videoCodec_=null;this.audioDisabled_=false;var options={remux:false};this.codecs_.forEach(function(codec){if((0,_codecUtils.isAudioCodec)(codec)){_this.audioCodec_=codec}else if((0,_codecUtils.isVideoCodec)(codec)){_this.videoCodec_=codec}});this.transmuxer_=(0,_webworkify2["default"])(_transmuxerWorker2["default"]);this.transmuxer_.postMessage({action:"init",options:options});this.transmuxer_.onmessage=function(event){if(event.data.action==="data"){return _this.data_(event)}if(event.data.action==="done"){return _this.done_(event)}};Object.defineProperty(this,"timestampOffset",{get:function get(){return this.timestampOffset_},set:function set(val){if(typeof val==="number"&&val>=0){this.timestampOffset_=val;this.transmuxer_.postMessage({action:"setTimestampOffset",timestampOffset:val})}}});Object.defineProperty(this,"appendWindowStart",{get:function get(){return(this.videoBuffer_||this.audioBuffer_).appendWindowStart},set:function set(start){if(this.videoBuffer_){this.videoBuffer_.appendWindowStart=start}if(this.audioBuffer_){this.audioBuffer_.appendWindowStart=start}}});Object.defineProperty(this,"updating",{get:function get(){return!!(this.bufferUpdating_||!this.audioDisabled_&&this.audioBuffer_&&this.audioBuffer_.updating||this.videoBuffer_&&this.videoBuffer_.updating)}});Object.defineProperty(this,"buffered",{get:function get(){var start=null;var end=null;var arity=0;var extents=[];var ranges=[];if(!this.videoBuffer_&&(this.audioDisabled_||!this.audioBuffer_)){return _videoJs2["default"].createTimeRange()}if(!this.videoBuffer_){return this.audioBuffer_.buffered}else if(this.audioDisabled_||!this.audioBuffer_){return this.videoBuffer_.buffered}if((!this.videoBuffer_||this.videoBuffer_.buffered.length===0)&&(!this.audioBuffer_||this.audioBuffer_.buffered.length===0)){return _videoJs2["default"].createTimeRange()}var videoBuffered=this.videoBuffer_.buffered;var audioBuffered=this.audioBuffer_.buffered;var count=videoBuffered.length;while(count--){extents.push({time:videoBuffered.start(count),type:"start"});extents.push({time:videoBuffered.end(count),type:"end"})}count=audioBuffered.length;while(count--){extents.push({time:audioBuffered.start(count),type:"start"});extents.push({time:audioBuffered.end(count),type:"end"})}extents.sort(function(a,b){return a.time-b.time});for(count=0;count<extents.length;count++){if(extents[count].type==="start"){arity++;if(arity===2){start=extents[count].time}}else if(extents[count].type==="end"){arity--;if(arity===1){end=extents[count].time}}if(start!==null&&end!==null){ranges.push([start,end]);start=null;end=null}}return _videoJs2["default"].createTimeRanges(ranges)}})}_createClass(VirtualSourceBuffer,[{key:"data_",value:function data_(event){var segment=event.data.segment;segment.data=new Uint8Array(segment.data,event.data.byteOffset,event.data.byteLength);(0,_createTextTracksIfNecessary2["default"])(this,this.mediaSource_,segment);this.pendingBuffers_.push(segment);return}},{key:"done_",value:function done_(event){this.processPendingSegments_();return}},{key:"createRealSourceBuffers_",value:function createRealSourceBuffers_(){var _this2=this;var types=["audio","video"];types.forEach(function(type){if(!_this2[type+"Codec_"]){return}if(_this2[type+"Buffer_"]){return}var buffer=null;if(_this2.mediaSource_[type+"Buffer_"]){buffer=_this2.mediaSource_[type+"Buffer_"]}else{buffer=_this2.mediaSource_.nativeMediaSource_.addSourceBuffer(type+'/mp4;codecs="'+_this2[type+"Codec_"]+'"');_this2.mediaSource_[type+"Buffer_"]=buffer}_this2[type+"Buffer_"]=buffer;["update","updatestart","updateend"].forEach(function(event){buffer.addEventListener(event,function(){if(type==="audio"&&_this2.audioDisabled_){return}
var shouldTrigger=types.every(function(t){if(t==="audio"&&_this2.audioDisabled_){return true}if(type!==t&&_this2[t+"Buffer_"]&&_this2[t+"Buffer_"].updating){return false}return true});if(shouldTrigger){return _this2.trigger(event)}})})})}},{key:"appendBuffer",value:function appendBuffer(segment){this.bufferUpdating_=true;this.transmuxer_.postMessage({action:"push",data:segment.buffer,byteOffset:segment.byteOffset,byteLength:segment.byteLength},[segment.buffer]);this.transmuxer_.postMessage({action:"flush"})}},{key:"remove",value:function remove(start,end){if(this.videoBuffer_){this.videoBuffer_.remove(start,end)}if(!this.audioDisabled_&&this.audioBuffer_){this.audioBuffer_.remove(start,end)}(0,_removeCuesFromTrack2["default"])(start,end,this.metadataTrack_);(0,_removeCuesFromTrack2["default"])(start,end,this.inbandTextTrack_)}},{key:"processPendingSegments_",value:function processPendingSegments_(){var sortedSegments={video:{segments:[],bytes:0},audio:{segments:[],bytes:0},captions:[],metadata:[]};sortedSegments=this.pendingBuffers_.reduce(function(segmentObj,segment){var type=segment.type;var data=segment.data;segmentObj[type].segments.push(data);segmentObj[type].bytes+=data.byteLength;if(segment.captions){segmentObj.captions=segmentObj.captions.concat(segment.captions)}if(segment.info){segmentObj[type].info=segment.info}if(segment.metadata){segmentObj.metadata=segmentObj.metadata.concat(segment.metadata)}return segmentObj},sortedSegments);if(!this.videoBuffer_&&!this.audioBuffer_){if(sortedSegments.video.bytes===0){this.videoCodec_=null}if(sortedSegments.audio.bytes===0){this.audioCodec_=null}this.createRealSourceBuffers_()}if(sortedSegments.audio.info){this.mediaSource_.trigger({type:"audioinfo",info:sortedSegments.audio.info})}if(sortedSegments.video.info){this.mediaSource_.trigger({type:"videoinfo",info:sortedSegments.video.info})}if(this.videoBuffer_){this.concatAndAppendSegments_(sortedSegments.video,this.videoBuffer_);(0,_addTextTrackData2["default"])(this,sortedSegments.captions,sortedSegments.metadata)}if(!this.audioDisabled_&&this.audioBuffer_){this.concatAndAppendSegments_(sortedSegments.audio,this.audioBuffer_)}this.pendingBuffers_.length=0;this.bufferUpdating_=false}},{key:"concatAndAppendSegments_",value:function concatAndAppendSegments_(segmentObj,destinationBuffer){var offset=0;var tempBuffer=undefined;if(segmentObj.bytes){tempBuffer=new Uint8Array(segmentObj.bytes);segmentObj.segments.forEach(function(segment){tempBuffer.set(segment,offset);offset+=segment.byteLength});destinationBuffer.appendBuffer(tempBuffer)}}},{key:"abort",value:function abort(){if(this.videoBuffer_){this.videoBuffer_.abort()}if(this.audioBuffer_){this.audioBuffer_.abort()}if(this.transmuxer_){this.transmuxer_.postMessage({action:"reset"})}this.pendingBuffers_.length=0;this.bufferUpdating_=false}}]);return VirtualSourceBuffer}(_videoJs2["default"].EventTarget);exports["default"]=VirtualSourceBuffer;module.exports=exports["default"]}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./add-text-track-data":25,"./codec-utils":26,"./create-text-tracks-if-necessary":27,"./remove-cues-from-track":32,"./transmuxer-worker":33,webworkify:56}],36:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js");var AacStream;AacStream=function(){var everything=new Uint8Array,receivedTimeStamp=false,timeStamp=0;AacStream.prototype.init.call(this);this.setTimestamp=function(timestamp){timeStamp=timestamp};this.parseId3TagSize=function(header,byteIndex){var returnSize=header[byteIndex+6]<<21|header[byteIndex+7]<<14|header[byteIndex+8]<<7|header[byteIndex+9],flags=header[byteIndex+5],footerPresent=(flags&16)>>4;if(footerPresent){return returnSize+20}return returnSize+10};this.parseAdtsSize=function(header,byteIndex){var lowThree=(header[byteIndex+5]&224)>>5,middle=header[byteIndex+4]<<3,highTwo=header[byteIndex+3]&3<<11;return highTwo|middle|lowThree};this.push=function(bytes){var frameSize=0,byteIndex=0,bytesLeft,chunk,packet,tempLength;if(everything.length){tempLength=everything.length;everything=new Uint8Array(bytes.byteLength+tempLength);everything.set(everything.subarray(0,tempLength));everything.set(bytes,tempLength)}else{everything=bytes}while(everything.length-byteIndex>=3){if(everything[byteIndex]==="I".charCodeAt(0)&&everything[byteIndex+1]==="D".charCodeAt(0)&&everything[byteIndex+2]==="3".charCodeAt(0)){if(everything.length-byteIndex<10){break}frameSize=this.parseId3TagSize(everything,byteIndex);if(frameSize>everything.length){break}chunk={type:"timed-metadata",data:everything.subarray(byteIndex,byteIndex+frameSize)};this.trigger("data",chunk);byteIndex+=frameSize;continue}else if(everything[byteIndex]&255===255&&(everything[byteIndex+1]&240)===240){if(everything.length-byteIndex<7){break}frameSize=this.parseAdtsSize(everything,byteIndex);if(frameSize>everything.length){break}packet={type:"audio",data:everything.subarray(byteIndex,byteIndex+frameSize),pts:timeStamp,dts:timeStamp};this.trigger("data",packet);byteIndex+=frameSize;continue}byteIndex++}bytesLeft=everything.length-byteIndex;if(bytesLeft>0){everything=everything.subarray(byteIndex)}else{everything=new Uint8Array}}};AacStream.prototype=new Stream;module.exports=AacStream},{"../utils/stream.js":55}],37:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js");var AdtsStream;var ADTS_SAMPLING_FREQUENCIES=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];AdtsStream=function(){var self,buffer;AdtsStream.prototype.init.call(this);self=this;this.push=function(packet){var i=0,frameNum=0,frameLength,protectionSkipBytes,frameEnd,oldBuffer,numFrames,sampleCount,adtsFrameDuration;if(packet.type!=="audio"){return}if(buffer){oldBuffer=buffer;buffer=new Uint8Array(oldBuffer.byteLength+packet.data.byteLength);buffer.set(oldBuffer);buffer.set(packet.data,oldBuffer.byteLength)}else{buffer=packet.data}while(i+5<buffer.length){if(buffer[i]!==255||(buffer[i+1]&246)!==240){i++;continue}protectionSkipBytes=(~buffer[i+1]&1)*2;frameLength=(buffer[i+3]&3)<<11|buffer[i+4]<<3|(buffer[i+5]&224)>>5;sampleCount=((buffer[i+6]&3)+1)*1024;adtsFrameDuration=sampleCount*9e4/ADTS_SAMPLING_FREQUENCIES[(buffer[i+2]&60)>>>2];frameEnd=i+frameLength;if(buffer.byteLength<frameEnd){return}this.trigger("data",{pts:packet.pts+frameNum*adtsFrameDuration,dts:packet.dts+frameNum*adtsFrameDuration,sampleCount:sampleCount,audioobjecttype:(buffer[i+2]>>>6&3)+1,channelcount:(buffer[i+2]&1)<<2|(buffer[i+3]&192)>>>6,samplerate:ADTS_SAMPLING_FREQUENCIES[(buffer[i+2]&60)>>>2],samplingfrequencyindex:(buffer[i+2]&60)>>>2,samplesize:16,data:buffer.subarray(i+7+protectionSkipBytes,frameEnd)});if(buffer.byteLength===frameEnd){buffer=undefined;return}frameNum++;buffer=buffer.subarray(frameEnd)}};this.flush=function(){this.trigger("done")}};AdtsStream.prototype=new Stream;module.exports=AdtsStream},{"../utils/stream.js":55}],38:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js");var ExpGolomb=require("../utils/exp-golomb.js");var H264Stream,NalByteStream;NalByteStream=function(){var syncPoint=0,i,buffer;NalByteStream.prototype.init.call(this);this.push=function(data){var swapBuffer;if(!buffer){buffer=data.data}else{swapBuffer=new Uint8Array(buffer.byteLength+data.data.byteLength);swapBuffer.set(buffer);swapBuffer.set(data.data,buffer.byteLength);buffer=swapBuffer}for(;syncPoint<buffer.byteLength-3;syncPoint++){if(buffer[syncPoint+2]===1){i=syncPoint+5;break}}while(i<buffer.byteLength){switch(buffer[i]){case 0:if(buffer[i-1]!==0){i+=2;break}else if(buffer[i-2]!==0){i++;break}if(syncPoint+3!==i-2){this.trigger("data",buffer.subarray(syncPoint+3,i-2))}do{i++}while(buffer[i]!==1&&i<buffer.length);syncPoint=i-2;i+=3;break;case 1:if(buffer[i-1]!==0||buffer[i-2]!==0){i+=3;break}this.trigger("data",buffer.subarray(syncPoint+3,i-2));syncPoint=i-2;i+=3;break;default:i+=3;break}}buffer=buffer.subarray(syncPoint);i-=syncPoint;syncPoint=0};this.flush=function(){if(buffer&&buffer.byteLength>3){this.trigger("data",buffer.subarray(syncPoint+3))}buffer=null;syncPoint=0;this.trigger("done")}};NalByteStream.prototype=new Stream;H264Stream=function(){var nalByteStream=new NalByteStream,self,trackId,currentPts,currentDts,discardEmulationPreventionBytes,readSequenceParameterSet,skipScalingList;H264Stream.prototype.init.call(this);self=this;this.push=function(packet){if(packet.type!=="video"){return}trackId=packet.trackId;currentPts=packet.pts;currentDts=packet.dts;nalByteStream.push(packet)};nalByteStream.on("data",function(data){var event={trackId:trackId,pts:currentPts,dts:currentDts,data:data};switch(data[0]&31){case 5:event.nalUnitType="slice_layer_without_partitioning_rbsp_idr";break;case 6:event.nalUnitType="sei_rbsp";event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));break;case 7:event.nalUnitType="seq_parameter_set_rbsp";event.escapedRBSP=discardEmulationPreventionBytes(data.subarray(1));event.config=readSequenceParameterSet(event.escapedRBSP);break;case 8:event.nalUnitType="pic_parameter_set_rbsp";break;case 9:event.nalUnitType="access_unit_delimiter_rbsp";break;default:break}self.trigger("data",event)});nalByteStream.on("done",function(){self.trigger("done")});this.flush=function(){nalByteStream.flush()};skipScalingList=function(count,expGolombDecoder){var lastScale=8,nextScale=8,j,deltaScale;for(j=0;j<count;j++){if(nextScale!==0){deltaScale=expGolombDecoder.readExpGolomb();nextScale=(lastScale+deltaScale+256)%256}lastScale=nextScale===0?lastScale:nextScale}};discardEmulationPreventionBytes=function(data){var length=data.byteLength,emulationPreventionBytesPositions=[],i=1,newLength,newData;while(i<length-2){if(data[i]===0&&data[i+1]===0&&data[i+2]===3){emulationPreventionBytesPositions.push(i+2);i+=2}else{i++}}if(emulationPreventionBytesPositions.length===0){return data}newLength=length-emulationPreventionBytesPositions.length;newData=new Uint8Array(newLength);var sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++){if(sourceIndex===emulationPreventionBytesPositions[0]){sourceIndex++;emulationPreventionBytesPositions.shift()}newData[i]=data[sourceIndex]}return newData};readSequenceParameterSet=function(data){var frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,sarScale=1,expGolombDecoder,profileIdc,levelIdc,profileCompatibility,chromaFormatIdc,picOrderCntType,numRefFramesInPicOrderCntCycle,picWidthInMbsMinus1,picHeightInMapUnitsMinus1,frameMbsOnlyFlag,scalingListCount,sarRatio,aspectRatioIdc,i;expGolombDecoder=new ExpGolomb(data);profileIdc=expGolombDecoder.readUnsignedByte();profileCompatibility=expGolombDecoder.readUnsignedByte();levelIdc=expGolombDecoder.readUnsignedByte();expGolombDecoder.skipUnsignedExpGolomb();if(profileIdc===100||profileIdc===110||profileIdc===122||profileIdc===244||profileIdc===44||profileIdc===83||profileIdc===86||profileIdc===118||profileIdc===128||profileIdc===138||profileIdc===139||profileIdc===134){chromaFormatIdc=expGolombDecoder.readUnsignedExpGolomb();if(chromaFormatIdc===3){expGolombDecoder.skipBits(1)}expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){scalingListCount=chromaFormatIdc!==3?8:12;for(i=0;i<scalingListCount;i++){if(expGolombDecoder.readBoolean()){if(i<6){skipScalingList(16,expGolombDecoder)}else{skipScalingList(64,expGolombDecoder)}}}}}expGolombDecoder.skipUnsignedExpGolomb();picOrderCntType=expGolombDecoder.readUnsignedExpGolomb();if(picOrderCntType===0){expGolombDecoder.readUnsignedExpGolomb()}else if(picOrderCntType===1){expGolombDecoder.skipBits(1);expGolombDecoder.skipExpGolomb();expGolombDecoder.skipExpGolomb();numRefFramesInPicOrderCntCycle=expGolombDecoder.readUnsignedExpGolomb();for(i=0;i<numRefFramesInPicOrderCntCycle;i++){expGolombDecoder.skipExpGolomb()}}expGolombDecoder.skipUnsignedExpGolomb();expGolombDecoder.skipBits(1);picWidthInMbsMinus1=expGolombDecoder.readUnsignedExpGolomb();picHeightInMapUnitsMinus1=expGolombDecoder.readUnsignedExpGolomb();frameMbsOnlyFlag=expGolombDecoder.readBits(1);if(frameMbsOnlyFlag===0){expGolombDecoder.skipBits(1)}expGolombDecoder.skipBits(1);if(expGolombDecoder.readBoolean()){frameCropLeftOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropRightOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropTopOffset=expGolombDecoder.readUnsignedExpGolomb();frameCropBottomOffset=expGolombDecoder.readUnsignedExpGolomb()}if(expGolombDecoder.readBoolean()){if(expGolombDecoder.readBoolean()){aspectRatioIdc=expGolombDecoder.readUnsignedByte();switch(aspectRatioIdc){case 1:sarRatio=[1,1];break;case 2:sarRatio=[12,11];break;case 3:sarRatio=[10,11];break;case 4:sarRatio=[16,11];break;case 5:sarRatio=[40,33];break;case 6:sarRatio=[24,11];break;case 7:sarRatio=[20,11];break;case 8:sarRatio=[32,11];break;case 9:sarRatio=[80,33];break;case 10:sarRatio=[18,11];break;case 11:sarRatio=[15,11];break;case 12:sarRatio=[64,33];break;case 13:sarRatio=[160,99];break;case 14:sarRatio=[4,3];break;case 15:sarRatio=[3,2];break;case 16:sarRatio=[2,1];break;case 255:{sarRatio=[expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte(),expGolombDecoder.readUnsignedByte()<<8|expGolombDecoder.readUnsignedByte()];break}}if(sarRatio){sarScale=sarRatio[0]/sarRatio[1]}}}return{profileIdc:profileIdc,levelIdc:levelIdc,profileCompatibility:profileCompatibility,width:Math.ceil(((picWidthInMbsMinus1+1)*16-frameCropLeftOffset*2-frameCropRightOffset*2)*sarScale),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-frameCropTopOffset*2-frameCropBottomOffset*2}}};H264Stream.prototype=new Stream;module.exports={H264Stream:H264Stream,NalByteStream:NalByteStream}},{"../utils/exp-golomb.js":54,"../utils/stream.js":55}],39:[function(require,module,exports){module.exports={adts:require("./adts"),h264:require("./h264")}},{"./adts":37,"./h264":38}],40:[function(require,module,exports){"use strict";var FlvTag;FlvTag=function(type,extraData){var adHoc=0,bufferStartSize=16384,prepareWrite=function(flv,count){var bytes,minLength=flv.position+count;if(minLength<flv.bytes.byteLength){return}bytes=new Uint8Array(minLength*2);bytes.set(flv.bytes.subarray(0,flv.position),0);flv.bytes=bytes;flv.view=new DataView(flv.bytes.buffer)},widthBytes=FlvTag.widthBytes||new Uint8Array("width".length),heightBytes=FlvTag.heightBytes||new Uint8Array("height".length),videocodecidBytes=FlvTag.videocodecidBytes||new Uint8Array("videocodecid".length),i;if(!FlvTag.widthBytes){for(i=0;i<"width".length;i++){widthBytes[i]="width".charCodeAt(i)}for(i=0;i<"height".length;i++){heightBytes[i]="height".charCodeAt(i)}for(i=0;i<"videocodecid".length;i++){videocodecidBytes[i]="videocodecid".charCodeAt(i)}FlvTag.widthBytes=widthBytes;FlvTag.heightBytes=heightBytes;FlvTag.videocodecidBytes=videocodecidBytes}this.keyFrame=false;switch(type){case FlvTag.VIDEO_TAG:this.length=16;bufferStartSize*=6;break;case FlvTag.AUDIO_TAG:this.length=13;this.keyFrame=true;break;case FlvTag.METADATA_TAG:this.length=29;this.keyFrame=true;break;default:throw"Error Unknown TagType"}this.bytes=new Uint8Array(bufferStartSize);this.view=new DataView(this.bytes.buffer);this.bytes[0]=type;this.position=this.length;this.keyFrame=extraData;this.pts=0;this.dts=0;this.writeBytes=function(bytes,offset,length){var start=offset||0,end;length=length||bytes.byteLength;end=start+length;prepareWrite(this,length);this.bytes.set(bytes.subarray(start,end),this.position);this.position+=length;this.length=Math.max(this.length,this.position)};this.writeByte=function(byte){prepareWrite(this,1);this.bytes[this.position]=byte;this.position++;this.length=Math.max(this.length,this.position)};this.writeShort=function(short){prepareWrite(this,2);this.view.setUint16(this.position,short);this.position+=2;this.length=Math.max(this.length,this.position)};this.negIndex=function(pos){return this.bytes[this.length-pos]};this.nalUnitSize=function(){if(adHoc===0){return 0}return this.length-(adHoc+4)};this.startNalUnit=function(){if(adHoc>0){throw new Error("Attempted to create new NAL wihout closing the old one")}adHoc=this.length;this.length+=4;this.position=this.length};this.endNalUnit=function(nalContainer){var nalStart,nalLength;if(this.length===adHoc+4){this.length-=4}else if(adHoc>0){nalStart=adHoc+4;nalLength=this.length-nalStart;this.position=adHoc;this.view.setUint32(this.position,nalLength);this.position=this.length;if(nalContainer){nalContainer.push(this.bytes.subarray(nalStart,nalStart+nalLength))}}adHoc=0};this.writeMetaDataDouble=function(key,val){var i;prepareWrite(this,2+key.length+9);this.view.setUint16(this.position,key.length);this.position+=2;if(key==="width"){this.bytes.set(widthBytes,this.position);this.position+=5}else if(key==="height"){this.bytes.set(heightBytes,this.position);this.position+=6}else if(key==="videocodecid"){this.bytes.set(videocodecidBytes,this.position);this.position+=12}else{for(i=0;i<key.length;i++){this.bytes[this.position]=key.charCodeAt(i);this.position++}}this.position++;this.view.setFloat64(this.position,val);this.position+=8;this.length=Math.max(this.length,this.position);++adHoc};this.writeMetaDataBoolean=function(key,val){var i;prepareWrite(this,2);this.view.setUint16(this.position,key.length);this.position+=2;for(i=0;i<key.length;i++){prepareWrite(this,1);this.bytes[this.position]=key.charCodeAt(i);this.position++}prepareWrite(this,2);this.view.setUint8(this.position,1);this.position++;this.view.setUint8(this.position,val?1:0);this.position++;this.length=Math.max(this.length,this.position);++adHoc};this.finalize=function(){var dtsDelta,len;switch(this.bytes[0]){case FlvTag.VIDEO_TAG:this.bytes[11]=(this.keyFrame||extraData?16:32)|7;this.bytes[12]=extraData?0:1;dtsDelta=this.pts-this.dts;this.bytes[13]=(dtsDelta&16711680)>>>16;this.bytes[14]=(dtsDelta&65280)>>>8;this.bytes[15]=(dtsDelta&255)>>>0;break;case FlvTag.AUDIO_TAG:this.bytes[11]=175;this.bytes[12]=extraData?0:1;break;case FlvTag.METADATA_TAG:this.position=11;this.view.setUint8(this.position,2);this.position++;this.view.setUint16(this.position,10);this.position+=2;this.bytes.set([111,110,77,101,116,97,68,97,116,97],this.position);this.position+=10;this.bytes[this.position]=8;this.position++;this.view.setUint32(this.position,adHoc);this.position=this.length;this.bytes.set([0,0,9],this.position);this.position+=3;this.length=this.position;break}len=this.length-11;this.bytes[1]=(len&16711680)>>>16;this.bytes[2]=(len&65280)>>>8;this.bytes[3]=(len&255)>>>0;this.bytes[4]=(this.dts&16711680)>>>16;this.bytes[5]=(this.dts&65280)>>>8;this.bytes[6]=(this.dts&255)>>>0;this.bytes[7]=(this.dts&4278190080)>>>24;this.bytes[8]=0;this.bytes[9]=0;this.bytes[10]=0;prepareWrite(this,4);this.view.setUint32(this.length,this.length);this.length+=4;this.position+=4;this.bytes=this.bytes.subarray(0,this.length);this.frameTime=FlvTag.frameTime(this.bytes);return this}};FlvTag.AUDIO_TAG=8;FlvTag.VIDEO_TAG=9;FlvTag.METADATA_TAG=18;FlvTag.isAudioFrame=function(tag){return FlvTag.AUDIO_TAG===tag[0]};FlvTag.isVideoFrame=function(tag){return FlvTag.VIDEO_TAG===tag[0]};FlvTag.isMetaData=function(tag){return FlvTag.METADATA_TAG===tag[0]};FlvTag.isKeyFrame=function(tag){if(FlvTag.isVideoFrame(tag)){return tag[11]===23}if(FlvTag.isAudioFrame(tag)){return true}if(FlvTag.isMetaData(tag)){return true}return false};FlvTag.frameTime=function(tag){var pts=tag[4]<<16;pts|=tag[5]<<8;pts|=tag[6]<<0;pts|=tag[7]<<24;return pts};module.exports=FlvTag},{}],41:[function(require,module,exports){module.exports={tag:require("./flv-tag"),Transmuxer:require("./transmuxer"),tools:require("../tools/flv-inspector")}},{"../tools/flv-inspector":52,"./flv-tag":40,"./transmuxer":42}],42:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js");var FlvTag=require("./flv-tag.js");var m2ts=require("../m2ts/m2ts.js");var AdtsStream=require("../codecs/adts.js");var H264Stream=require("../codecs/h264").H264Stream;var MetadataStream,Transmuxer,VideoSegmentStream,AudioSegmentStream,CoalesceStream,collectTimelineInfo,metaDataTag,extraDataTag;collectTimelineInfo=function(track,data){if(typeof data.pts==="number"){if(track.timelineStartInfo.pts===undefined){track.timelineStartInfo.pts=data.pts}else{track.timelineStartInfo.pts=Math.min(track.timelineStartInfo.pts,data.pts)}}if(typeof data.dts==="number"){if(track.timelineStartInfo.dts===undefined){track.timelineStartInfo.dts=data.dts}else{track.timelineStartInfo.dts=Math.min(track.timelineStartInfo.dts,data.dts)}}};metaDataTag=function(track,pts){var tag=new FlvTag(FlvTag.METADATA_TAG);tag.dts=pts;tag.pts=pts;tag.writeMetaDataDouble("videocodecid",7);tag.writeMetaDataDouble("width",track.width);tag.writeMetaDataDouble("height",track.height);return tag};extraDataTag=function(track,pts){var i,tag=new FlvTag(FlvTag.VIDEO_TAG,true);tag.dts=pts;tag.pts=pts;tag.writeByte(1);tag.writeByte(track.profileIdc);tag.writeByte(track.profileCompatibility);tag.writeByte(track.levelIdc);tag.writeByte(252|3);tag.writeByte(224|1);tag.writeShort(track.sps[0].length);tag.writeBytes(track.sps[0]);tag.writeByte(track.pps.length);for(i=0;i<track.pps.length;++i){tag.writeShort(track.pps[i].length);tag.writeBytes(track.pps[i])}return tag};AudioSegmentStream=function(track){var adtsFrames=[],adtsFramesLength=0,sequenceNumber=0,earliestAllowedDts=0,oldExtraData;AudioSegmentStream.prototype.init.call(this);this.push=function(data){collectTimelineInfo(track,data);if(track&&track.channelcount===undefined){track.audioobjecttype=data.audioobjecttype;track.channelcount=data.channelcount;track.samplerate=data.samplerate;track.samplingfrequencyindex=data.samplingfrequencyindex;track.samplesize=data.samplesize;track.extraData=track.audioobjecttype<<11|track.samplingfrequencyindex<<7|track.channelcount<<3}data.pts=Math.round(data.pts/90);data.dts=Math.round(data.dts/90);adtsFrames.push(data)};this.flush=function(){var currentFrame,adtsFrame,deltaDts,lastMetaPts,tags=[];if(adtsFrames.length===0){this.trigger("done");return}lastMetaPts=-Infinity;while(adtsFrames.length){currentFrame=adtsFrames.shift();if(track.extraData!==oldExtraData||currentFrame.pts-lastMetaPts>=1e3){adtsFrame=new FlvTag(FlvTag.METADATA_TAG);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.writeMetaDataDouble("audiocodecid",10);adtsFrame.writeMetaDataBoolean("stereo",2===track.channelcount);adtsFrame.writeMetaDataDouble("audiosamplerate",track.samplerate);adtsFrame.writeMetaDataDouble("audiosamplesize",16);tags.push(adtsFrame);oldExtraData=track.extraData;adtsFrame=new FlvTag(FlvTag.AUDIO_TAG,true);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.view.setUint16(adtsFrame.position,track.extraData);adtsFrame.position+=2;adtsFrame.length=Math.max(adtsFrame.length,adtsFrame.position);tags.push(adtsFrame);lastMetaPts=currentFrame.pts}adtsFrame=new FlvTag(FlvTag.AUDIO_TAG);adtsFrame.pts=currentFrame.pts;adtsFrame.dts=currentFrame.dts;adtsFrame.writeBytes(currentFrame.data);tags.push(adtsFrame)}oldExtraData=null;this.trigger("data",{track:track,tags:tags});this.trigger("done")}};AudioSegmentStream.prototype=new Stream;VideoSegmentStream=function(track){var sequenceNumber=0,nalUnits=[],nalUnitsLength=0,config,h264Frame;VideoSegmentStream.prototype.init.call(this);this.finishFrame=function(tags,frame){if(!frame){return}if(config&&track&&track.newMetadata&&(frame.keyFrame||tags.length===0)){tags.push(metaDataTag(config,frame.pts));tags.push(extraDataTag(track,frame.pts));track.newMetadata=false}frame.endNalUnit();tags.push(frame)};this.push=function(data){collectTimelineInfo(track,data);data.pts=Math.round(data.pts/90);data.dts=Math.round(data.dts/90);nalUnits.push(data)};this.flush=function(){var currentNal,tags=[];while(nalUnits.length){if(nalUnits[0].nalUnitType==="access_unit_delimiter_rbsp"){break}nalUnits.shift()}if(nalUnits.length===0){this.trigger("done");return}while(nalUnits.length){currentNal=nalUnits.shift();if(currentNal.nalUnitType==="seq_parameter_set_rbsp"){track.newMetadata=true;config=currentNal.config;track.width=config.width;track.height=config.height;track.sps=[currentNal.data];track.profileIdc=config.profileIdc;track.levelIdc=config.levelIdc;track.profileCompatibility=config.profileCompatibility;h264Frame.endNalUnit()}else if(currentNal.nalUnitType==="pic_parameter_set_rbsp"){track.newMetadata=true;track.pps=[currentNal.data];h264Frame.endNalUnit()}else if(currentNal.nalUnitType==="access_unit_delimiter_rbsp"){if(h264Frame){this.finishFrame(tags,h264Frame)}h264Frame=new FlvTag(FlvTag.VIDEO_TAG);h264Frame.pts=currentNal.pts;h264Frame.dts=currentNal.dts}else{if(currentNal.nalUnitType==="slice_layer_without_partitioning_rbsp_idr"){h264Frame.keyFrame=true}h264Frame.endNalUnit()}h264Frame.startNalUnit();h264Frame.writeBytes(currentNal.data)}if(h264Frame){this.finishFrame(tags,h264Frame)}this.trigger("data",{track:track,tags:tags});this.trigger("done")}};VideoSegmentStream.prototype=new Stream;CoalesceStream=function(options){this.numberOfTracks=0;this.metadataStream=options.metadataStream;this.videoTags=[];this.audioTags=[];this.videoTrack=null;this.audioTrack=null;this.pendingCaptions=[];this.pendingMetadata=[];this.pendingTracks=0;CoalesceStream.prototype.init.call(this);this.push=function(output){if(output.text){return this.pendingCaptions.push(output)}if(output.frames){return this.pendingMetadata.push(output)}if(output.track.type==="video"){this.videoTrack=output.track;this.videoTags=output.tags;this.pendingTracks++}if(output.track.type==="audio"){this.audioTrack=output.track;this.audioTags=output.tags;this.pendingTracks++}}};CoalesceStream.prototype=new Stream;CoalesceStream.prototype.flush=function(){var id3,caption,i,timelineStartPts,event={tags:{},captions:[],metadata:[]};if(this.pendingTracks<this.numberOfTracks){return}if(this.videoTrack){timelineStartPts=this.videoTrack.timelineStartInfo.pts}else if(this.audioTrack){timelineStartPts=this.audioTrack.timelineStartInfo.pts}event.tags.videoTags=this.videoTags;event.tags.audioTags=this.audioTags;for(i=0;i<this.pendingCaptions.length;i++){caption=this.pendingCaptions[i];caption.startTime=caption.startPts-timelineStartPts;caption.startTime/=9e4;caption.endTime=caption.endPts-timelineStartPts;caption.endTime/=9e4;event.captions.push(caption)}for(i=0;i<this.pendingMetadata.length;i++){id3=this.pendingMetadata[i];id3.cueTime=id3.pts-timelineStartPts;id3.cueTime/=9e4;event.metadata.push(id3)}event.metadata.dispatchType=this.metadataStream.dispatchType;this.videoTrack=null;this.audioTrack=null;this.videoTags=[];this.audioTags=[];this.pendingCaptions.length=0;this.pendingMetadata.length=0;this.pendingTracks=0;this.trigger("data",event);this.trigger("done")};Transmuxer=function(options){var self=this,videoTrack,audioTrack,packetStream,parseStream,elementaryStream,adtsStream,h264Stream,videoSegmentStream,audioSegmentStream,captionStream,coalesceStream;Transmuxer.prototype.init.call(this);options=options||{};this.metadataStream=new m2ts.MetadataStream;options.metadataStream=this.metadataStream;packetStream=new m2ts.TransportPacketStream;parseStream=new m2ts.TransportParseStream;elementaryStream=new m2ts.ElementaryStream;adtsStream=new AdtsStream;h264Stream=new H264Stream;coalesceStream=new CoalesceStream(options);packetStream.pipe(parseStream).pipe(elementaryStream);elementaryStream.pipe(h264Stream);elementaryStream.pipe(adtsStream);elementaryStream.pipe(this.metadataStream).pipe(coalesceStream);captionStream=new m2ts.CaptionStream;h264Stream.pipe(captionStream).pipe(coalesceStream);elementaryStream.on("data",function(data){var i,videoTrack,audioTrack;if(data.type==="metadata"){i=data.tracks.length;while(i--){if(data.tracks[i].type==="video"){videoTrack=data.tracks[i]}else if(data.tracks[i].type==="audio"){audioTrack=data.tracks[i]}}if(videoTrack&&!videoSegmentStream){coalesceStream.numberOfTracks++;videoSegmentStream=new VideoSegmentStream(videoTrack);h264Stream.pipe(videoSegmentStream).pipe(coalesceStream)}if(audioTrack&&!audioSegmentStream){coalesceStream.numberOfTracks++;audioSegmentStream=new AudioSegmentStream(audioTrack);adtsStream.pipe(audioSegmentStream).pipe(coalesceStream)}}});this.push=function(data){packetStream.push(data)};this.flush=function(){packetStream.flush()};coalesceStream.on("data",function(event){self.trigger("data",event)});coalesceStream.on("done",function(){self.trigger("done")});this.getFlvHeader=function(duration,audio,video){var headBytes=new Uint8Array(3+1+1+4),head=new DataView(headBytes.buffer),metadata,result,metadataLength;duration=duration||0;audio=audio===undefined?true:audio;video=video===undefined?true:video;head.setUint8(0,70);head.setUint8(1,76);head.setUint8(2,86);head.setUint8(3,1);head.setUint8(4,(audio?4:0)|(video?1:0));head.setUint32(5,headBytes.byteLength);if(duration<=0){result=new Uint8Array(headBytes.byteLength+4);result.set(headBytes);result.set([0,0,0,0],headBytes.byteLength);return result}metadata=new FlvTag(FlvTag.METADATA_TAG);metadata.pts=metadata.dts=0;metadata.writeMetaDataDouble("duration",duration);metadataLength=metadata.finalize().length;result=new Uint8Array(headBytes.byteLength+metadataLength);result.set(headBytes);result.set(head.byteLength,metadataLength);return result}};Transmuxer.prototype=new Stream;module.exports=Transmuxer},{"../codecs/adts.js":37,"../codecs/h264":38,"../m2ts/m2ts.js":46,"../utils/stream.js":55,"./flv-tag.js":40}],43:[function(require,module,exports){"use strict";var muxjs={codecs:require("./codecs"),mp4:require("./mp4"),flv:require("./flv"),mp2t:require("./m2ts")};module.exports=muxjs},{"./codecs":39,"./flv":41,"./m2ts":45,"./mp4":49}],44:[function(require,module,exports){"use strict";var USER_DATA_REGISTERED_ITU_T_T35=4,RBSP_TRAILING_BITS=128,Stream=require("../utils/stream");var parseSei=function(bytes){var i=0,result={payloadType:-1,payloadSize:0},payloadType=0,payloadSize=0;while(i<bytes.byteLength){if(bytes[i]===RBSP_TRAILING_BITS){break}while(bytes[i]===255){payloadType+=255;i++}payloadType+=bytes[i++];while(bytes[i]===255){payloadSize+=255;i++}payloadSize+=bytes[i++];if(!result.payload&&payloadType===USER_DATA_REGISTERED_ITU_T_T35){result.payloadType=payloadType;result.payloadSize=payloadSize;result.payload=bytes.subarray(i,i+payloadSize);break}i+=payloadSize;payloadType=0;payloadSize=0}return result};var parseUserData=function(sei){if(sei.payload[0]!==181){return null}if((sei.payload[1]<<8|sei.payload[2])!==49){return null}if(String.fromCharCode(sei.payload[3],sei.payload[4],sei.payload[5],sei.payload[6])!=="GA94"){return null}if(sei.payload[7]!==3){return null}return sei.payload.subarray(8,sei.payload.length-1)};var parseCaptionPackets=function(pts,userData){var results=[],i,count,offset,data;if(!(userData[0]&64)){return results}count=userData[0]&31;for(i=0;i<count;i++){offset=i*3;data={type:userData[offset+2]&3,pts:pts};if(userData[offset+2]&4){data.ccData=userData[offset+3]<<8|userData[offset+4];results.push(data)}}return results};var CaptionStream=function(){var self=this;CaptionStream.prototype.init.call(this);this.captionPackets_=[];this.field1_=new Cea608Stream;this.field1_.on("data",this.trigger.bind(this,"data"));this.field1_.on("done",this.trigger.bind(this,"done"))};CaptionStream.prototype=new Stream;CaptionStream.prototype.push=function(event){var sei,userData,captionPackets;if(event.nalUnitType!=="sei_rbsp"){return}sei=parseSei(event.escapedRBSP);if(sei.payloadType!==USER_DATA_REGISTERED_ITU_T_T35){return}userData=parseUserData(sei);if(!userData){return}this.captionPackets_=this.captionPackets_.concat(parseCaptionPackets(event.pts,userData))};CaptionStream.prototype.flush=function(){if(!this.captionPackets_.length){this.field1_.flush();return}this.captionPackets_.sort(function(a,b){return a.pts-b.pts});this.captionPackets_.forEach(this.field1_.push,this.field1_);this.captionPackets_.length=0;this.field1_.flush();return};var BASIC_CHARACTER_TRANSLATION={42:225,92:233,
94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608};var getCharFromCode=function(code){if(code===null){return""}code=BASIC_CHARACTER_TRANSLATION[code]||code;return String.fromCharCode(code)};var PADDING=0,RESUME_CAPTION_LOADING=5152,END_OF_CAPTION=5167,ROLL_UP_2_ROWS=5157,ROLL_UP_3_ROWS=5158,ROLL_UP_4_ROWS=5159,RESUME_DIRECT_CAPTIONING=5161,CARRIAGE_RETURN=5165,BACKSPACE=5153,ERASE_DISPLAYED_MEMORY=5164,ERASE_NON_DISPLAYED_MEMORY=5166;var BOTTOM_ROW=14;var createDisplayBuffer=function(){var result=[],i=BOTTOM_ROW+1;while(i--){result.push("")}return result};var Cea608Stream=function(){Cea608Stream.prototype.init.call(this);this.mode_="popOn";this.topRow_=0;this.startPts_=0;this.displayed_=createDisplayBuffer();this.nonDisplayed_=createDisplayBuffer();this.lastControlCode_=null;this.push=function(packet){if(packet.type!==0){return}var data,swap,char0,char1;data=packet.ccData&32639;if(data===this.lastControlCode_){this.lastControlCode_=null;return}if((data&61440)===4096){this.lastControlCode_=data}else{this.lastControlCode_=null}switch(data){case PADDING:break;case RESUME_CAPTION_LOADING:this.mode_="popOn";break;case END_OF_CAPTION:this.flushDisplayed(packet.pts);swap=this.displayed_;this.displayed_=this.nonDisplayed_;this.nonDisplayed_=swap;this.startPts_=packet.pts;break;case ROLL_UP_2_ROWS:this.topRow_=BOTTOM_ROW-1;this.mode_="rollUp";break;case ROLL_UP_3_ROWS:this.topRow_=BOTTOM_ROW-2;this.mode_="rollUp";break;case ROLL_UP_4_ROWS:this.topRow_=BOTTOM_ROW-3;this.mode_="rollUp";break;case CARRIAGE_RETURN:this.flushDisplayed(packet.pts);this.shiftRowsUp_();this.startPts_=packet.pts;break;case BACKSPACE:if(this.mode_==="popOn"){this.nonDisplayed_[BOTTOM_ROW]=this.nonDisplayed_[BOTTOM_ROW].slice(0,-1)}else{this.displayed_[BOTTOM_ROW]=this.displayed_[BOTTOM_ROW].slice(0,-1)}break;case ERASE_DISPLAYED_MEMORY:this.flushDisplayed(packet.pts);this.displayed_=createDisplayBuffer();break;case ERASE_NON_DISPLAYED_MEMORY:this.nonDisplayed_=createDisplayBuffer();break;default:char0=data>>>8;char1=data&255;if(char0>=16&&char0<=23&&char1>=64&&char1<=127&&(char0!==16||char1<96)){char0=32;char1=null}if((char0===17||char0===25)&&(char1>=48&&char1<=63)){char0=9834;char1=""}if((char0&240)===16){return}this[this.mode_](packet.pts,char0,char1);break}}};Cea608Stream.prototype=new Stream;Cea608Stream.prototype.flushDisplayed=function(pts){var content=this.displayed_.map(function(row){return row.trim()}).filter(function(row){return row.length}).join("\n");if(content.length){this.trigger("data",{startPts:this.startPts_,endPts:pts,text:content})}};Cea608Stream.prototype.popOn=function(pts,char0,char1){var baseRow=this.nonDisplayed_[BOTTOM_ROW];baseRow+=getCharFromCode(char0);baseRow+=getCharFromCode(char1);this.nonDisplayed_[BOTTOM_ROW]=baseRow};Cea608Stream.prototype.rollUp=function(pts,char0,char1){var baseRow=this.displayed_[BOTTOM_ROW];if(baseRow===""){this.flushDisplayed(pts);this.startPts_=pts}baseRow+=getCharFromCode(char0);baseRow+=getCharFromCode(char1);this.displayed_[BOTTOM_ROW]=baseRow};Cea608Stream.prototype.shiftRowsUp_=function(){var i;for(i=0;i<this.topRow_;i++){this.displayed_[i]=""}for(i=this.topRow_;i<BOTTOM_ROW;i++){this.displayed_[i]=this.displayed_[i+1]}this.displayed_[BOTTOM_ROW]=""};module.exports={CaptionStream:CaptionStream,Cea608Stream:Cea608Stream}},{"../utils/stream":55}],45:[function(require,module,exports){module.exports=require("./m2ts")},{"./m2ts":46}],46:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js"),CaptionStream=require("./caption-stream"),StreamTypes=require("./stream-types");var Stream=require("../utils/stream.js");var m2tsStreamTypes=require("./stream-types.js");var TransportPacketStream,TransportParseStream,ElementaryStream,AacStream,H264Stream,NalByteStream;var MP2T_PACKET_LENGTH=188,SYNC_BYTE=71,TransportPacketStream=function(){var buffer=new Uint8Array(MP2T_PACKET_LENGTH),bytesInBuffer=0;TransportPacketStream.prototype.init.call(this);this.push=function(bytes){var i=0,startIndex=0,endIndex=MP2T_PACKET_LENGTH,everything;if(bytesInBuffer){everything=new Uint8Array(bytes.byteLength+bytesInBuffer);everything.set(buffer.subarray(0,bytesInBuffer));everything.set(bytes,bytesInBuffer);bytesInBuffer=0}else{everything=bytes}while(endIndex<everything.byteLength){if(everything[startIndex]===SYNC_BYTE&&everything[endIndex]===SYNC_BYTE){this.trigger("data",everything.subarray(startIndex,endIndex));startIndex+=MP2T_PACKET_LENGTH;endIndex+=MP2T_PACKET_LENGTH;continue}startIndex++;endIndex++}if(startIndex<everything.byteLength){buffer.set(everything.subarray(startIndex),0);bytesInBuffer=everything.byteLength-startIndex}};this.flush=function(){if(bytesInBuffer===MP2T_PACKET_LENGTH&&buffer[0]===SYNC_BYTE){this.trigger("data",buffer);bytesInBuffer=0}this.trigger("done")}};TransportPacketStream.prototype=new Stream;TransportParseStream=function(){var parsePsi,parsePat,parsePmt,parsePes,self;TransportParseStream.prototype.init.call(this);self=this;this.packetsWaitingForPmt=[];this.programMapTable=undefined;parsePsi=function(payload,psi){var offset=0;if(psi.payloadUnitStartIndicator){offset+=payload[offset]+1}if(psi.type==="pat"){parsePat(payload.subarray(offset),psi)}else{parsePmt(payload.subarray(offset),psi)}};parsePat=function(payload,pat){pat.section_number=payload[7];pat.last_section_number=payload[8];self.pmtPid=(payload[10]&31)<<8|payload[11];pat.pmtPid=self.pmtPid};parsePmt=function(payload,pmt){var sectionLength,tableEnd,programInfoLength,offset;if(!(payload[5]&1)){return}self.programMapTable={};sectionLength=(payload[1]&15)<<8|payload[2];tableEnd=3+sectionLength-4;programInfoLength=(payload[10]&15)<<8|payload[11];offset=12+programInfoLength;while(offset<tableEnd){self.programMapTable[(payload[offset+1]&31)<<8|payload[offset+2]]=payload[offset];offset+=((payload[offset+3]&15)<<8|payload[offset+4])+5}pmt.programMapTable=self.programMapTable;while(self.packetsWaitingForPmt.length){self.processPes_.apply(self,self.packetsWaitingForPmt.shift())}};this.push=function(packet){var result={},offset=4;result.payloadUnitStartIndicator=!!(packet[1]&64);result.pid=packet[1]&31;result.pid<<=8;result.pid|=packet[2];if((packet[3]&48)>>>4>1){offset+=packet[offset]+1}if(result.pid===0){result.type="pat";parsePsi(packet.subarray(offset),result);this.trigger("data",result)}else if(result.pid===this.pmtPid){result.type="pmt";parsePsi(packet.subarray(offset),result);this.trigger("data",result)}else if(this.programMapTable===undefined){this.packetsWaitingForPmt.push([packet,offset,result])}else{this.processPes_(packet,offset,result)}};this.processPes_=function(packet,offset,result){result.streamType=this.programMapTable[result.pid];result.type="pes";result.data=packet.subarray(offset);this.trigger("data",result)}};TransportParseStream.prototype=new Stream;TransportParseStream.STREAM_TYPES={h264:27,adts:15};ElementaryStream=function(){var video={data:[],size:0},audio={data:[],size:0},timedMetadata={data:[],size:0},parsePes=function(payload,pes){var ptsDtsFlags;pes.dataAlignmentIndicator=(payload[6]&4)!==0;ptsDtsFlags=payload[7];if(ptsDtsFlags&192){pes.pts=(payload[9]&14)<<27|(payload[10]&255)<<20|(payload[11]&254)<<12|(payload[12]&255)<<5|(payload[13]&254)>>>3;pes.pts*=4;pes.pts+=(payload[13]&6)>>>1;pes.dts=pes.pts;if(ptsDtsFlags&64){pes.dts=(payload[14]&14)<<27|(payload[15]&255)<<20|(payload[16]&254)<<12|(payload[17]&255)<<5|(payload[18]&254)>>>3;pes.dts*=4;pes.dts+=(payload[18]&6)>>>1}}pes.data=payload.subarray(9+payload[8])},flushStream=function(stream,type){var packetData=new Uint8Array(stream.size),event={type:type},i=0,fragment;if(!stream.data.length){return}event.trackId=stream.data[0].pid;while(stream.data.length){fragment=stream.data.shift();packetData.set(fragment.data,i);i+=fragment.data.byteLength}parsePes(packetData,event);stream.size=0;self.trigger("data",event)},self;ElementaryStream.prototype.init.call(this);self=this;this.push=function(data){({pat:function(){},pes:function(){var stream,streamType;switch(data.streamType){case StreamTypes.H264_STREAM_TYPE:case m2tsStreamTypes.H264_STREAM_TYPE:stream=video;streamType="video";break;case StreamTypes.ADTS_STREAM_TYPE:stream=audio;streamType="audio";break;case StreamTypes.METADATA_STREAM_TYPE:stream=timedMetadata;streamType="timed-metadata";break;default:return}if(data.payloadUnitStartIndicator){flushStream(stream,streamType)}stream.data.push(data);stream.size+=data.data.byteLength},pmt:function(){var event={type:"metadata",tracks:[]},programMapTable=data.programMapTable,k,track;for(k in programMapTable){if(programMapTable.hasOwnProperty(k)){track={timelineStartInfo:{baseMediaDecodeTime:0}};track.id=+k;if(programMapTable[k]===m2tsStreamTypes.H264_STREAM_TYPE){track.codec="avc";track.type="video"}else if(programMapTable[k]===m2tsStreamTypes.ADTS_STREAM_TYPE){track.codec="adts";track.type="audio"}event.tracks.push(track)}}self.trigger("data",event)}})[data.type]()};this.flush=function(){flushStream(video,"video");flushStream(audio,"audio");flushStream(timedMetadata,"timed-metadata");this.trigger("done")}};ElementaryStream.prototype=new Stream;var m2ts={PAT_PID:0,MP2T_PACKET_LENGTH:MP2T_PACKET_LENGTH,TransportPacketStream:TransportPacketStream,TransportParseStream:TransportParseStream,ElementaryStream:ElementaryStream,CaptionStream:CaptionStream.CaptionStream,Cea608Stream:CaptionStream.Cea608Stream,MetadataStream:require("./metadata-stream")};for(var type in StreamTypes){if(StreamTypes.hasOwnProperty(type)){m2ts[type]=StreamTypes[type]}}module.exports=m2ts},{"../utils/stream.js":55,"./caption-stream":44,"./metadata-stream":47,"./stream-types":48,"./stream-types.js":48}],47:[function(require,module,exports){"use strict";var Stream=require("../utils/stream"),StreamTypes=require("./stream-types"),percentEncode=function(bytes,start,end){var i,result="";for(i=start;i<end;i++){result+="%"+("00"+bytes[i].toString(16)).slice(-2)}return result},parseUtf8=function(bytes,start,end){return decodeURIComponent(percentEncode(bytes,start,end))},parseIso88591=function(bytes,start,end){return unescape(percentEncode(bytes,start,end))},parseSyncSafeInteger=function(data){return data[0]<<21|data[1]<<14|data[2]<<7|data[3]},tagParsers={TXXX:function(tag){var i;if(tag.data[0]!==3){return}for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.value=parseUtf8(tag.data,i+1,tag.data.length-1);break}}tag.data=tag.value},WXXX:function(tag){var i;if(tag.data[0]!==3){return}for(i=1;i<tag.data.length;i++){if(tag.data[i]===0){tag.description=parseUtf8(tag.data,1,i);tag.url=parseUtf8(tag.data,i+1,tag.data.length);break}}},PRIV:function(tag){var i;for(i=0;i<tag.data.length;i++){if(tag.data[i]===0){tag.owner=parseIso88591(tag.data,0,i);break}}tag.privateData=tag.data.subarray(i+1);tag.data=tag.privateData}},MetadataStream;MetadataStream=function(options){var settings={debug:!!(options&&options.debug),descriptor:options&&options.descriptor},tagSize=0,buffer=[],bufferSize=0,i;MetadataStream.prototype.init.call(this);this.dispatchType=StreamTypes.METADATA_STREAM_TYPE.toString(16);if(settings.descriptor){for(i=0;i<settings.descriptor.length;i++){this.dispatchType+=("00"+settings.descriptor[i].toString(16)).slice(-2)}}this.push=function(chunk){var tag,frameStart,frameSize,frame,i,frameHeader;if(chunk.type!=="timed-metadata"){return}if(chunk.dataAlignmentIndicator){bufferSize=0;buffer.length=0}if(buffer.length===0&&(chunk.data.length<10||chunk.data[0]!=="I".charCodeAt(0)||chunk.data[1]!=="D".charCodeAt(0)||chunk.data[2]!=="3".charCodeAt(0))){if(settings.debug){console.log("Skipping unrecognized metadata packet")}return}buffer.push(chunk);bufferSize+=chunk.data.byteLength;if(buffer.length===1){tagSize=parseSyncSafeInteger(chunk.data.subarray(6,10));tagSize+=10}if(bufferSize<tagSize){return}tag={data:new Uint8Array(tagSize),frames:[],pts:buffer[0].pts,dts:buffer[0].dts};for(i=0;i<tagSize;){tag.data.set(buffer[0].data.subarray(0,tagSize-i),i);i+=buffer[0].data.byteLength;bufferSize-=buffer[0].data.byteLength;buffer.shift()}frameStart=10;if(tag.data[5]&64){frameStart+=4;frameStart+=parseSyncSafeInteger(tag.data.subarray(10,14));tagSize-=parseSyncSafeInteger(tag.data.subarray(16,20))}do{frameSize=parseSyncSafeInteger(tag.data.subarray(frameStart+4,frameStart+8));if(frameSize<1){return console.log("Malformed ID3 frame encountered. Skipping metadata parsing.")}frameHeader=String.fromCharCode(tag.data[frameStart],tag.data[frameStart+1],tag.data[frameStart+2],tag.data[frameStart+3]);frame={id:frameHeader,data:tag.data.subarray(frameStart+10,frameStart+frameSize+10)};frame.key=frame.id;if(tagParsers[frame.id]){tagParsers[frame.id](frame);if(frame.owner==="com.apple.streaming.transportStreamTimestamp"){var d=frame.data,size=(d[3]&1)<<30|d[4]<<22|d[5]<<14|d[6]<<6|d[7]>>>2;size*=4;size+=d[7]&3;frame.timeStamp=size;this.trigger("timestamp",frame)}}tag.frames.push(frame);frameStart+=10;frameStart+=frameSize}while(frameStart<tagSize);this.trigger("data",tag)}};MetadataStream.prototype=new Stream;module.exports=MetadataStream},{"../utils/stream":55,"./stream-types":48}],48:[function(require,module,exports){"use strict";module.exports={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21}},{}],49:[function(require,module,exports){module.exports={generator:require("./mp4-generator"),Transmuxer:require("./transmuxer").Transmuxer,AudioSegmentStream:require("./transmuxer").AudioSegmentStream,VideoSegmentStream:require("./transmuxer").VideoSegmentStream,tools:require("../tools/mp4-inspector")}},{"../tools/mp4-inspector":53,"./mp4-generator":50,"./transmuxer":51}],50:[function(require,module,exports){"use strict";var box,dinf,esds,ftyp,mdat,mfhd,minf,moof,moov,mvex,mvhd,trak,tkhd,mdia,mdhd,hdlr,sdtp,stbl,stsd,styp,traf,trex,trun,types,MAJOR_BRAND,MINOR_VERSION,AVC1_BRAND,VIDEO_HDLR,AUDIO_HDLR,HDLR_TYPES,VMHD,SMHD,DREF,STCO,STSC,STSZ,STTS;(function(){var i;types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[]};if(typeof Uint8Array==="undefined"){return}for(i in types){if(types.hasOwnProperty(i)){types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]}}MAJOR_BRAND=new Uint8Array(["i".charCodeAt(0),"s".charCodeAt(0),"o".charCodeAt(0),"m".charCodeAt(0)]);AVC1_BRAND=new Uint8Array(["a".charCodeAt(0),"v".charCodeAt(0),"c".charCodeAt(0),"1".charCodeAt(0)]);MINOR_VERSION=new Uint8Array([0,0,0,1]);VIDEO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]);AUDIO_HDLR=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);HDLR_TYPES={video:VIDEO_HDLR,audio:AUDIO_HDLR};DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);SMHD=new Uint8Array([0,0,0,0,0,0,0,0]);STCO=new Uint8Array([0,0,0,0,0,0,0,0]);STSC=STCO;STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);STTS=STCO;VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])})();box=function(type){var payload=[],size=0,i,result,view;for(i=1;i<arguments.length;i++){payload.push(arguments[i])}i=payload.length;while(i--){size+=payload[i].byteLength}result=new Uint8Array(size+8);view=new DataView(result.buffer,result.byteOffset,result.byteLength);view.setUint32(0,result.byteLength);result.set(type,4);for(i=0,size=8;i<payload.length;i++){result.set(payload[i],size);size+=payload[i].byteLength}return result};dinf=function(){return box(types.dinf,box(types.dref,DREF))};esds=function(track){return box(types.esds,new Uint8Array([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,track.audioobjecttype<<3|track.samplingfrequencyindex>>>1,track.samplingfrequencyindex<<7|track.channelcount<<3,6,1,2]))};ftyp=function(){return box(types.ftyp,MAJOR_BRAND,MINOR_VERSION,MAJOR_BRAND,AVC1_BRAND)};hdlr=function(type){return box(types.hdlr,HDLR_TYPES[type])};mdat=function(data){return box(types.mdat,data)};mdhd=function(track){var result=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,track.duration>>>24&255,track.duration>>>16&255,track.duration>>>8&255,track.duration&255,85,196,0,0]);if(track.samplerate){result[12]=track.samplerate>>>24&255;result[13]=track.samplerate>>>16&255;result[14]=track.samplerate>>>8&255;result[15]=track.samplerate&255}return box(types.mdhd,result)};mdia=function(track){return box(types.mdia,mdhd(track),hdlr(track.type),minf(track))};mfhd=function(sequenceNumber){return box(types.mfhd,new Uint8Array([0,0,0,0,(sequenceNumber&4278190080)>>24,(sequenceNumber&16711680)>>16,(sequenceNumber&65280)>>8,sequenceNumber&255]))};minf=function(track){return box(types.minf,track.type==="video"?box(types.vmhd,VMHD):box(types.smhd,SMHD),dinf(),stbl(track))};moof=function(sequenceNumber,tracks){var trackFragments=[],i=tracks.length;while(i--){trackFragments[i]=traf(tracks[i])}return box.apply(null,[types.moof,mfhd(sequenceNumber)].concat(trackFragments))};moov=function(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=trak(tracks[i])}return box.apply(null,[types.moov,mvhd(4294967295)].concat(boxes).concat(mvex(tracks)))};mvex=function(tracks){var i=tracks.length,boxes=[];while(i--){boxes[i]=trex(tracks[i])}return box.apply(null,[types.mvex].concat(boxes))};mvhd=function(duration){var bytes=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(duration&4278190080)>>24,(duration&16711680)>>16,(duration&65280)>>8,duration&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return box(types.mvhd,bytes)};sdtp=function(track){var samples=track.samples||[],bytes=new Uint8Array(4+samples.length),flags,i;for(i=0;i<samples.length;i++){flags=samples[i].flags;bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy}return box(types.sdtp,bytes)};stbl=function(track){return box(types.stbl,stsd(track),box(types.stts,STTS),box(types.stsc,STSC),box(types.stsz,STSZ),box(types.stco,STCO))};(function(){var videoSample,audioSample;stsd=function(track){return box(types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),track.type==="video"?videoSample(track):audioSample(track))};videoSample=function(track){var sps=track.sps||[],pps=track.pps||[],sequenceParameterSets=[],pictureParameterSets=[],i;for(i=0;i<sps.length;i++){sequenceParameterSets.push((sps[i].byteLength&65280)>>>8);sequenceParameterSets.push(sps[i].byteLength&255);sequenceParameterSets=sequenceParameterSets.concat(Array.prototype.slice.call(sps[i]))}for(i=0;i<pps.length;i++){pictureParameterSets.push((pps[i].byteLength&65280)>>>8);pictureParameterSets.push(pps[i].byteLength&255);pictureParameterSets=pictureParameterSets.concat(Array.prototype.slice.call(pps[i]))}return box(types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(track.width&65280)>>8,track.width&255,(track.height&65280)>>8,track.height&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),box(types.avcC,new Uint8Array([1,track.profileIdc,track.profileCompatibility,track.levelIdc,255].concat([sps.length]).concat(sequenceParameterSets).concat([pps.length]).concat(pictureParameterSets))),box(types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))};audioSample=function(track){return box(types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(track.channelcount&65280)>>8,track.channelcount&255,(track.samplesize&65280)>>8,track.samplesize&255,0,0,0,0,(track.samplerate&65280)>>8,track.samplerate&255,0,0]),esds(track))}})();styp=function(){return box(types.styp,MAJOR_BRAND,MINOR_VERSION,MAJOR_BRAND)};tkhd=function(track){var result=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,0,(track.duration&4278190080)>>24,(track.duration&16711680)>>16,(track.duration&65280)>>8,track.duration&255,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(track.width&65280)>>8,track.width&255,0,0,(track.height&65280)>>8,track.height&255,0,0]);return box(types.tkhd,result)};traf=function(track){var trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable,dataOffset;trackFragmentHeader=box(types.tfhd,new Uint8Array([0,0,0,58,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0]));trackFragmentDecodeTime=box(types.tfdt,new Uint8Array([0,0,0,0,track.baseMediaDecodeTime>>>24&255,track.baseMediaDecodeTime>>>16&255,track.baseMediaDecodeTime>>>8&255,track.baseMediaDecodeTime&255]));dataOffset=32+16+8+16+8+8;if(track.type==="audio"){trackFragmentRun=trun(track,dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun)}sampleDependencyTable=sdtp(track);trackFragmentRun=trun(track,sampleDependencyTable.length+dataOffset);return box(types.traf,trackFragmentHeader,trackFragmentDecodeTime,trackFragmentRun,sampleDependencyTable)};trak=function(track){track.duration=track.duration||4294967295;return box(types.trak,tkhd(track),mdia(track))};trex=function(track){var result=new Uint8Array([0,0,0,0,(track.id&4278190080)>>24,(track.id&16711680)>>16,(track.id&65280)>>8,track.id&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);if(track.type!=="video"){result[result.length-1]=0}return box(types.trex,result)};(function(){var audioTrun,videoTrun,trunHeader;trunHeader=function(samples,offset){var durationPresent=0,sizePresent=0,flagsPresent=0,compositionTimeOffset=0;if(samples.length){if(samples[0].duration!==undefined){durationPresent=1}if(samples[0].size!==undefined){sizePresent=2}if(samples[0].flags!==undefined){flagsPresent=4}if(samples[0].compositionTimeOffset!==undefined){compositionTimeOffset=8}}return[0,0,durationPresent|sizePresent|flagsPresent|compositionTimeOffset,1,(samples.length&4278190080)>>>24,(samples.length&16711680)>>>16,(samples.length&65280)>>>8,samples.length&255,(offset&4278190080)>>>24,(offset&16711680)>>>16,(offset&65280)>>>8,offset&255]};videoTrun=function(track,offset){var bytes,samples,sample,i;samples=track.samples||[];offset+=8+12+16*samples.length;bytes=trunHeader(samples,offset);for(i=0;i<samples.length;i++){sample=samples[i];bytes=bytes.concat([(sample.duration&4278190080)>>>24,(sample.duration&16711680)>>>16,(sample.duration&65280)>>>8,sample.duration&255,(sample.size&4278190080)>>>24,(sample.size&16711680)>>>16,(sample.size&65280)>>>8,sample.size&255,sample.flags.isLeading<<2|sample.flags.dependsOn,sample.flags.isDependedOn<<6|sample.flags.hasRedundancy<<4|sample.flags.paddingValue<<1|sample.flags.isNonSyncSample,sample.flags.degradationPriority&240<<8,sample.flags.degradationPriority&15,(sample.compositionTimeOffset&4278190080)>>>24,(sample.compositionTimeOffset&16711680)>>>16,(sample.compositionTimeOffset&65280)>>>8,sample.compositionTimeOffset&255])}return box(types.trun,new Uint8Array(bytes))};audioTrun=function(track,offset){var bytes,samples,sample,i;samples=track.samples||[];offset+=8+12+8*samples.length;bytes=trunHeader(samples,offset);for(i=0;i<samples.length;i++){sample=samples[i];bytes=bytes.concat([(sample.duration&4278190080)>>>24,(sample.duration&16711680)>>>16,(sample.duration&65280)>>>8,sample.duration&255,(sample.size&4278190080)>>>24,(sample.size&16711680)>>>16,(sample.size&65280)>>>8,sample.size&255])}return box(types.trun,new Uint8Array(bytes))};trun=function(track,offset){if(track.type==="audio"){return audioTrun(track,offset)}else{return videoTrun(track,offset)}}})();module.exports={ftyp:ftyp,mdat:mdat,moof:moof,moov:moov,initSegment:function(tracks){var fileType=ftyp(),movie=moov(tracks),result;result=new Uint8Array(fileType.byteLength+movie.byteLength);result.set(fileType);result.set(movie,fileType.byteLength);return result}}},{}],51:[function(require,module,exports){"use strict";var Stream=require("../utils/stream.js");var mp4=require("./mp4-generator.js");var m2ts=require("../m2ts/m2ts.js");var AdtsStream=require("../codecs/adts.js");var H264Stream=require("../codecs/h264").H264Stream;var AacStream=require("../aac");var AUDIO_PROPERTIES=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"];var VIDEO_PROPERTIES=["width","height","profileIdc","levelIdc","profileCompatibility"];var VideoSegmentStream,AudioSegmentStream,Transmuxer,CoalesceStream;var createDefaultSample,isLikelyAacData,collectDtsInfo,clearDtsInfo,calculateTrackBaseMediaDecodeTime,arrayEquals,sumFrameByteLengths;createDefaultSample=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0}}};isLikelyAacData=function(data){if(data[0]==="I".charCodeAt(0)&&data[1]==="D".charCodeAt(0)&&data[2]==="3".charCodeAt(0)){return true}return false};arrayEquals=function(a,b){var i;if(a.length!==b.length){return false}for(i=0;i<a.length;i++){if(a[i]!==b[i]){return false}}return true};sumFrameByteLengths=function(array){var i,currentObj,sum=0;for(i=0;i<array.length;i++){currentObj=array[i];sum+=currentObj.data.byteLength}return sum};AudioSegmentStream=function(track){var adtsFrames=[],sequenceNumber=0,earliestAllowedDts=0;AudioSegmentStream.prototype.init.call(this);this.push=function(data){collectDtsInfo(track,data);if(track){AUDIO_PROPERTIES.forEach(function(prop){track[prop]=data[prop]})}adtsFrames.push(data)};this.setEarliestDts=function(earliestDts){earliestAllowedDts=earliestDts-track.timelineStartInfo.baseMediaDecodeTime};this.flush=function(){var frames,moof,mdat,boxes;if(adtsFrames.length===0){this.trigger("done","AudioSegmentStream");return}frames=this.trimAdtsFramesByEarliestDts_(adtsFrames);track.samples=this.generateSampleTable_(frames);mdat=mp4.mdat(this.concatenateFrameData_(frames));adtsFrames=[];calculateTrackBaseMediaDecodeTime(track);moof=mp4.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);clearDtsInfo(track);this.trigger("data",{track:track,boxes:boxes});this.trigger("done","AudioSegmentStream")};this.trimAdtsFramesByEarliestDts_=function(adtsFrames){if(track.minSegmentDts>=earliestAllowedDts){return adtsFrames}track.minSegmentDts=Infinity;return adtsFrames.filter(function(currentFrame){if(currentFrame.dts>=earliestAllowedDts){track.minSegmentDts=Math.min(track.minSegmentDts,currentFrame.dts);track.minSegmentPts=track.minSegmentDts;return true}return false})};this.generateSampleTable_=function(frames){var i,currentFrame,samples=[];for(i=0;i<frames.length;i++){currentFrame=frames[i];samples.push({size:currentFrame.data.byteLength,duration:1024})}return samples};this.concatenateFrameData_=function(frames){var i,currentFrame,dataOffset=0,data=new Uint8Array(sumFrameByteLengths(frames));for(i=0;i<frames.length;i++){currentFrame=frames[i];data.set(currentFrame.data,dataOffset);dataOffset+=currentFrame.data.byteLength}return data}};AudioSegmentStream.prototype=new Stream;VideoSegmentStream=function(track){var sequenceNumber=0,nalUnits=[],config,pps;VideoSegmentStream.prototype.init.call(this);delete track.minPTS;this.gopCache_=[];this.push=function(nalUnit){collectDtsInfo(track,nalUnit);if(nalUnit.nalUnitType==="seq_parameter_set_rbsp"&&!config){config=nalUnit.config;track.sps=[nalUnit.data];VIDEO_PROPERTIES.forEach(function(prop){track[prop]=config[prop]},this)}if(nalUnit.nalUnitType==="pic_parameter_set_rbsp"&&!pps){pps=nalUnit.data;track.pps=[nalUnit.data]}nalUnits.push(nalUnit)};this.flush=function(){var frames,gopForFusion,gops,moof,mdat,boxes;while(nalUnits.length){if(nalUnits[0].nalUnitType==="access_unit_delimiter_rbsp"){break}nalUnits.shift()}if(nalUnits.length===0){this.resetStream_();this.trigger("done","VideoSegmentStream");return}frames=this.groupNalsIntoFrames_(nalUnits);gops=this.groupFramesIntoGops_(frames);if(!gops[0][0].keyFrame){gopForFusion=this.getGopForFusion_(nalUnits[0],track);if(gopForFusion){gops.unshift(gopForFusion);gops.byteLength+=gopForFusion.byteLength;gops.nalCount+=gopForFusion.nalCount;gops.pts=gopForFusion.pts;gops.dts=gopForFusion.dts;gops.duration+=gopForFusion.duration}else{gops=this.extendFirstKeyFrame_(gops)}}collectDtsInfo(track,gops);track.samples=this.generateSampleTable_(gops);mdat=mp4.mdat(this.concatenateNalData_(gops));this.gopCache_.unshift({gop:gops.pop(),pps:track.pps,sps:track.sps});this.gopCache_.length=Math.min(6,this.gopCache_.length);nalUnits=[];calculateTrackBaseMediaDecodeTime(track);this.trigger("timelineStartInfo",track.timelineStartInfo);moof=mp4.moof(sequenceNumber,[track]);boxes=new Uint8Array(moof.byteLength+mdat.byteLength);sequenceNumber++;boxes.set(moof);boxes.set(mdat,moof.byteLength);this.trigger("data",{track:track,boxes:boxes});this.resetStream_();this.trigger("done","VideoSegmentStream")};this.resetStream_=function(){clearDtsInfo(track);config=undefined;pps=undefined};this.getGopForFusion_=function(nalUnit){var halfSecond=45e3,allowableOverlap=1e4,nearestDistance=Infinity,dtsDistance,nearestGopObj,currentGop,currentGopObj,i;for(i=0;i<this.gopCache_.length;i++){currentGopObj=this.gopCache_[i];currentGop=currentGopObj.gop;if(!(track.pps&&arrayEquals(track.pps[0],currentGopObj.pps[0]))||!(track.sps&&arrayEquals(track.sps[0],currentGopObj.sps[0]))){continue}if(currentGop.dts<track.timelineStartInfo.dts){continue}dtsDistance=nalUnit.dts-currentGop.dts-currentGop.duration;if(dtsDistance>=-allowableOverlap&&dtsDistance<=halfSecond){if(!nearestGopObj||nearestDistance>dtsDistance){nearestGopObj=currentGopObj;nearestDistance=dtsDistance}}}if(nearestGopObj){return nearestGopObj.gop}return null};this.extendFirstKeyFrame_=function(gops){var h,i,currentGop,newGops;if(!gops[0][0].keyFrame){currentGop=gops.shift();gops.byteLength-=currentGop.byteLength;gops.nalCount-=currentGop.nalCount;gops[0][0].dts=currentGop.dts;gops[0][0].pts=currentGop.pts;gops[0][0].duration+=currentGop.duration}return gops};this.groupNalsIntoFrames_=function(nalUnits){var i,currentNal,startPts,startDts,currentFrame=[],frames=[];currentFrame.byteLength=0;for(i=0;i<nalUnits.length;i++){currentNal=nalUnits[i];if(currentNal.nalUnitType==="access_unit_delimiter_rbsp"){if(currentFrame.length){currentFrame.duration=currentNal.dts-currentFrame.dts;frames.push(currentFrame)}currentFrame=[currentNal];currentFrame.byteLength=currentNal.data.byteLength;currentFrame.pts=currentNal.pts;currentFrame.dts=currentNal.dts}else{if(currentNal.nalUnitType==="slice_layer_without_partitioning_rbsp_idr"){currentFrame.keyFrame=true}currentFrame.duration=currentNal.dts-currentFrame.dts;currentFrame.byteLength+=currentNal.data.byteLength;currentFrame.push(currentNal)}}if(frames.length&&(!currentFrame.duration||currentFrame.duration<=0)){currentFrame.duration=frames[frames.length-1].duration}frames.push(currentFrame);return frames};this.groupFramesIntoGops_=function(frames){var i,currentFrame,currentGop=[],gops=[];currentGop.byteLength=0;currentGop.nalCount=0;currentGop.duration=0;currentGop.pts=frames[0].pts;currentGop.dts=frames[0].dts;gops.byteLength=0;gops.nalCount=0;gops.duration=0;gops.pts=frames[0].pts;gops.dts=frames[0].dts;for(i=0;i<frames.length;i++){currentFrame=frames[i];if(currentFrame.keyFrame){if(currentGop.length){gops.push(currentGop);gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration}currentGop=[currentFrame];currentGop.nalCount=currentFrame.length;currentGop.byteLength=currentFrame.byteLength;currentGop.pts=currentFrame.pts;currentGop.dts=currentFrame.dts;currentGop.duration=currentFrame.duration}else{currentGop.duration+=currentFrame.duration;currentGop.nalCount+=currentFrame.length;currentGop.byteLength+=currentFrame.byteLength;currentGop.push(currentFrame)}}if(gops.length&&currentGop.duration<=0){currentGop.duration=gops[gops.length-1].duration}
gops.byteLength+=currentGop.byteLength;gops.nalCount+=currentGop.nalCount;gops.duration+=currentGop.duration;gops.push(currentGop);return gops};this.generateSampleTable_=function(gops,baseDataOffset){var h,i,sample,currentGop,currentFrame,currentSample,dataOffset=baseDataOffset||0,samples=[];for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];sample=createDefaultSample();sample.dataOffset=dataOffset;sample.compositionTimeOffset=currentFrame.pts-currentFrame.dts;sample.duration=currentFrame.duration;sample.size=4*currentFrame.length;sample.size+=currentFrame.byteLength;if(currentFrame.keyFrame){sample.flags.dependsOn=2}dataOffset+=sample.size;samples.push(sample)}}return samples};this.concatenateNalData_=function(gops){var h,i,j,currentGop,currentFrame,currentNal,dataOffset=0,nalsByteLength=gops.byteLength,numberOfNals=gops.nalCount,totalByteLength=nalsByteLength+4*numberOfNals,data=new Uint8Array(totalByteLength),view=new DataView(data.buffer);for(h=0;h<gops.length;h++){currentGop=gops[h];for(i=0;i<currentGop.length;i++){currentFrame=currentGop[i];for(j=0;j<currentFrame.length;j++){currentNal=currentFrame[j];view.setUint32(dataOffset,currentNal.data.byteLength);dataOffset+=4;data.set(currentNal.data,dataOffset);dataOffset+=currentNal.data.byteLength}}}return data}};VideoSegmentStream.prototype=new Stream;collectDtsInfo=function(track,data){if(typeof data.pts==="number"){if(track.timelineStartInfo.pts===undefined){track.timelineStartInfo.pts=data.pts}if(track.minSegmentPts===undefined){track.minSegmentPts=data.pts}else{track.minSegmentPts=Math.min(track.minSegmentPts,data.pts)}if(track.maxSegmentPts===undefined){track.maxSegmentPts=data.pts}else{track.maxSegmentPts=Math.max(track.maxSegmentPts,data.pts)}}if(typeof data.dts==="number"){if(track.timelineStartInfo.dts===undefined){track.timelineStartInfo.dts=data.dts}if(track.minSegmentDts===undefined){track.minSegmentDts=data.dts}else{track.minSegmentDts=Math.min(track.minSegmentDts,data.dts)}if(track.maxSegmentDts===undefined){track.maxSegmentDts=data.dts}else{track.maxSegmentDts=Math.max(track.maxSegmentDts,data.dts)}}};clearDtsInfo=function(track){delete track.minSegmentDts;delete track.maxSegmentDts;delete track.minSegmentPts;delete track.maxSegmentPts};calculateTrackBaseMediaDecodeTime=function(track){var oneSecondInPTS=9e4,scale,timeSinceStartOfTimeline=track.minSegmentDts-track.timelineStartInfo.dts,firstSampleCompositionOffset=track.minSegmentPts-track.minSegmentDts;track.baseMediaDecodeTime=track.timelineStartInfo.baseMediaDecodeTime;track.baseMediaDecodeTime+=timeSinceStartOfTimeline;track.baseMediaDecodeTime-=firstSampleCompositionOffset;track.baseMediaDecodeTime=Math.max(0,track.baseMediaDecodeTime);if(track.type==="audio"){scale=track.samplerate/oneSecondInPTS;track.baseMediaDecodeTime*=scale;track.baseMediaDecodeTime=Math.floor(track.baseMediaDecodeTime)}};CoalesceStream=function(options,metadataStream){this.numberOfTracks=0;this.metadataStream=metadataStream;if(typeof options.remux!=="undefined"){this.remuxTracks=!!options.remux}else{this.remuxTracks=true}this.pendingTracks=[];this.videoTrack=null;this.pendingBoxes=[];this.pendingCaptions=[];this.pendingMetadata=[];this.pendingBytes=0;this.emittedTracks=0;CoalesceStream.prototype.init.call(this);this.push=function(output){if(output.text){return this.pendingCaptions.push(output)}if(output.frames){return this.pendingMetadata.push(output)}this.pendingTracks.push(output.track);this.pendingBoxes.push(output.boxes);this.pendingBytes+=output.boxes.byteLength;if(output.track.type==="video"){this.videoTrack=output.track}if(output.track.type==="audio"){this.audioTrack=output.track}}};CoalesceStream.prototype=new Stream;CoalesceStream.prototype.flush=function(flushSource){var offset=0,event={captions:[],metadata:[],info:{}},caption,id3,initSegment,timelineStartPts=0,i;if(this.pendingTracks.length<this.numberOfTracks){if(flushSource!=="VideoSegmentStream"&&flushSource!=="AudioSegmentStream"){return}else if(this.remuxTracks){return}else if(this.pendingTracks.length===0){this.emittedTracks++;if(this.emittedTracks>=this.numberOfTracks){this.trigger("done");this.emittedTracks=0}return}}if(this.videoTrack){timelineStartPts=this.videoTrack.timelineStartInfo.pts;VIDEO_PROPERTIES.forEach(function(prop){event.info[prop]=this.videoTrack[prop]},this)}else if(this.audioTrack){timelineStartPts=this.audioTrack.timelineStartInfo.pts;AUDIO_PROPERTIES.forEach(function(prop){event.info[prop]=this.audioTrack[prop]},this)}if(this.pendingTracks.length===1){event.type=this.pendingTracks[0].type}else{event.type="combined"}this.emittedTracks+=this.pendingTracks.length;initSegment=mp4.initSegment(this.pendingTracks);event.data=new Uint8Array(initSegment.byteLength+this.pendingBytes);event.data.set(initSegment);offset+=initSegment.byteLength;for(i=0;i<this.pendingBoxes.length;i++){event.data.set(this.pendingBoxes[i],offset);offset+=this.pendingBoxes[i].byteLength}for(i=0;i<this.pendingCaptions.length;i++){caption=this.pendingCaptions[i];caption.startTime=caption.startPts-timelineStartPts;caption.startTime/=9e4;caption.endTime=caption.endPts-timelineStartPts;caption.endTime/=9e4;event.captions.push(caption)}for(i=0;i<this.pendingMetadata.length;i++){id3=this.pendingMetadata[i];id3.cueTime=id3.pts-timelineStartPts;id3.cueTime/=9e4;event.metadata.push(id3)}event.metadata.dispatchType=this.metadataStream.dispatchType;this.pendingTracks.length=0;this.videoTrack=null;this.pendingBoxes.length=0;this.pendingCaptions.length=0;this.pendingBytes=0;this.pendingMetadata.length=0;this.trigger("data",event);if(this.emittedTracks>=this.numberOfTracks){this.trigger("done");this.emittedTracks=0}};Transmuxer=function(options){var self=this,hasFlushed=true,videoTrack,audioTrack;Transmuxer.prototype.init.call(this);options=options||{};this.baseMediaDecodeTime=options.baseMediaDecodeTime||0;this.transmuxPipeline_={};this.setupAacPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type="aac";pipeline.metadataStream=new m2ts.MetadataStream;pipeline.aacStream=new AacStream;pipeline.adtsStream=new AdtsStream;pipeline.coalesceStream=new CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.aacStream;pipeline.aacStream.pipe(pipeline.adtsStream);pipeline.aacStream.pipe(pipeline.metadataStream);pipeline.metadataStream.pipe(pipeline.coalesceStream);pipeline.metadataStream.on("timestamp",function(frame){pipeline.aacStream.setTimestamp(frame.timeStamp)});pipeline.aacStream.on("data",function(data){var i;if(data.type==="timed-metadata"&&!pipeline.audioSegmentStream){audioTrack=audioTrack||{timelineStartInfo:{baseMediaDecodeTime:self.baseMediaDecodeTime},codec:"adts",type:"audio"};pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new AudioSegmentStream(audioTrack);pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)}});pipeline.coalesceStream.on("data",this.trigger.bind(this,"data"));pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))};this.setupTsPipeline=function(){var pipeline={};this.transmuxPipeline_=pipeline;pipeline.type="ts";pipeline.metadataStream=new m2ts.MetadataStream;pipeline.packetStream=new m2ts.TransportPacketStream;pipeline.parseStream=new m2ts.TransportParseStream;pipeline.elementaryStream=new m2ts.ElementaryStream;pipeline.adtsStream=new AdtsStream;pipeline.h264Stream=new H264Stream;pipeline.captionStream=new m2ts.CaptionStream;pipeline.coalesceStream=new CoalesceStream(options,pipeline.metadataStream);pipeline.headOfPipeline=pipeline.packetStream;pipeline.packetStream.pipe(pipeline.parseStream).pipe(pipeline.elementaryStream);pipeline.elementaryStream.pipe(pipeline.h264Stream);pipeline.elementaryStream.pipe(pipeline.adtsStream);pipeline.elementaryStream.pipe(pipeline.metadataStream).pipe(pipeline.coalesceStream);pipeline.h264Stream.pipe(pipeline.captionStream).pipe(pipeline.coalesceStream);pipeline.elementaryStream.on("data",function(data){var i;if(data.type==="metadata"){i=data.tracks.length;while(i--){if(!videoTrack&&data.tracks[i].type==="video"){videoTrack=data.tracks[i];videoTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}else if(!audioTrack&&data.tracks[i].type==="audio"){audioTrack=data.tracks[i];audioTrack.timelineStartInfo.baseMediaDecodeTime=self.baseMediaDecodeTime}}if(videoTrack&&!pipeline.videoSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.videoSegmentStream=new VideoSegmentStream(videoTrack);pipeline.videoSegmentStream.on("timelineStartInfo",function(timelineStartInfo){if(audioTrack){audioTrack.timelineStartInfo=timelineStartInfo;pipeline.audioSegmentStream.setEarliestDts(timelineStartInfo.dts)}});pipeline.h264Stream.pipe(pipeline.videoSegmentStream).pipe(pipeline.coalesceStream)}if(audioTrack&&!pipeline.audioSegmentStream){pipeline.coalesceStream.numberOfTracks++;pipeline.audioSegmentStream=new AudioSegmentStream(audioTrack);pipeline.adtsStream.pipe(pipeline.audioSegmentStream).pipe(pipeline.coalesceStream)}}});pipeline.coalesceStream.on("data",this.trigger.bind(this,"data"));pipeline.coalesceStream.on("done",this.trigger.bind(this,"done"))};this.setBaseMediaDecodeTime=function(baseMediaDecodeTime){var pipeline=this.transmuxPipeline_;this.baseMediaDecodeTime=baseMediaDecodeTime;if(audioTrack){audioTrack.timelineStartInfo.dts=undefined;audioTrack.timelineStartInfo.pts=undefined;clearDtsInfo(audioTrack);audioTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime}if(videoTrack){if(pipeline.videoSegmentStream){pipeline.videoSegmentStream.gopCache_=[]}videoTrack.timelineStartInfo.dts=undefined;videoTrack.timelineStartInfo.pts=undefined;clearDtsInfo(videoTrack);videoTrack.timelineStartInfo.baseMediaDecodeTime=baseMediaDecodeTime}};this.push=function(data){if(hasFlushed){var isAac=isLikelyAacData(data);if(isAac&&this.transmuxPipeline_.type!=="aac"){this.setupAacPipeline()}else if(!isAac&&this.transmuxPipeline_.type!=="ts"){this.setupTsPipeline()}hasFlushed=false}this.transmuxPipeline_.headOfPipeline.push(data)};this.flush=function(){hasFlushed=true;this.transmuxPipeline_.headOfPipeline.flush()}};Transmuxer.prototype=new Stream;module.exports={Transmuxer:Transmuxer,VideoSegmentStream:VideoSegmentStream,AudioSegmentStream:AudioSegmentStream,AUDIO_PROPERTIES:AUDIO_PROPERTIES,VIDEO_PROPERTIES:VIDEO_PROPERTIES}},{"../aac":36,"../codecs/adts.js":37,"../codecs/h264":38,"../m2ts/m2ts.js":46,"../utils/stream.js":55,"./mp4-generator.js":50}],52:[function(require,module,exports){"use strict";var tagTypes={8:"audio",9:"video",18:"metadata"},hex=function(val){return"0x"+("00"+val.toString(16)).slice(-2).toUpperCase()},hexStringList=function(data){var arr=[],i;while(data.byteLength>0){i=0;switch(data.byteLength){default:arr.push(hex(data[i++]));case 7:arr.push(hex(data[i++]));case 6:arr.push(hex(data[i++]));case 5:arr.push(hex(data[i++]));case 4:arr.push(hex(data[i++]));case 3:arr.push(hex(data[i++]));case 2:arr.push(hex(data[i++]));case 1:arr.push(hex(data[i++]))}data=data.subarray(i)}return arr.join(" ")},parseAVCTag=function(tag,obj){var avcPacketTypes=["AVC Sequence Header","AVC NALU","AVC End-of-Sequence"],nalUnitTypes=["unspecified","slice_layer_without_partitioning","slice_data_partition_a_layer","slice_data_partition_b_layer","slice_data_partition_c_layer","slice_layer_without_partitioning_idr","sei","seq_parameter_set","pic_parameter_set","access_unit_delimiter","end_of_seq","end_of_stream","filler","seq_parameter_set_ext","prefix_nal_unit","subset_seq_parameter_set","reserved","reserved","reserved"],compositionTime=tag[1]&parseInt("01111111",2)<<16|tag[2]<<8|tag[3];obj=obj||{};obj.avcPacketType=avcPacketTypes[tag[0]];obj.CompositionTime=tag[1]&parseInt("10000000",2)?-compositionTime:compositionTime;if(tag[0]===1){obj.nalUnitTypeRaw=hexStringList(tag.subarray(4,100))}else{obj.data=hexStringList(tag.subarray(4))}return obj},parseVideoTag=function(tag,obj){var frameTypes=["Unknown","Keyframe (for AVC, a seekable frame)","Inter frame (for AVC, a nonseekable frame)","Disposable inter frame (H.263 only)","Generated keyframe (reserved for server use only)","Video info/command frame"],codecIDs=["JPEG (currently unused)","Sorenson H.263","Screen video","On2 VP6","On2 VP6 with alpha channel","Screen video version 2","AVC"],codecID=tag[0]&parseInt("00001111",2);obj=obj||{};obj.frameType=frameTypes[(tag[0]&parseInt("11110000",2))>>>4];obj.codecID=codecID;if(codecID===7){return parseAVCTag(tag.subarray(1),obj)}return obj},parseAACTag=function(tag,obj){var packetTypes=["AAC Sequence Header","AAC Raw"];obj=obj||{};obj.aacPacketType=packetTypes[tag[0]];obj.data=hexStringList(tag.subarray(1));return obj},parseAudioTag=function(tag,obj){var formatTable=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16-kHz mono","Nellymoser 8-kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","Speex","MP3 8-Khz","Device-specific sound"],samplingRateTable=["5.5-kHz","11-kHz","22-kHz","44-kHz"],soundFormat=(tag[0]&parseInt("11110000",2))>>>4;obj=obj||{};obj.soundFormat=formatTable[soundFormat];obj.soundRate=samplingRateTable[(tag[0]&parseInt("00001100",2))>>>2];obj.soundSize=(tag[0]&parseInt("00000010",2))>>>1?"16-bit":"8-bit";obj.soundType=tag[0]&parseInt("00000001",2)?"Stereo":"Mono";if(soundFormat===10){return parseAACTag(tag.subarray(1),obj)}return obj},parseGenericTag=function(tag){return{tagType:tagTypes[tag[0]],dataSize:tag[1]<<16|tag[2]<<8|tag[3],timestamp:tag[7]<<24|tag[4]<<16|tag[5]<<8|tag[6],streamID:tag[8]<<16|tag[9]<<8|tag[10]}},inspectFlvTag=function(tag){var header=parseGenericTag(tag);switch(tag[0]){case 8:parseAudioTag(tag.subarray(11),header);break;case 9:parseVideoTag(tag.subarray(11),header);break;case 18:}return header},inspectFlv=function(bytes){var i=9,dataSize,parsedResults=[],tag;i+=4;while(i<bytes.byteLength){dataSize=bytes[i+1]<<16;dataSize|=bytes[i+2]<<8;dataSize|=bytes[i+3];dataSize+=11;tag=bytes.subarray(i,i+dataSize);parsedResults.push(inspectFlvTag(tag));i+=dataSize+4}return parsedResults},textifyFlv=function(flvTagArray){return JSON.stringify(flvTagArray,null,2)};module.exports={inspectTag:inspectFlvTag,inspect:inspectFlv,textify:textifyFlv}},{}],53:[function(require,module,exports){(function(global){"use strict";var inspectMp4,textifyMp4,parseType=function(buffer){var result="";result+=String.fromCharCode(buffer[0]);result+=String.fromCharCode(buffer[1]);result+=String.fromCharCode(buffer[2]);result+=String.fromCharCode(buffer[3]);return result},parseMp4Date=function(seconds){return new Date(seconds*1e3-20828448e5)},parseSampleFlags=function(flags){return{isLeading:(flags[0]&12)>>>2,dependsOn:flags[0]&3,isDependedOn:(flags[1]&192)>>>6,hasRedundancy:(flags[1]&48)>>>4,paddingValue:(flags[1]&14)>>>1,isNonSyncSample:flags[1]&1,degradationPriority:flags[2]<<8|flags[3]}},nalParse=function(avcStream){var avcView=new DataView(avcStream.buffer,avcStream.byteOffset,avcStream.byteLength),result=[],i,length;for(i=0;i+4<avcStream.length;i+=length){length=avcView.getUint32(i);i+=4;if(length<=0){result.push("<span style='color:red;'>MALFORMED DATA</span>");continue}switch(avcStream[i]&31){case 1:result.push("slice_layer_without_partitioning_rbsp");break;case 5:result.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:result.push("sei_rbsp");break;case 7:result.push("seq_parameter_set_rbsp");break;case 8:result.push("pic_parameter_set_rbsp");break;case 9:result.push("access_unit_delimiter_rbsp");break;default:result.push("UNKNOWN NAL - "+avcStream[i]&31);break}}return result},parse={avc1:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{dataReferenceIndex:view.getUint16(6),width:view.getUint16(24),height:view.getUint16(26),horizresolution:view.getUint16(28)+view.getUint16(30)/16,vertresolution:view.getUint16(32)+view.getUint16(34)/16,frameCount:view.getUint16(40),depth:view.getUint16(74),config:inspectMp4(data.subarray(78,data.byteLength))}},avcC:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={configurationVersion:data[0],avcProfileIndication:data[1],profileCompatibility:data[2],avcLevelIndication:data[3],lengthSizeMinusOne:data[4]&3,sps:[],pps:[]},numOfSequenceParameterSets=data[5]&31,numOfPictureParameterSets,nalSize,offset,i;offset=6;for(i=0;i<numOfSequenceParameterSets;i++){nalSize=view.getUint16(offset);offset+=2;result.sps.push(new Uint8Array(data.subarray(offset,offset+nalSize)));offset+=nalSize}numOfPictureParameterSets=data[offset];offset++;for(i=0;i<numOfPictureParameterSets;i++){nalSize=view.getUint16(offset);offset+=2;result.pps.push(new Uint8Array(data.subarray(offset,offset+nalSize)));offset+=nalSize}return result},btrt:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{bufferSizeDB:view.getUint32(0),maxBitrate:view.getUint32(4),avgBitrate:view.getUint32(8)}},esds:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),esId:data[6]<<8|data[7],streamPriority:data[8]&31,decoderConfig:{objectProfileIndication:data[11],streamType:data[12]>>>2&63,bufferSize:data[13]<<16|data[14]<<8|data[15],maxBitrate:data[16]<<24|data[17]<<16|data[18]<<8|data[19],avgBitrate:data[20]<<24|data[21]<<16|data[22]<<8|data[23],decoderConfigDescriptor:{tag:data[24],length:data[25],audioObjectType:data[26]>>>3&31,samplingFrequencyIndex:(data[26]&7)<<1|data[27]>>>7&1,channelConfiguration:data[27]>>>3&15}}}},ftyp:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={majorBrand:parseType(data.subarray(0,4)),minorVersion:view.getUint32(4),compatibleBrands:[]},i=8;while(i<data.byteLength){result.compatibleBrands.push(parseType(data.subarray(i,i+4)));i+=4}return result},dinf:function(data){return{boxes:inspectMp4(data)}},dref:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),dataReferences:inspectMp4(data.subarray(8))}},hdlr:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),language,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),handlerType:parseType(data.subarray(8,12)),name:""},i=8;for(i=24;i<data.byteLength;i++){if(data[i]===0){i++;break}result.name+=String.fromCharCode(data[i])}result.name=decodeURIComponent(global.escape(result.name));return result},mdat:function(data){return{byteLength:data.byteLength,nals:nalParse(data)}},mdhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,language,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),language:""};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=4;result.duration=view.getUint32(i)}i+=4;language=view.getUint16(i);result.language+=String.fromCharCode((language>>10)+96);result.language+=String.fromCharCode(((language&960)>>5)+96);result.language+=String.fromCharCode((language&31)+96);return result},mdia:function(data){return{boxes:inspectMp4(data)}},mfhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sequenceNumber:data[4]<<24|data[5]<<16|data[6]<<8|data[7]}},minf:function(data){return{boxes:inspectMp4(data)}},mp4a:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={dataReferenceIndex:view.getUint16(6),channelcount:view.getUint16(16),samplesize:view.getUint16(18),samplerate:view.getUint16(24)+view.getUint16(26)/65536};if(data.byteLength>28){result.streamDescriptor=inspectMp4(data.subarray(28))[0]}return result},moof:function(data){return{boxes:inspectMp4(data)}},moov:function(data){return{boxes:inspectMp4(data)}},mvex:function(data){return{boxes:inspectMp4(data)}},mvhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.timescale=view.getUint32(i);i+=4;result.duration=view.getUint32(i)}i+=4;result.rate=view.getUint16(i)+view.getUint16(i+2)/16;i+=4;result.volume=view.getUint8(i)+view.getUint8(i+1)/8;i+=2;i+=2;i+=2*4;result.matrix=new Uint32Array(data.subarray(i,i+9*4));i+=9*4;i+=6*4;result.nextTrackId=view.getUint32(i);return result},pdin:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4)),rate:view.getUint32(4),initialDelay:view.getUint32(8)}},sdtp:function(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},i;for(i=4;i<data.byteLength;i++){result.samples.push({dependsOn:(data[i]&48)>>4,isDependedOn:(data[i]&12)>>2,hasRedundancy:data[i]&3})}return result},sidx:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),references:[],referenceId:view.getUint32(4),timescale:view.getUint32(8),earliestPresentationTime:view.getUint32(12),firstOffset:view.getUint32(16)},referenceCount=view.getUint16(22),i;for(i=24;referenceCount;i+=12,referenceCount--){result.references.push({referenceType:(data[i]&128)>>>7,referencedSize:view.getUint32(i)&2147483647,subsegmentDuration:view.getUint32(i+4),startsWithSap:!!(data[i+8]&128),sapType:(data[i+8]&112)>>>4,sapDeltaTime:view.getUint32(i+8)&268435455})}return result},smhd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),balance:data[4]+data[5]/256}},stbl:function(data){return{boxes:inspectMp4(data)}},stco:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),chunkOffsets:[]},entryCount=view.getUint32(4),i;for(i=8;entryCount;i+=4,entryCount--){result.chunkOffsets.push(view.getUint32(i))}return result},stsc:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),entryCount=view.getUint32(4),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleToChunks:[]},i;for(i=8;entryCount;i+=12,entryCount--){result.sampleToChunks.push({firstChunk:view.getUint32(i),samplesPerChunk:view.getUint32(i+4),sampleDescriptionIndex:view.getUint32(i+8)})}return result},stsd:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleDescriptions:inspectMp4(data.subarray(8))}},stsz:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),sampleSize:view.getUint32(4),entries:[]},i;for(i=12;i<data.byteLength;i+=4){result.entries.push(view.getUint32(i))}return result},stts:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),timeToSamples:[]},entryCount=view.getUint32(4),i;for(i=8;entryCount;i+=8,entryCount--){result.timeToSamples.push({sampleCount:view.getUint32(i),sampleDelta:view.getUint32(i+4)})}return result},styp:function(data){return parse.ftyp(data)},tfdt:function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),baseMediaDecodeTime:data[4]<<24|data[5]<<16|data[6]<<8|data[7]}},tfhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4)},baseDataOffsetPresent=result.flags[2]&1,sampleDescriptionIndexPresent=result.flags[2]&2,defaultSampleDurationPresent=result.flags[2]&8,defaultSampleSizePresent=result.flags[2]&16,defaultSampleFlagsPresent=result.flags[2]&32,i;i=8;if(baseDataOffsetPresent){i+=4;result.baseDataOffset=view.getUint32(12);i+=4}if(sampleDescriptionIndexPresent){result.sampleDescriptionIndex=view.getUint32(i);i+=4}if(defaultSampleDurationPresent){result.defaultSampleDuration=view.getUint32(i);i+=4}if(defaultSampleSizePresent){result.defaultSampleSize=view.getUint32(i);i+=4}if(defaultSampleFlagsPresent){result.defaultSampleFlags=view.getUint32(i)}return result},tkhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength),i=4,result={version:view.getUint8(0),flags:new Uint8Array(data.subarray(1,4))};if(result.version===1){i+=4;result.creationTime=parseMp4Date(view.getUint32(i));i+=8;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.trackId=view.getUint32(i);i+=4;i+=8;result.duration=view.getUint32(i)}else{result.creationTime=parseMp4Date(view.getUint32(i));i+=4;result.modificationTime=parseMp4Date(view.getUint32(i));i+=4;result.trackId=view.getUint32(i);i+=4;i+=4;result.duration=view.getUint32(i)}i+=4;i+=2*4;result.layer=view.getUint16(i);i+=2;result.alternateGroup=view.getUint16(i);i+=2;result.volume=view.getUint8(i)+view.getUint8(i+1)/8;i+=2;i+=2;result.matrix=new Uint32Array(data.subarray(i,i+9*4));i+=9*4;result.width=view.getUint16(i)+view.getUint16(i+2)/16;i+=4;result.height=view.getUint16(i)+view.getUint16(i+2)/16;return result},traf:function(data){return{boxes:inspectMp4(data)}},trak:function(data){return{boxes:inspectMp4(data)}},trex:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),trackId:view.getUint32(4),defaultSampleDescriptionIndex:view.getUint32(8),defaultSampleDuration:view.getUint32(12),defaultSampleSize:view.getUint32(16),sampleDependsOn:data[20]&3,sampleIsDependedOn:(data[21]&192)>>6,sampleHasRedundancy:(data[21]&48)>>4,samplePaddingValue:(data[21]&14)>>1,sampleIsDifferenceSample:!!(data[21]&1),sampleDegradationPriority:view.getUint16(22)}},trun:function(data){var result={version:data[0],flags:new Uint8Array(data.subarray(1,4)),samples:[]},view=new DataView(data.buffer,data.byteOffset,data.byteLength),dataOffsetPresent=result.flags[2]&1,firstSampleFlagsPresent=result.flags[2]&4,sampleDurationPresent=result.flags[1]&1,sampleSizePresent=result.flags[1]&2,sampleFlagsPresent=result.flags[1]&4,sampleCompositionTimeOffsetPresent=result.flags[1]&8,sampleCount=view.getUint32(4),offset=8,sample;if(dataOffsetPresent){result.dataOffset=view.getUint32(offset);offset+=4}if(firstSampleFlagsPresent&&sampleCount){sample={flags:parseSampleFlags(data.subarray(offset,offset+4))};offset+=4;if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}if(sampleCompositionTimeOffsetPresent){sample.compositionTimeOffset=view.getUint32(offset);offset+=4}result.samples.push(sample);sampleCount--}while(sampleCount--){sample={};if(sampleDurationPresent){sample.duration=view.getUint32(offset);offset+=4}if(sampleSizePresent){sample.size=view.getUint32(offset);offset+=4}if(sampleFlagsPresent){sample.flags=parseSampleFlags(data.subarray(offset,offset+4));offset+=4}if(sampleCompositionTimeOffsetPresent){sample.compositionTimeOffset=view.getUint32(offset);offset+=4}result.samples.push(sample)}return result},"url ":function(data){return{version:data[0],flags:new Uint8Array(data.subarray(1,4))}},vmhd:function(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);return{version:data[0],flags:new Uint8Array(data.subarray(1,4)),graphicsmode:view.getUint16(4),opcolor:new Uint16Array([view.getUint16(6),view.getUint16(8),view.getUint16(10)])}}};inspectMp4=function(data){var i=0,result=[],view,size,type,end,box;var ab=new ArrayBuffer(data.length);var v=new Uint8Array(ab);for(var z=0;z<data.length;++z){v[z]=data[z]}view=new DataView(ab);while(i<data.byteLength){size=view.getUint32(i);type=parseType(data.subarray(i+4,i+8));end=size>1?i+size:data.byteLength;box=(parse[type]||function(data){return{data:data}})(data.subarray(i+8,end));box.size=size;box.type=type;result.push(box);i=end}return result};textifyMp4=function(inspectedMp4,depth){var indent;depth=depth||0;indent=new Array(depth*2+1).join(" ");return inspectedMp4.map(function(box,index){return indent+box.type+"\n"+Object.keys(box).filter(function(key){return key!=="type"&&key!=="boxes"}).map(function(key){var prefix=indent+"  "+key+": ",value=box[key];if(value instanceof Uint8Array||value instanceof Uint32Array){var bytes=Array.prototype.slice.call(new Uint8Array(value.buffer,value.byteOffset,value.byteLength)).map(function(byte){return" "+("00"+byte.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);if(!bytes){return prefix+"<>"}if(bytes.length===1){return prefix+"<"+bytes.join("").slice(1)+">"}return prefix+"<\n"+bytes.map(function(line){return indent+"  "+line}).join("\n")+"\n"+indent+"  >"}return prefix+JSON.stringify(value,null,2).split("\n").map(function(line,index){if(index===0){return line}return indent+"  "+line}).join("\n")}).join("\n")+(box.boxes?"\n"+textifyMp4(box.boxes,depth+1):"")}).join("\n")};module.exports={inspect:inspectMp4,textify:textifyMp4}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],54:[function(require,module,exports){"use strict";var ExpGolomb;ExpGolomb=function(workingData){var workingBytesAvailable=workingData.byteLength,workingWord=0,workingBitsAvailable=0;this.length=function(){return 8*workingBytesAvailable};this.bitsAvailable=function(){return 8*workingBytesAvailable+workingBitsAvailable};this.loadWord=function(){var position=workingData.byteLength-workingBytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,workingBytesAvailable);if(availableBytes===0){throw new Error("no bytes available")}workingBytes.set(workingData.subarray(position,position+availableBytes));workingWord=new DataView(workingBytes.buffer).getUint32(0);workingBitsAvailable=availableBytes*8;workingBytesAvailable-=availableBytes};this.skipBits=function(count){var skipBytes;if(workingBitsAvailable>count){workingWord<<=count;workingBitsAvailable-=count}else{count-=workingBitsAvailable;skipBytes=Math.floor(count/8);count-=skipBytes*8;workingBytesAvailable-=skipBytes;this.loadWord();workingWord<<=count;workingBitsAvailable-=count}};this.readBits=function(size){var bits=Math.min(workingBitsAvailable,size),valu=workingWord>>>32-bits;workingBitsAvailable-=bits;if(workingBitsAvailable>0){workingWord<<=bits}else if(workingBytesAvailable>0){this.loadWord()}bits=size-bits;if(bits>0){return valu<<bits|this.readBits(bits)}else{return valu}};this.skipLeadingZeros=function(){var leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<workingBitsAvailable;++leadingZeroCount){if(0!==(workingWord&2147483648>>>leadingZeroCount)){workingWord<<=leadingZeroCount;workingBitsAvailable-=leadingZeroCount;return leadingZeroCount}}this.loadWord();return leadingZeroCount+this.skipLeadingZeros()};this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())};this.readUnsignedExpGolomb=function(){var clz=this.skipLeadingZeros();return this.readBits(clz+1)-1};this.readExpGolomb=function(){var valu=this.readUnsignedExpGolomb();if(1&valu){return 1+valu>>>1}else{return-1*(valu>>>1)}};this.readBoolean=function(){return 1===this.readBits(1)};this.readUnsignedByte=function(){return this.readBits(8)};this.loadWord()};module.exports=ExpGolomb},{}],55:[function(require,module,exports){"use strict";var Stream=function(){this.init=function(){var listeners={};this.on=function(type,listener){if(!listeners[type]){listeners[type]=[]}listeners[type].push(listener)}
;this.off=function(type,listener){var index;if(!listeners[type]){return false}index=listeners[type].indexOf(listener);listeners[type].splice(index,1);return index>-1};this.trigger=function(type){var callbacks,i,length,args;callbacks=listeners[type];if(!callbacks){return}if(arguments.length===2){length=callbacks.length;for(i=0;i<length;++i){callbacks[i].call(this,arguments[1])}}else{args=[];i=arguments.length;for(i=1;i<arguments.length;++i){args.push(arguments[i])}length=callbacks.length;for(i=0;i<length;++i){callbacks[i].apply(this,args)}}};this.dispose=function(){listeners={}}}};Stream.prototype.pipe=function(destination){this.on("data",function(data){destination.push(data)});this.on("done",function(flushSource){destination.flush(flushSource)});return destination};Stream.prototype.push=function(data){this.trigger("data",data)};Stream.prototype.flush=function(flushSource){this.trigger("done",flushSource)};module.exports=Stream},{}],56:[function(require,module,exports){var bundleFn=arguments[3];var sources=arguments[4];var cache=arguments[5];var stringify=JSON.stringify;module.exports=function(fn){var keys=[];var wkey;var cacheKeys=Object.keys(cache);for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];if(cache[key].exports===fn){wkey=key;break}}if(!wkey){wkey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var wcache={};for(var i=0,l=cacheKeys.length;i<l;i++){var key=cacheKeys[i];wcache[key]=key}sources[wkey]=[Function(["require","module","exports"],"("+fn+")(self)"),wcache]}var skey=Math.floor(Math.pow(16,8)*Math.random()).toString(16);var scache={};scache[wkey]=wkey;sources[skey]=[Function(["require"],"require("+stringify(wkey)+")(self)"),scache];var src="("+bundleFn+")({"+Object.keys(sources).map(function(key){return stringify(key)+":["+sources[key][0]+","+stringify(sources[key][1])+"]"}).join(",")+"},{},["+stringify(skey)+"])";var URL=window.URL||window.webkitURL||window.mozURL||window.msURL;return new Worker(URL.createObjectURL(new Blob([src],{type:"text/javascript"})))}},{}],57:[function(require,module,exports){(function(global){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _get=function get(_x,_x2,_x3){var _again=true;_function:while(_again){var object=_x,property=_x2,receiver=_x3;_again=false;if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{_x=parent;_x2=property;_x3=receiver;_again=true;desc=parent=undefined;continue _function}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}}};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var _globalDocument=require("global/document");var _globalDocument2=_interopRequireDefault(_globalDocument);var _playlistLoader=require("./playlist-loader");var _playlistLoader2=_interopRequireDefault(_playlistLoader);var _playlist=require("./playlist");var _playlist2=_interopRequireDefault(_playlist);var _xhr=require("./xhr");var _xhr2=_interopRequireDefault(_xhr);var _decrypter=require("./decrypter");var _binUtils=require("./bin-utils");var _binUtils2=_interopRequireDefault(_binUtils);var _videojsContribMediaSources=require("videojs-contrib-media-sources");var _m3u8=require("./m3u8");var _m3u82=_interopRequireDefault(_m3u8);var _videoJs=typeof window!=="undefined"?window["videojs"]:typeof global!=="undefined"?global["videojs"]:null;var _videoJs2=_interopRequireDefault(_videoJs);var _masterPlaylistController=require("./master-playlist-controller");var _masterPlaylistController2=_interopRequireDefault(_masterPlaylistController);var objectChanged=function objectChanged(a,b){if(typeof a!==typeof b){return true}if(Object.keys(a).length!==Object.keys(b).length){return true}for(var prop in a){if(!b[prop]||a[prop]!==b[prop]){return true}}return false};var Hls={PlaylistLoader:_playlistLoader2["default"],Playlist:_playlist2["default"],Decrypter:_decrypter.Decrypter,AsyncStream:_decrypter.AsyncStream,decrypt:_decrypter.decrypt,utils:_binUtils2["default"],xhr:(0,_xhr2["default"])()};Hls.GOAL_BUFFER_LENGTH=30;var BANDWIDTH_VARIANCE=1.2;var safeGetComputedStyle=function safeGetComputedStyle(el,property){var result=undefined;if(!el){return""}result=getComputedStyle(el);if(!result){return""}return result[property]};Hls.STANDARD_PLAYLIST_SELECTOR=function(){var effectiveBitrate=undefined;var sortedPlaylists=this.playlists.master.playlists.slice();var bandwidthPlaylists=[];var now=+new Date;var i=undefined;var variant=undefined;var bandwidthBestVariant=undefined;var resolutionPlusOne=undefined;var resolutionPlusOneAttribute=undefined;var resolutionBestVariant=undefined;var width=undefined;var height=undefined;sortedPlaylists.sort(Hls.comparePlaylistBandwidth);sortedPlaylists=sortedPlaylists.filter(function(localVariant){if(typeof localVariant.excludeUntil!=="undefined"){return now>=localVariant.excludeUntil}return true});i=sortedPlaylists.length;while(i--){variant=sortedPlaylists[i];if(!variant.attributes||!variant.attributes.BANDWIDTH){continue}effectiveBitrate=variant.attributes.BANDWIDTH*BANDWIDTH_VARIANCE;if(effectiveBitrate<this.bandwidth){bandwidthPlaylists.push(variant);if(!bandwidthBestVariant){bandwidthBestVariant=variant}}}i=bandwidthPlaylists.length;bandwidthPlaylists.sort(Hls.comparePlaylistResolution);variant=null;width=parseInt(safeGetComputedStyle(this.tech_.el(),"width"),10);height=parseInt(safeGetComputedStyle(this.tech_.el(),"height"),10);while(i--){variant=bandwidthPlaylists[i];if(!variant.attributes||!variant.attributes.RESOLUTION||!variant.attributes.RESOLUTION.width||!variant.attributes.RESOLUTION.height){continue}var variantResolution=variant.attributes.RESOLUTION;if(variantResolution.width===width&&variantResolution.height===height){resolutionPlusOne=null;resolutionBestVariant=variant;break}else if(variantResolution.width<width&&variantResolution.height<height){break}else if(!resolutionPlusOne||variantResolution.width<resolutionPlusOneAttribute.width&&variantResolution.height<resolutionPlusOneAttribute.height){resolutionPlusOne=variant;resolutionPlusOneAttribute=resolutionPlusOne.attributes.RESOLUTION}}return resolutionPlusOne||resolutionBestVariant||bandwidthBestVariant||sortedPlaylists[0]};Hls.canPlaySource=function(){return _videoJs2["default"].log.warn("HLS is no longer a tech. Please remove it from "+"your player's techOrder.")};Hls.supportsNativeHls=function(){var video=_globalDocument2["default"].createElement("video");if(!_videoJs2["default"].getComponent("Html5").isSupported()){return false}var canPlay=["application/vnd.apple.mpegurl","audio/mpegurl","audio/x-mpegurl","application/x-mpegurl","video/x-mpegurl","video/mpegurl","application/mpegurl"];return canPlay.some(function(canItPlay){return/maybe|probably/i.test(video.canPlayType(canItPlay))})}();Hls.isSupported=function(){return _videoJs2["default"].log.warn("HLS is no longer a tech. Please remove it from "+"your player's techOrder.")};var Component=_videoJs2["default"].getComponent("Component");var HlsHandler=function(_Component){_inherits(HlsHandler,_Component);function HlsHandler(source,tech,options){var _this=this;_classCallCheck(this,HlsHandler);_get(Object.getPrototypeOf(HlsHandler.prototype),"constructor",this).call(this,tech);if(tech.options_&&tech.options_.playerId){var _player=(0,_videoJs2["default"])(tech.options_.playerId);if(!_player.hasOwnProperty("hls")){Object.defineProperty(_player,"hls",{get:function get(){_videoJs2["default"].log.warn("player.hls is deprecated. Use player.tech.hls instead.");return _this}})}}this.options_=_videoJs2["default"].mergeOptions(_videoJs2["default"].options.hls||{},options.hls);this.tech_=tech;this.source_=source;this.bandwidth=this.options_.bandwidth||4194304;this.bytesReceived=0;this.on(_globalDocument2["default"],["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"],function(event){var fullscreenElement=_globalDocument2["default"].fullscreenElement||_globalDocument2["default"].webkitFullscreenElement||_globalDocument2["default"].mozFullScreenElement||_globalDocument2["default"].msFullscreenElement;if(fullscreenElement&&fullscreenElement.contains(_this.tech_.el())){_this.masterPlaylistController_.fastQualityChange_()}});this.on(this.tech_,"seeking",function(){this.setCurrentTime(this.tech_.currentTime())});this.on(this.tech_,"error",function(){if(this.masterPlaylistController_){this.masterPlaylistController_.pauseLoading()}});this.audioTrackChange_=function(){_this.masterPlaylistController_.useAudio()};this.on(this.tech_,"play",this.play)}_createClass(HlsHandler,[{key:"src",value:function src(_src){var _this2=this;if(!_src){return}["withCredentials","bandwidth"].forEach(function(option){if(typeof _this2.source_[option]!=="undefined"){_this2.options_[option]=_this2.source_[option]}});this.options_.url=this.source_.src;this.options_.tech=this.tech_;this.options_.externHls=Hls;this.options_.bandwidth=this.bandwidth;this.masterPlaylistController_=new _masterPlaylistController2["default"](this.options_);this.masterPlaylistController_.selectPlaylist=Hls.STANDARD_PLAYLIST_SELECTOR.bind(this);this.playlists=this.masterPlaylistController_.masterPlaylistLoader_;this.mediaSource=this.masterPlaylistController_.mediaSource;Object.defineProperties(this,{selectPlaylist:{get:function get(){return this.masterPlaylistController_.selectPlaylist},set:function set(selectPlaylist){this.masterPlaylistController_.selectPlaylist=selectPlaylist.bind(this)}},bandwidth:{get:function get(){return this.masterPlaylistController_.mainSegmentLoader_.bandwidth},set:function set(bandwidth){this.masterPlaylistController_.mainSegmentLoader_.bandwidth=bandwidth}}});this.tech_.one("canplay",this.masterPlaylistController_.setupFirstPlay.bind(this.masterPlaylistController_));this.masterPlaylistController_.on("sourceopen",function(){_this2.tech_.audioTracks().addEventListener("change",_this2.audioTrackChange_)});this.masterPlaylistController_.on("audioinfo",function(e){if(!_videoJs2["default"].browser.IS_FIREFOX||!_this2.audioInfo_||!objectChanged(_this2.audioInfo_,e.info)){_this2.audioInfo_=e.info;return}var error="had different audio properties (channels, sample rate, etc.) "+"or changed in some other way.  This behavior is currently "+"unsupported in Firefox due to an issue: \n\n"+"https://bugzilla.mozilla.org/show_bug.cgi?id=1247138\n\n";var enabledTrack=undefined;var defaultTrack=undefined;_this2.masterPlaylistController_.audioTracks_.forEach(function(t){if(!defaultTrack&&t["default"]){defaultTrack=t}if(!enabledTrack&&t.enabled){enabledTrack=t}});if(!enabledTrack.getLoader(_this2.activeAudioGroup_())){error="The rendition that we tried to switch to "+error+"Unfortunately that means we will have to blacklist "+"the current playlist and switch to another. Sorry!";_this2.masterPlaylistController_.blacklistCurrentPlaylist()}else{error="The audio track '"+enabledTrack.label+"' that we tried to "+("switch to "+error+" Unfortunately this means we will have to ")+("return you to the main track '"+defaultTrack.label+"'. Sorry!");defaultTrack.enabled=true;_this2.tech_.audioTracks().removeTrack(enabledTrack)}_videoJs2["default"].log.warn(error);_this2.masterPlaylistController_.useAudio()});this.masterPlaylistController_.on("selectedinitialmedia",function(){_this2.tech_.clearTracks("audio");_this2.masterPlaylistController_.audioTracks_.forEach(function(track){_this2.tech_.audioTracks().addTrack(track)})});this.on(this.masterPlaylistController_,"progress",function(){this.bandwidth=this.masterPlaylistController_.mainSegmentLoader_.bandwidth;this.tech_.trigger("progress")});if(!this.tech_.el()){return}this.tech_.src(_videoJs2["default"].URL.createObjectURL(this.masterPlaylistController_.mediaSource))}},{key:"activeAudioGroup_",value:function activeAudioGroup_(){return this.masterPlaylistController_.activeAudioGroup()}},{key:"play",value:function play(){this.masterPlaylistController_.play()}},{key:"setCurrentTime",value:function setCurrentTime(currentTime){this.masterPlaylistController_.setCurrentTime(currentTime)}},{key:"duration",value:function duration(){return this.masterPlaylistController_.duration()}},{key:"seekable",value:function seekable(){return this.masterPlaylistController_.seekable()}},{key:"dispose",value:function dispose(){if(this.masterPlaylistController_){this.masterPlaylistController_.dispose()}this.tech_.audioTracks().removeEventListener("change",this.audioTrackChange_);_get(Object.getPrototypeOf(HlsHandler.prototype),"dispose",this).call(this)}}]);return HlsHandler}(Component);var HlsSourceHandler=function HlsSourceHandler(mode){return{canHandleSource:function canHandleSource(srcObj){if(_videoJs2["default"].options.hls&&_videoJs2["default"].options.hls.mode&&_videoJs2["default"].options.hls.mode!==mode){return false}return HlsSourceHandler.canPlayType(srcObj.type)},handleSource:function handleSource(source,tech,options){if(mode==="flash"){tech.setTimeout(function(){tech.trigger("loadstart")},1)}var settings=_videoJs2["default"].mergeOptions(options,{hls:{mode:mode}});tech.hls=new HlsHandler(source,tech,settings);tech.hls.xhr=(0,_xhr2["default"])();if(_videoJs2["default"].Hls.xhr.beforeRequest){tech.hls.xhr.beforeRequest=_videoJs2["default"].Hls.xhr.beforeRequest}tech.hls.src(source.src);return tech.hls},canPlayType:function canPlayType(type){if(HlsSourceHandler.canPlayType(type)){return"maybe"}return""}}};Hls.comparePlaylistBandwidth=function(left,right){var leftBandwidth=undefined;var rightBandwidth=undefined;if(left.attributes&&left.attributes.BANDWIDTH){leftBandwidth=left.attributes.BANDWIDTH}leftBandwidth=leftBandwidth||window.Number.MAX_VALUE;if(right.attributes&&right.attributes.BANDWIDTH){rightBandwidth=right.attributes.BANDWIDTH}rightBandwidth=rightBandwidth||window.Number.MAX_VALUE;return leftBandwidth-rightBandwidth};Hls.comparePlaylistResolution=function(left,right){var leftWidth=undefined;var rightWidth=undefined;if(left.attributes&&left.attributes.RESOLUTION&&left.attributes.RESOLUTION.width){leftWidth=left.attributes.RESOLUTION.width}leftWidth=leftWidth||window.Number.MAX_VALUE;if(right.attributes&&right.attributes.RESOLUTION&&right.attributes.RESOLUTION.width){rightWidth=right.attributes.RESOLUTION.width}rightWidth=rightWidth||window.Number.MAX_VALUE;if(leftWidth===rightWidth&&left.attributes.BANDWIDTH&&right.attributes.BANDWIDTH){return left.attributes.BANDWIDTH-right.attributes.BANDWIDTH}return leftWidth-rightWidth};HlsSourceHandler.canPlayType=function(type){var mpegurlRE=/^(audio|video|application)\/(x-|vnd\.apple\.)?mpegurl/i;if(Hls.supportsNativeHls){return false}return mpegurlRE.test(type)};if(typeof _videoJs2["default"].MediaSource==="undefined"||typeof _videoJs2["default"].URL==="undefined"){_videoJs2["default"].MediaSource=_videojsContribMediaSources.MediaSource;_videoJs2["default"].URL=_videojsContribMediaSources.URL}if(_videojsContribMediaSources.MediaSource.supportsNativeMediaSources()){_videoJs2["default"].getComponent("Html5").registerSourceHandler(HlsSourceHandler("html5"))}if(window.Uint8Array){_videoJs2["default"].getComponent("Flash").registerSourceHandler(HlsSourceHandler("flash"))}_videoJs2["default"].HlsHandler=HlsHandler;_videoJs2["default"].HlsSourceHandler=HlsSourceHandler;_videoJs2["default"].Hls=Hls;_videoJs2["default"].m3u8=_m3u82["default"];_videoJs2["default"].registerComponent("Hls",Hls);_videoJs2["default"].options.hls=_videoJs2["default"].options.hls||{};module.exports={Hls:Hls,HlsHandler:HlsHandler,HlsSourceHandler:HlsSourceHandler}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./bin-utils":1,"./decrypter":5,"./m3u8":7,"./master-playlist-controller":11,"./playlist":13,"./playlist-loader":12,"./xhr":19,"global/document":21,"videojs-contrib-media-sources":34}]},{},[57])(57)});